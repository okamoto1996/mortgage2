<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†">
<title>ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0c0a;
    --surface: #1a1816;
    --surface2: #232120;
    --surface3: #2c2a28;
    --border: #383532;
    --border2: #454240;
    --accent: #d4b478;
    --accent2: #f0d080;
    --text: #f5f2ea;
    --text2: #d0cbbf;
    --muted: #9a9488;
    --danger: #e07868;
    --safe: #6ec496;
    --interest: #e07868;
    --principal: #d4b478;
    --info: #6a9ed8;
    --radius: 10px;
    --radius-sm: 6px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 105%; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Serif JP', serif;
    min-height: 100vh;
    padding: 20px 8px 48px;
    max-width: 680px;
    margin: 0 auto;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    position: relative; margin-bottom: 28px;
    padding: 36px 8px 30px;
    border-bottom: 1px solid var(--border);
    overflow: hidden;
  }
  /* Blueprint grid background */
  .header::before {
    content: '';
    position: absolute; inset: 0;
    background-image:
      linear-gradient(rgba(212,180,120,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(212,180,120,0.04) 1px, transparent 1px);
    background-size: 32px 32px;
    mask-image: radial-gradient(ellipse 80% 100% at 50% 50%, black 40%, transparent 100%);
    -webkit-mask-image: radial-gradient(ellipse 80% 100% at 50% 50%, black 40%, transparent 100%);
  }
  /* Corner brackets */
  .header::after {
    content: '';
    position: absolute; inset: 12px;
    border: 1px solid rgba(212,180,120,0.15);
    border-radius: 4px;
    pointer-events: none;
  }
  .header-inner {
    position: relative; text-align: center;
  }
  .header-eyebrow {
    display: inline-flex; align-items: center; gap: 8px;
    font-size: 0.6rem; color: var(--accent); letter-spacing: 0.22em;
    text-transform: uppercase; margin-bottom: 14px;
    padding: 4px 14px; border: 1px solid rgba(212,180,120,0.25);
    border-radius: 2px; background: rgba(212,180,120,0.05);
  }
  .header-eyebrow::before, .header-eyebrow::after {
    content: 'â—†'; font-size: 0.4rem; opacity: 0.6;
  }
  .header h1 {
    font-size: 1.9rem; font-weight: 300; letter-spacing: 0.2em;
    line-height: 1;
    background: linear-gradient(135deg, #e8c98a 0%, #f5f0d8 45%, #c8a060 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
  }
  .header-rule {
    display: flex; align-items: center; gap: 10px;
    margin: 12px auto; max-width: 280px;
  }
  .header-rule::before, .header-rule::after {
    content: ''; flex: 1; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(212,180,120,0.4), transparent);
  }
  .header-rule-dot {
    width: 4px; height: 4px; border-radius: 50%;
    background: var(--accent); opacity: 0.7;
  }
  .header p {
    color: var(--muted); font-size: 0.7rem; letter-spacing: 0.12em;
    text-transform: uppercase;
  }
  /* Corner decorations */
  .header-corner {
    position: absolute; width: 14px; height: 14px;
  }
  .header-corner.tl { top: 12px; left: 12px; border-top: 1.5px solid rgba(212,180,120,0.5); border-left: 1.5px solid rgba(212,180,120,0.5); }
  .header-corner.tr { top: 12px; right: 12px; border-top: 1.5px solid rgba(212,180,120,0.5); border-right: 1.5px solid rgba(212,180,120,0.5); }
  .header-corner.bl { bottom: 0px; left: 12px; border-bottom: 1.5px solid rgba(212,180,120,0.5); border-left: 1.5px solid rgba(212,180,120,0.5); }
  .header-corner.br { bottom: 0px; right: 12px; border-bottom: 1.5px solid rgba(212,180,120,0.5); border-right: 1.5px solid rgba(212,180,120,0.5); }

  /* â”€â”€ Cards â”€â”€ */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 12px;  margin-bottom: 14px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.25);
  }
  .card-title {
    font-size: 0.68rem; color: var(--accent); letter-spacing: 0.18em; text-transform: uppercase;
    margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center; gap: 8px;
  }

  /* â”€â”€ Forms â”€â”€ */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .form-group { display: flex; flex-direction: column; gap: 5px; min-width: 0; }
  .form-group label { font-size: 0.68rem; color: var(--muted); letter-spacing: 0.04em; }
  .form-group input, .form-group select {
    background: var(--surface2); border: 1px solid var(--border2); border-radius: var(--radius-sm);
    color: var(--text); padding: 9px 11px; font-family: 'DM Mono', monospace;
    font-size: 0.88rem; outline: none; transition: border-color 0.2s, background 0.2s;
    width: 100%; box-sizing: border-box; -webkit-appearance: none;
  }
  .form-group input:focus, .form-group select:focus {
    border-color: var(--accent); background: var(--surface3);
  }
  .form-group select { cursor: pointer; }

  .checkbox-group {
    display: flex; align-items: flex-start; gap: 10px; margin-top: 6px;
    padding: 10px 12px; background: rgba(200,169,110,0.04);
    border-radius: var(--radius-sm); border: 1px solid var(--border);
  }
  .checkbox-group input[type="checkbox"] { width: auto; margin: 2px 0 0; flex-shrink: 0; cursor: pointer; }
  .checkbox-group label { font-size: 0.78rem; color: var(--text2); cursor: pointer; line-height: 1.4; }
  .rule-desc { font-size: 0.67rem; color: var(--muted); margin: 4px 0 0 22px; line-height: 1.5; }

  /* â”€â”€ Buttons â”€â”€ */
  .btn {
    background: var(--accent); color: #0d0c0a; border: none; border-radius: var(--radius-sm);
    padding: 11px 24px; font-family: 'Noto Serif JP', serif; font-size: 0.88rem;
    font-weight: 600; cursor: pointer; transition: background 0.18s, transform 0.1s;
    width: 100%; margin-top: 12px; letter-spacing: 0.05em;
  }
  .btn:hover { background: var(--accent2); }
  .btn:active { transform: scale(0.98); }
  .btn-outline {
    background: transparent; border: 1px solid var(--border2); color: var(--text2);
    border-radius: var(--radius-sm); padding: 7px 14px; font-family: 'Noto Serif JP', serif;
    font-size: 0.75rem; cursor: pointer; transition: all 0.18s; width: 100%;
    text-align: left;
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: rgba(200,169,110,0.05); }

  /* â”€â”€ Banner â”€â”€ */
  .total-cost-banner {
    background: linear-gradient(135deg, rgba(200,169,110,0.12), rgba(200,169,110,0.06));
    border: 1px solid rgba(200,169,110,0.35);
    border-radius: var(--radius); padding: 18px 16px; margin-bottom: 14px; text-align: center;
  }
  .total-cost-label { font-size: 0.7rem; color: var(--accent); margin-bottom: 6px; letter-spacing: 0.1em; }
  .total-cost-value { font-family: 'DM Mono', monospace; font-size: 2rem; color: var(--accent2); font-weight: 500; line-height: 1; }
  .total-cost-detail { font-size: 0.72rem; color: var(--muted); margin-top: 8px; }
  .total-cost-detail span { color: var(--text2); font-weight: 500; }

  /* â”€â”€ Stats â”€â”€ */
  .stats-section-label {
    font-size: 0.65rem; color: var(--muted); margin: 14px 0 8px 2px;
    padding-left: 8px; border-left: 2px solid var(--accent); letter-spacing: 0.06em;
  }
  .stats-grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 10px; }
  @media (max-width: 580px) { .stats-grid-4 { grid-template-columns: repeat(2,1fr); } }
  .stats-grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 10px; }

  .stat-box {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 12px 6px 10px; text-align: center; display: flex; flex-direction: column;
  }
  .stat-label { font-size: 0.65rem; color: #c0bab2; font-weight: 700; margin-bottom: 8px; line-height: 1.4; min-height: 2.7em; display:flex; align-items:center; justify-content:center; letter-spacing: 0.02em; }
  .stat-value { font-family: 'DM Mono', monospace; font-size: 0.95rem; color: var(--text); font-weight: 500; min-height: 1.3em; display:flex; align-items:center; justify-content:center; }
  .stat-value.accent { color: var(--accent2); }
  .stat-value.danger { color: var(--danger); }
  .stat-sub { font-size: 0.62rem; color: #a8a39a; margin-top: auto; padding-top: 6px; line-height: 1.35; min-height: 2.4em; }

  /* â”€â”€ Progress â”€â”€ */
  .progress-bar { background: var(--surface3); border-radius: 3px; height: 5px; overflow: hidden; margin: 12px 0 6px; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 3px; transition: width 0.6s ease; }
  .progress-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs { display: flex; gap: 3px; margin-bottom: 14px; background: var(--surface2); border-radius: var(--radius-sm); padding: 3px; }
  .tab {
    flex: 1; padding: 7px 4px; background: transparent; border: none; border-radius: 4px;
    color: var(--muted); cursor: pointer; font-size: 0.68rem; text-align: center;
    transition: all 0.18s; font-family: 'Noto Serif JP', serif;
  }
  .tab.active { background: var(--surface); color: var(--accent2); font-weight: 600; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
  .tab:hover:not(.active) { color: var(--text2); }

  .tools-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 14px; }
  .tools-tab { flex: 1; padding: 9px 4px; text-align: center; font-size: 0.72rem; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.18s; }
  .tools-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

  /* â”€â”€ Table â”€â”€ */
  .table-wrap { overflow-y: auto; max-height: 420px; border-radius: var(--radius-sm); border: 1px solid var(--border); }
  table { width: 100%; table-layout: fixed; border-collapse: collapse; }
  th {
    background: var(--surface3); padding: 9px 6px; text-align: center; color: #9a9590;
    font-weight: 600; font-size: 0.58rem; position: sticky; top: 0; z-index: 1;
    white-space: nowrap; overflow: hidden; letter-spacing: 0.03em;
  }
  th:first-child { text-align: center; padding-left: 6px; }
  th:last-child { padding-right: 10px; }
  td {
    padding: 7px 6px; text-align: right; border-bottom: 1px solid var(--border);
    font-family: 'DM Mono', monospace; font-size: 0.64rem; color: #e8e4da;
    overflow: hidden;
  }
  td:first-child {
    text-align: left; color: #b8b4ac; font-family: 'Noto Serif JP', serif;
    font-size: 0.6rem; padding-left: 10px; overflow: hidden;
    white-space: normal; word-break: keep-all;
  }
  td:last-child { padding-right: 10px; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.025); }
  tr.highlight td { background: rgba(200,169,110,0.09); }
  tr.highlight td:first-child { color: var(--accent2); font-weight: 600; }
  tr.highlight td:not(:first-child) { color: #f5f0e4; }
  th { border-right: 1px solid var(--border); }
  th:last-child { border-right: none; }
  td { border-right: 1px solid var(--border); }
  td:last-child { border-right: none; }
  tr.highlight td { border-right-color: rgba(212,180,120,0.25); }
  tr.rate-change td:first-child { color: #80e8b4; }
  tr.rate-change td { background: rgba(110,196,150,0.08); }
  tr.payment-change td { background: rgba(212,180,120,0.07); }

  /* â”€â”€ Rate changes â”€â”€ */
  .rate-section { margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--border); }
  .rate-section-header {
    display: flex; justify-content: space-between; align-items: center;
    gap: 10px; margin-bottom: 10px;
  }
  .rate-section-title {
    font-size: 0.78rem; color: var(--accent); font-weight: 600;
    white-space: nowrap; flex-shrink: 0;
  }
  .rate-section-add-btn {
    background: var(--surface3); border: 1px solid var(--border2); color: var(--accent);
    border-radius: var(--radius-sm); padding: 6px 14px; font-family: 'Noto Serif JP', serif;
    font-size: 0.75rem; cursor: pointer; transition: all 0.18s; white-space: nowrap;
    flex-shrink: 0;
  }
  .rate-section-add-btn:hover { background: rgba(200,169,110,0.12); border-color: var(--accent); }
  .rate-change-item {
    display: flex; align-items: center; gap: 8px; padding: 10px 12px; margin-bottom: 6px;
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm);
  }
  .rate-item-main { flex: 1; display: flex; flex-direction: column; gap: 3px; }
  .rate-item-date { font-family: 'DM Mono', monospace; font-size: 0.82rem; color: var(--text); }
  .rate-item-val { font-size: 0.68rem; color: var(--safe); }
  .rate-add-form {
    display: none; background: var(--surface2); border: 1px solid var(--accent);
    border-radius: var(--radius-sm); padding: 14px; margin: 8px 0;
  }
  .rate-actions { display: flex; gap: 6px; }


  /* â”€â”€ Misc small components â”€â”€ */
  .btn-sm {
    background: var(--surface3); border: 1px solid var(--border2); border-radius: 4px;
    color: var(--muted); padding: 5px 10px; font-size: 0.7rem; cursor: pointer;
    transition: all 0.18s; font-family: 'Noto Serif JP', serif;
  }
  .btn-sm.edit:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm.danger:hover { border-color: var(--danger); color: var(--danger); }

  .chart-wrapper { position: relative; height: 240px; width: 100%; }
  canvas { display: block; width: 100%; }
  .empty-state { text-align: center; color: var(--muted); padding: 20px; font-size: 0.82rem; }
  .save-notice { font-size: 0.68rem; color: var(--safe); margin-top: 8px; text-align: center; display: none; }
  #results { display: none; }
  #results.visible { display: block; }

  .badge-warn {
    display: inline-block; background: rgba(192,104,88,0.12); color: var(--danger);
    padding: 2px 5px; border-radius: 3px; font-size: 0.6rem; border: 1px solid rgba(192,104,88,0.4);
  }
  .badge-rule {
    display: inline-block; background: rgba(94,160,130,0.12); color: var(--safe);
    padding: 2px 5px; border-radius: 3px; font-size: 0.6rem; border: 1px solid rgba(94,160,130,0.4);
  }
  .deferred-interest {
    color: var(--danger); font-size: 0.73rem; margin-top: 8px; padding: 8px 12px;
    border: 1px solid rgba(192,104,88,0.4); border-radius: var(--radius-sm);
    background: rgba(192,104,88,0.06); display: none;
  }

  .tool-content { display: none; animation: fadeIn 0.25s ease; }
  .tool-content.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

  .tool-summary {
    background: rgba(94,160,130,0.08); border: 1px solid rgba(94,160,130,0.3);
    border-radius: var(--radius-sm); padding: 14px; margin-top: 14px; text-align: center;
  }
  .tool-summary-label { font-size: 0.68rem; color: var(--safe); margin-bottom: 5px; letter-spacing: 0.04em; }
  .tool-summary-val { font-size: 1.18rem; font-family: 'DM Mono', monospace; color: var(--text); }

  .refi-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 7px 0; font-size: 0.78rem; }
  .refi-row span:last-child { font-family: 'DM Mono', monospace; }
  .refi-row.has-sub { border-bottom: none; padding-bottom: 3px; }
  .refi-row.sub { border-bottom: none; padding: 2px 0 2px 12px; font-size: 0.7rem; color: var(--muted); }
  .refi-row.sub-last { border-bottom: 1px solid var(--border); padding-bottom: 7px; }
  .refi-diff { font-weight: bold; }
  .refi-diff.plus { color: var(--safe); }
  .refi-diff.minus { color: var(--danger); }

  .tax-badge {
    display: inline-block; padding: 3px 9px; border-radius: var(--radius-sm);
    font-size: 0.68rem; font-weight: 600; letter-spacing: 0.02em;
  }
  .tax-short { background: rgba(192,104,88,0.12); color: var(--danger); border: 1px solid rgba(192,104,88,0.4); }
  .tax-long  { background: rgba(94,160,130,0.12); color: var(--safe);   border: 1px solid rgba(94,160,130,0.4); }
  .tax-reduced { background: rgba(82,130,184,0.12); color: var(--info);  border: 1px solid rgba(82,130,184,0.4); }

  .calc-breakdown { margin-top: 18px; position: relative; }
  .calc-breakdown::before {
    content:''; position:absolute; left:10px; top:30px; bottom:80px; width:2px;
    background: linear-gradient(180deg, var(--accent) 0%, var(--info) 35%, var(--danger) 65%, var(--safe) 100%);
    opacity: 0.30; border-radius:1px;
  }

  .step-box {
    position:relative; margin-left:36px; margin-bottom:0; padding:14px 16px 16px;
    background: var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm);
  }
  .step-box + .step-box { margin-top:6px; }
  .step-connector {
    display:flex; align-items:center; justify-content:center;
    height:18px; width:22px; color:var(--border2); font-size:0.55rem;
  }

  .step-num {
    position:absolute; left:-36px; top:14px;
    width:22px; height:22px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:0.6rem; font-weight:700; flex-shrink:0;
    border:2px solid; z-index:1;
  }
  .step-num.s1 { background:var(--surface); border-color:var(--accent); color:var(--accent); }
  .step-num.s2 { background:var(--surface); border-color:var(--info); color:var(--info); }
  .step-num.s3 { background:var(--surface); border-color:var(--danger); color:var(--danger); }
  .step-num.s4 { background:var(--safe); border-color:var(--safe); color:#fff; }

  .step-title {
    font-size:0.68rem; font-weight:600; margin-bottom:10px;
    display:flex; align-items:center; gap:6px; letter-spacing:0.03em;
  }
  .step-title.c1 { color:var(--accent); }
  .step-title.c2 { color:var(--info); }
  .step-title.c3 { color:var(--danger); }
  .step-title.c4 { color:var(--safe); }

  .step-row {
    display:flex; justify-content:space-between; align-items:baseline;
    padding:4px 0; font-size:0.72rem; color:var(--text2);
  }
  .step-row.sub { padding-left:10px; font-size:0.66rem; color:var(--muted); }
  .step-row.sub .step-sign { display:inline-block; width:14px; text-align:center; color:var(--muted); font-weight:600; }
  .step-row span:last-child { font-family:'DM Mono',monospace; text-align:right; min-width:80px; white-space:nowrap; }
  .step-row.result {
    border-top:1px solid var(--border2); margin-top:8px; padding-top:8px;
    font-weight:700; font-size:0.78rem;
  }
  .step-row.result.positive { color:var(--safe); }
  .step-row.result.negative { color:var(--danger); }
  .step-row.result.gold { color:var(--accent2); }

  .step-detail {
    margin:4px 0 2px 10px; padding:8px 10px;
    background:rgba(212,180,120,0.04); border-left:2px solid rgba(212,180,120,0.2);
    border-radius:0 4px 4px 0; font-size:0.58rem; color:var(--muted); line-height:1.6;
  }
  .step-badge {
    display:inline-flex; align-items:center; gap:4px; padding:3px 10px;
    border-radius:20px; font-size:0.65rem; font-weight:600;
  }
  .step-badge.safe { background:rgba(110,196,150,0.12); color:var(--safe); border:1px solid rgba(110,196,150,0.25); }
  .step-badge.danger { background:rgba(224,120,104,0.12); color:var(--danger); border:1px solid rgba(224,120,104,0.25); }
  .step-badge.info { background:rgba(106,158,216,0.12); color:var(--info); border:1px solid rgba(106,158,216,0.25); }

  .step-final {
    position:relative; margin-left:36px; margin-top:6px; padding:16px 18px;
    background: linear-gradient(135deg, rgba(110,196,150,0.08), rgba(110,196,150,0.03));
    border:1px solid rgba(110,196,150,0.35); border-radius:var(--radius);
  }
  .step-final .step-row.result { border-top:none; margin-top:4px; padding-top:0; font-size:1.05rem; }
  .step-final-items { display:grid; grid-template-columns:1fr 1fr; gap:2px 12px; margin-bottom:4px; }
  .step-final-item { display:flex; justify-content:space-between; font-size:0.64rem; color:var(--muted); padding:3px 0; }
  .step-final-item span:last-child { font-family:'DM Mono',monospace; color:var(--text2); }

  /* â”€â”€ Depreciation comparison card â”€â”€ */
  .dep-card {
    margin:14px 0 4px; border-radius:var(--radius-sm); overflow:hidden;
    border:1px solid var(--border2);
  }
  .dep-card-header {
    padding:9px 14px; font-size:0.66rem; font-weight:600; color:var(--accent);
    background:var(--surface3); display:flex; align-items:center; gap:6px;
    border-bottom:1px solid var(--border);
  }
  .dep-cols { display:grid; grid-template-columns:1fr 1fr; }
  .dep-col { padding:10px 12px; }
  .dep-col.before { background:var(--surface2); }
  .dep-col.after { background:rgba(224,120,104,0.04); }
  .dep-col-title {
    font-size:0.58rem; font-weight:600; text-align:center;
    padding-bottom:8px; margin-bottom:8px; border-bottom:1px solid var(--border);
    letter-spacing:0.03em;
  }
  .dep-col.before .dep-col-title { color:var(--muted); }
  .dep-col.after .dep-col-title { color:var(--danger); }
  .dep-col-row {
    display:flex; justify-content:space-between; align-items:baseline;
    padding:3px 0; font-size:0.6rem; color:var(--muted);
  }
  .dep-col-row span:last-child {
    font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--text2);
    text-align:right; min-width:55px;
  }
  .dep-col-row.changed span:last-child { color:var(--danger); font-weight:600; }
  .dep-col-row.result-row {
    margin-top:6px; padding-top:6px; border-top:1px dashed var(--border2);
    font-weight:600; font-size:0.64rem;
  }
  .dep-col-row.result-row span:last-child { font-size:0.7rem; }
  .dep-col.before .dep-col-row.result-row span:last-child { color:var(--text); }
  .dep-col.after .dep-col-row.result-row span:last-child { color:var(--danger); }
  .dep-col-divider {
    position:absolute; left:50%; top:0; bottom:0; width:1px;
    background:var(--border2);
  }
  .dep-bottom {
    padding:10px 14px; background:var(--surface3);
    border-top:1px solid var(--border); display:flex; flex-direction:column; gap:4px;
  }
  .dep-bottom-row {
    display:flex; justify-content:space-between; align-items:center;
    font-size:0.64rem;
  }
  .dep-bottom-row .dep-label { color:var(--text2); }
  .dep-bottom-row .dep-val {
    font-family:'DM Mono',monospace; font-weight:700; font-size:0.78rem;
  }
  .dep-bottom-note {
    font-size:0.56rem; color:var(--muted); line-height:1.5; margin-top:2px;
  }

  /* â”€â”€ Footer â”€â”€ */
  .footer-links { margin-top: 32px; padding: 18px 0 40px; border-top: 1px solid var(--border); text-align: center; }
  .external-link {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 0.72rem; color: var(--muted); text-decoration: none; transition: color 0.2s;
  }
  .external-link:hover { color: var(--accent); }
  .external-link::before { content: 'ğŸ”—'; font-size: 0.75rem; }

  /* â”€â”€ Validation â”€â”€ */
  .field-error { font-size: 0.67rem; color: var(--danger); margin-top: 2px; display: none; }
  .field-error.show { display: block; }
  .input-error { border-color: var(--danger) !important; }

  /* â”€â”€ Prepayment â”€â”€ */
  .prepay-type-row { display: flex; gap: 8px; margin-bottom: 14px; }
  .prepay-type-btn {
    flex: 1; padding: 10px 6px; background: var(--surface2); border: 1px solid var(--border2);
    border-radius: var(--radius-sm); color: var(--muted); cursor: pointer; font-size: 0.75rem;
    text-align: center; transition: all 0.18s; font-family: 'Noto Serif JP', serif; line-height: 1.4;
  }
  .prepay-type-btn.active {
    background: rgba(200,169,110,0.1); border-color: var(--accent); color: var(--accent2); font-weight: 600;
  }
  .prepay-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 14px; }
  .prepay-result-box {
    background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 12px; text-align: center;
  }
  .prepay-result-box.highlight { border-color: rgba(94,160,130,0.5); background: rgba(94,160,130,0.06); }
  .prepay-result-label { font-size: 0.65rem; color: var(--muted); margin-bottom: 6px; }
  .prepay-result-val { font-family: 'DM Mono', monospace; font-size: 1rem; color: var(--text); }
  .prepay-result-val.green { color: var(--safe); }
  .prepay-result-val.gold { color: var(--accent2); }

  /* â”€â”€ Breakeven box â”€â”€ */
  .breakeven-box {
    background: rgba(82,130,184,0.07); border: 1px solid rgba(82,130,184,0.35);
    border-radius: var(--radius-sm); padding: 14px 16px; margin-top: 12px; display: none;
  }
  .breakeven-label { font-size: 0.68rem; color: var(--info); margin-bottom: 5px; }
  .breakeven-val { font-family: 'DM Mono', monospace; font-size: 1.05rem; color: var(--text); }

  /* â”€â”€ Collapsible â”€â”€ */
  .collapsible-header {
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; user-select: none; -webkit-user-select: none;
    margin: -18px -12px; padding: 18px 12px;
    border-radius: var(--radius) var(--radius) 0 0;
  }
  .collapsible-header:hover { background: rgba(255,255,255,0.02); }
  .collapsible-header:hover .collapse-icon { color: var(--accent2); }
  .collapse-icon { font-size: 1rem; color: var(--muted); transition: transform 0.25s ease; flex-shrink: 0; margin-left: 8px; }
  .collapse-icon.open { transform: rotate(180deg); }
  .collapsible-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(0.25,0,0.3,1), opacity 0.25s ease; max-height: 0; opacity: 0; pointer-events: none; }
  .collapsible-body.open { max-height: 3000px; opacity: 1; pointer-events: auto; padding-top: 18px; }

  /* â”€â”€ Share notice â”€â”€ */
  .share-notice { font-size: 0.7rem; color: var(--safe); margin-top: 6px; text-align: center; display: none; }

  /* â”€â”€ PWA Banner â”€â”€ */
  #pwaInstallBanner {
    display: none; position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    background: var(--surface); border: 1px solid var(--accent); border-radius: var(--radius);
    padding: 12px 16px; z-index: 999; box-shadow: 0 4px 24px rgba(0,0,0,0.6);
    text-align: center; width: calc(100% - 32px); max-width: 420px;
  }
  #pwaInstallBanner p { font-size: 0.76rem; color: var(--text2); margin-bottom: 10px; }
  #pwaInstallBanner .pwa-btns { display: flex; gap: 8px; }

  /* â”€â”€ Share Modal â”€â”€ */
  .share-modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    z-index: 2000; align-items: center; justify-content: center; padding: 16px;
  }
  .share-modal-overlay.open { display: flex; }
  .share-modal {
    background: var(--surface); border: 1px solid var(--border2); border-radius: var(--radius);
    padding: 20px; width: 100%; max-width: 420px; box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    animation: fadeIn 0.2s ease;
    max-height: 90vh; display: flex; flex-direction: column;
  }
  .share-modal-title { font-size: 0.8rem; color: var(--accent2); font-weight: 700; margin-bottom: 14px; letter-spacing: 0.06em; flex-shrink: 0; }
  .share-preview {
    width: 100%; border-radius: var(--radius-sm); overflow-y: auto; overflow-x: hidden;
    margin-bottom: 12px; border: 1px solid var(--border);
    flex: 1; min-height: 80px; max-height: 50vh;
  }
  .share-preview img { width: 100%; display: block; }
  .share-preview-loading {
    height: 120px; display: flex; align-items: center; justify-content: center;
    color: var(--muted); font-size: 0.78rem;
  }
  .share-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; flex-shrink: 0; }
  .share-btn {
    display: flex; align-items: center; justify-content: center; gap: 7px;
    padding: 11px 8px; border-radius: var(--radius-sm); font-family: 'Noto Serif JP', serif;
    font-size: 0.78rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.18s;
  }
  .share-btn.download { background: var(--surface3); color: var(--text2); border: 1px solid var(--border2); }
  .share-btn.download:hover { border-color: var(--accent); color: var(--accent); }
  .share-btn.webshare { background: var(--accent); color: #0d0c0a; }
  .share-btn.webshare:hover { background: var(--accent2); }
  .share-btn.xshare { background: #000; color: #fff; border: 1px solid #333; }
  .share-btn.xshare:hover { background: #111; }
  .share-btn.lineshare { background: #06c755; color: #fff; }
  .share-btn.lineshare:hover { background: #05b34d; }
  .share-modal-close {
    width: 100%; padding: 9px; background: transparent; border: 1px solid var(--border);
    color: var(--muted); border-radius: var(--radius-sm); font-family: 'Noto Serif JP', serif;
    font-size: 0.75rem; cursor: pointer; transition: all 0.18s;
  }
  .share-modal-close:hover { border-color: var(--border2); color: var(--text2); }

  /* â”€â”€ Share Card (off-screen capture target) â”€â”€ */
  #shareCard {
    position: fixed; left: -9999px; top: 0;
    width: 540px; background: #0d0c0a; padding: 28px 28px 22px;
    font-family: 'Noto Serif JP', serif; color: #f5f2ea;
  }
  .sc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
  .sc-title { font-size: 13px; color: #9a9488; letter-spacing: 0.12em; }
  .sc-subtitle { font-size: 20px; font-weight: 300; color: #f0d080; margin-top: 4px; letter-spacing: 0.08em; }
  .sc-date { font-size: 11px; color: #6e6a62; text-align: right; font-family: 'DM Mono', monospace; }
  .sc-grid { display: grid; gap: 10px; }
  .sc-grid-2 { grid-template-columns: 1fr 1fr; }
  .sc-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  .sc-box {
    background: #1a1816; border: 1px solid #383532; border-radius: 8px;
    padding: 14px 12px; text-align: center;
  }
  .sc-box.accent { border-color: rgba(212,180,120,0.5); background: rgba(212,180,120,0.07); }
  .sc-box.green  { border-color: rgba(110,196,150,0.5); background: rgba(110,196,150,0.07); }
  .sc-box.danger { border-color: rgba(224,120,104,0.5); background: rgba(224,120,104,0.07); }
  .sc-label { font-size: 10px; color: #9a9488; font-weight: 700; margin-bottom: 7px; letter-spacing: 0.04em; }
  .sc-value { font-family: 'DM Mono', monospace; font-size: 18px; color: #f5f2ea; font-weight: 500; }
  .sc-value.gold { color: #f0d080; }
  .sc-value.green { color: #6ec496; }
  .sc-value.red { color: #e07868; }
  .sc-note { font-size: 10px; color: #5a5650; margin-top: 6px; text-align: right; }
  .sc-row {
    display: flex; justify-content: space-between; border-bottom: 1px solid #2c2a28;
    padding: 9px 0; font-size: 12px; color: #d0cbbf;
  }
  .sc-row:last-child { border-bottom: none; }
  .sc-row span:last-child { font-family: 'DM Mono', monospace; color: #f5f2ea; }
  .sc-footer {
    margin-top: 16px; padding-top: 10px; border-top: 1px solid #2a2825;
    text-align: center; font-size: 10px; color: #9a9488; letter-spacing: 0.04em;
    line-height: 1.5;
  }

  /* â”€â”€ Capture Button â”€â”€ */
  .capture-btn {
    display: inline-flex; align-items: center; gap: 6px; margin-top: 14px;
    padding: 8px 16px; background: var(--surface3); border: 1px solid var(--border2);
    border-radius: var(--radius-sm); color: var(--text2); font-family: 'Noto Serif JP', serif;
    font-size: 0.72rem; cursor: pointer; transition: all 0.18s; width: auto;
  }
  .capture-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(212,180,120,0.06); }

  /* â”€â”€ B: Today Summary Card â”€â”€ */
  .today-card {
    background: linear-gradient(135deg, rgba(212,180,120,0.10), rgba(212,180,120,0.04));
    border: 1px solid rgba(212,180,120,0.30);
    border-radius: var(--radius); padding: 14px 16px; margin-bottom: 14px;
  }
  .today-card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .today-card-title { font-size:0.65rem; color:var(--accent); letter-spacing:0.15em; text-transform:uppercase; }
  .today-card-date { font-size:0.62rem; color:var(--muted); font-family:'DM Mono',monospace; }
  .today-card-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  .today-card-item { text-align:center; }
  .today-card-label { font-size:0.6rem; color:var(--muted); margin-bottom:4px; }
  .today-card-val { font-family:'DM Mono',monospace; font-size:1rem; font-weight:500; }
  .today-card-bar { height:4px; border-radius:2px; background:var(--surface3); margin-top:10px; overflow:hidden; }
  .today-card-bar-fill { height:100%; border-radius:2px; transition:width 0.6s ease; }



  /* â”€â”€ F: Sliders â”€â”€ */
  .slider-wrap { padding:0 2px; margin-top:4px; }
  .slider-wrap input[type="range"] { -webkit-appearance:none; width:100%; height:4px; border-radius:2px; background:var(--surface3); outline:none; cursor:pointer; }
  .slider-wrap input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); border:2px solid var(--bg); cursor:pointer; }
  .slider-wrap input[type="range"]::-moz-range-thumb { width:14px; height:14px; border-radius:50%; background:var(--accent); border:2px solid var(--bg); cursor:pointer; }

  /* â”€â”€ A: Yearly Schedule â”€â”€ */
  .schedule-mode-btns { display:flex; gap:4px; margin-bottom:10px; }
  .schedule-mode-btn { padding:5px 12px; font-size:0.68rem; border:1px solid var(--border2); border-radius:4px; background:transparent; color:var(--muted); cursor:pointer; font-family:'Noto Serif JP',serif; transition:all 0.15s; }
  .schedule-mode-btn.active { background:var(--accent); color:var(--bg); border-color:var(--accent); font-weight:600; }
  .yearly-header { display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr 1.2fr; gap:0; background:var(--surface3); border-radius:4px 4px 0 0; position:sticky; top:0; z-index:1; }
  .yearly-header > div { padding:8px 6px; font-size:0.58rem; color:var(--muted); letter-spacing:0.03em; }
  .yearly-header > div:not(:first-child) { text-align:right; }
  .yearly-row { display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr 1.2fr; gap:0; border-bottom:1px solid var(--border); font-family:'DM Mono',monospace; font-size:0.68rem; cursor:pointer; transition:background 0.15s; }
  .yearly-row:hover { background:rgba(255,255,255,0.025); }
  .yearly-row.hl { background:rgba(200,169,110,0.09); }
  .yearly-row > div { padding:8px 6px; text-align:right; color:var(--text); overflow:hidden; }
  .yearly-row > div:first-child { text-align:left; color:var(--muted); font-family:'Noto Serif JP',serif; font-size:0.7rem; }
  .yearly-months { max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
  .yearly-months.open { max-height:2000px; }
  .yearly-months .monthly-sub { display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr 1.2fr; gap:0; font-family:'DM Mono',monospace; font-size:0.62rem; border-bottom:1px solid rgba(56,53,50,0.5); border-left:3px solid var(--accent); margin-left:6px; }
  .yearly-months .monthly-sub > div { padding:5px 6px; text-align:right; color:var(--text2); }
  .yearly-months .monthly-sub > div:first-child { text-align:left; color:var(--muted); font-family:'Noto Serif JP',serif; }

  /* â”€â”€ C: Prepay Compare Chart â”€â”€ */
  .prepay-chart-wrap { margin-top:14px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; }

  /* â”€â”€ E: Refi Advice â”€â”€ */
  .refi-advice { display:flex; align-items:flex-start; gap:10px; padding:12px 14px; border-radius:var(--radius-sm); margin-top:12px; font-size:0.75rem; line-height:1.5; }
  .refi-advice.positive { background:rgba(110,196,150,0.08); border:1px solid rgba(110,196,150,0.3); color:var(--safe); }
  .refi-advice.negative { background:rgba(224,120,104,0.08); border:1px solid rgba(224,120,104,0.3); color:var(--danger); }
  .refi-advice.neutral { background:rgba(106,158,216,0.08); border:1px solid rgba(106,158,216,0.3); color:var(--info); }

  /* â”€â”€ G: Equity Donut â”€â”€ */
  .equity-wrap { display:flex; align-items:center; gap:16px; padding:14px; margin-top:12px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); flex-wrap:wrap; }
  .equity-wrap canvas { width:90px; height:90px; flex-shrink:0; }
  .equity-info { flex:1; min-width:140px; }
  .equity-row { display:flex; justify-content:space-between; font-size:0.72rem; padding:4px 0; border-bottom:1px solid var(--border); }
  .equity-row:last-child { border-bottom:none; }
  .equity-row span:last-child { font-family:'DM Mono',monospace; }

</style>
</head>
<body>

<div id="pwaInstallBanner">
  <p>ğŸ“± ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã€ã„ã¤ã§ã‚‚ã™ãã«ä½¿ãˆã¾ã™</p>
  <div class="pwa-btns">
    <button class="btn" style="margin-top:0; flex:1;" id="pwaInstallBtn">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
    <button class="btn" style="margin-top:0; flex:0.4; background:var(--surface2); color:var(--muted); border:1px solid var(--border);" onclick="document.getElementById('pwaInstallBanner').style.display='none'">å¾Œã§</button>
  </div>
</div>

<div class="header">
  <div class="header-corner tl"></div>
  <div class="header-corner tr"></div>
  <div class="header-corner bl"></div>
  <div class="header-corner br"></div>
  <div class="header-inner">
    <div class="header-eyebrow">MORTGAGE SIMULATOR</div>
    <h1>ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</h1>
    <div class="header-rule"><div class="header-rule-dot"></div></div>
    <p>è¿”æ¸ˆçŠ¶æ³ãƒ»å¤‰å‹•é‡‘åˆ©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</p>
  </div>
</div>

<div class="card">
  <div class="card-title collapsible-header" onclick="toggleCard('bodyLoan')" role="button" tabindex="0" aria-expanded="true" aria-controls="bodyLoan" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCard('bodyLoan')}">
    <span>ãƒ­ãƒ¼ãƒ³æƒ…å ±ã®å…¥åŠ›</span>
    <span class="collapse-icon open" id="iconLoan">â–¼</span>
  </div>
  <div class="collapsible-body open" id="bodyLoan">
  <div class="form-grid">
    <div class="form-group">
      <label>å€Ÿå…¥é‡‘é¡ï¼ˆä¸‡å††ï¼‰</label>
      <input type="number" id="principal" value="4700" min="1" inputmode="decimal">
      <div class="slider-wrap"><input type="range" id="principalSlider" min="500" max="15000" step="100" value="4700"></div>
    </div>
    <div class="form-group">
      <label>å½“åˆå¹´åˆ©ï¼ˆ%ï¼‰</label>
      <input type="number" id="rate" value="0.25" step="0.001" min="0.01" inputmode="decimal">
      <div class="slider-wrap"><input type="range" id="rateSlider" min="0.1" max="5.0" step="0.01" value="0.25"></div>
    </div>
    <div class="form-group">
      <label>è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</label>
      <input type="number" id="years" value="35" min="1" max="50" inputmode="numeric">
      <div class="slider-wrap"><input type="range" id="yearsSlider" min="5" max="50" step="1" value="35"></div>
    </div>
    <div class="form-group">
      <label>è¿”æ¸ˆæ–¹å¼</label>
      <select id="method" onchange="toggleRulesVisibility()">
        <option value="equal_payment">å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</option>
        <option value="equal_principal">å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</option>
      </select>
    </div>
    <div class="form-group">
      <label>å€Ÿå…¥é–‹å§‹å¹´æœˆ (ç‰©ä»¶è³¼å…¥æœˆ)</label>
      <input type="month" id="startDate" value="2024-03">
    </div>
    <div class="form-group">
      <label>ç«¯æ•°å‡¦ç†</label>
      <select id="roundingMode">
        <option value="floor" selected>åˆ‡ã‚Šæ¨ã¦ (æ¨å¥¨)</option>
        <option value="round">å››æ¨äº”å…¥</option>
        <option value="ceil">åˆ‡ã‚Šä¸Šã’</option>
      </select>
    </div>
  </div>

  <div id="ruleOptionContainer" style="margin-top: 16px;">
    <div class="checkbox-group">
      <input type="checkbox" id="useJibunRules" checked>
      <label for="useJibunRules">5å¹´ãƒ«ãƒ¼ãƒ«ãƒ»125%ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹</label>
    </div>
    <div class="rule-desc">
      â€»é‡‘åˆ©ä¸Šæ˜‡æ™‚ã‚‚5å¹´é–“ã¯è¿”æ¸ˆé¡ã‚’æ®ãˆç½®ãã€ä¸Šæ˜‡å¹…ã‚‚25%ä»¥å†…ã«æŠ‘ãˆã¾ã™ã€‚
    </div>
  </div>

  <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border);">
    <div class="card-title">ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆ (æœˆé¡)</div>
    <div class="form-grid">
      <div class="form-group">
        <label>ç®¡ç†è²» (å††)</label>
        <input type="number" id="costAdmin" placeholder="0" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>ä¿®ç¹•ç©ç«‹é‡‘ (å††)</label>
        <input type="number" id="costRepair" placeholder="0" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>é§è»Šå ´ãƒ»ãã®ä»– (å††)</label>
        <input type="number" id="costOther" placeholder="0" inputmode="numeric">
      </div>
    </div>
  </div>

  <div class="rate-section">
    <div class="rate-section-header">
      <span class="rate-section-title">ğŸ“ˆ é‡‘åˆ©å¤‰å‹•ã®è¿½åŠ </span>
      <button class="rate-section-add-btn" onclick="showRateForm()">ï¼‹ äºˆå®šã‚’è¿½åŠ </button>
    </div>
    <div id="rateChangeList">
      <div class="empty-state" style="padding:10px; font-size:0.78rem;">é‡‘åˆ©å¤‰æ›´ãªã—</div>
    </div>
    <div class="rate-add-form" id="rateAddForm">
      <div class="form-grid" style="margin-bottom:12px;">
        <div class="form-group">
          <label>é©ç”¨é–‹å§‹å¹´æœˆ</label>
          <input type="month" id="rcMonthDate">
        </div>
        <div class="form-group">
          <label>å¤‰æ›´å¾Œã®å¹´åˆ© (%)</label>
          <input type="number" id="rcRate" step="0.01" placeholder="0.5" min="0.01">
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" style="margin-top:0;" onclick="confirmRateChange()">ä¿å­˜ã—ã¦é©ç”¨</button>
        <button class="btn" style="margin-top:0; background:var(--surface); color:var(--muted); border:1px solid var(--border);" onclick="hideRateForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <button class="btn" onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
  <div style="font-size:0.65rem; color:var(--muted); margin-top:6px; text-align:center;">â€»å…¥åŠ›å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•ã§å†è¨ˆç®—ã•ã‚Œã¾ã™</div>
  <div class="save-notice" id="saveNotice">âœ“ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>
  </div><!-- /collapsible-body -->
</div>

<div id="results">
  
  <div class="total-cost-banner">
    <div class="total-cost-label">æ¯æœˆã®ä½å±…è²» åˆè¨ˆ</div>
    <div class="total-cost-value" id="totalMonthlyCost">0å††</div>
    <div class="total-cost-detail">
      ( ãƒ­ãƒ¼ãƒ³: <span id="detailLoan">0</span> + ç®¡ç†è²»ç­‰: <span id="detailRun">0</span> )
    </div>
  </div>

  <!-- B: ä»Šæœˆã®è¿”æ¸ˆå†…è¨³ã‚µãƒãƒªãƒ¼ -->
  <div class="today-card" id="todayCard" style="display:none;">
    <div class="today-card-header">
      <div class="today-card-title">ğŸ“… ä»Šæœˆã®è¿”æ¸ˆå†…è¨³</div>
      <div class="today-card-date" id="todayCardDate"></div>
    </div>
    <div class="today-card-grid">
      <div class="today-card-item"><div class="today-card-label">å…ƒé‡‘</div><div class="today-card-val" style="color:var(--accent2)" id="todayPrincipal">â€”</div></div>
      <div class="today-card-item"><div class="today-card-label">åˆ©æ¯</div><div class="today-card-val" style="color:var(--danger)" id="todayInterest">â€”</div></div>
      <div class="today-card-item"><div class="today-card-label">å…ƒé‡‘æ¯”ç‡</div><div class="today-card-val" style="color:var(--safe)" id="todayRatio">â€”</div></div>
    </div>
    <div class="today-card-bar"><div class="today-card-bar-fill" id="todayBarFill" style="width:0%;background:linear-gradient(90deg,var(--accent),var(--safe));"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:0.55rem;color:var(--muted);margin-top:2px;"><span>â† åˆ©æ¯</span><span>å…ƒé‡‘ â†’</span></div>
  </div>

  <div class="stats-section-label">è¿”æ¸ˆé¡ã®æ¯”è¼ƒ (ãƒ­ãƒ¼ãƒ³ã®ã¿)</div>
  <div class="stats-grid-4">
    <div class="stat-box">
      <div class="stat-label">å½“åˆ æœˆè¿”æ¸ˆé¡</div>
      <div class="stat-value" id="statInitial">â€”</div>
      <div class="stat-sub">å€Ÿå…¥é–‹å§‹æ™‚ã®ãŠæ”¯æ‰•é¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">ç¾åœ¨ æœˆè¿”æ¸ˆé¡</div>
      <div class="stat-value accent" id="statCurrent">â€”</div>
      <div class="stat-sub">ç¾åœ¨ã®é‡‘åˆ©ã§ã®ãŠæ”¯æ‰•é¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">5å¹´ãƒ»125%ãƒ«ãƒ¼ãƒ«ãŒ<br>ãªã‹ã£ãŸå ´åˆ</div>
      <div class="stat-value" id="statTheoretical" style="color:var(--muted)">â€”</div>
      <div class="stat-sub" id="statTheoreticalDiff"></div>
    </div>
    <div class="stat-box" style="border-color:var(--safe); background:rgba(106,170,142,0.05);">
      <div class="stat-label" style="color:var(--safe)">æ¬¡å› è¦‹ç›´ã—äºˆå®š</div>
      <div class="stat-value" style="color:var(--safe)" id="statNextChange">â€”</div>
      <div class="stat-sub" id="statNextChangeDate">5å¹´ãƒ«ãƒ¼ãƒ«ã®æ¬¡å›é©ç”¨æ™‚</div>
    </div>
  </div>

  <div class="stats-section-label">ç·æ”¯æ‰•ãƒ»é€²æ—çŠ¶æ³</div>
  <div class="stats-grid-3">
    <div class="stat-box">
      <div class="stat-label">ç·åˆ©æ¯</div>
      <div class="stat-value danger" id="statTotalInterest">â€”</div>
      <div class="stat-sub">å…¨æœŸé–“ã§æ‰•ã†åˆ©æ¯ã®åˆè¨ˆ</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">ç·æ”¯æ‰•é¡</div>
      <div class="stat-value" id="statTotal">â€”</div>
      <div class="stat-sub">å…ƒé‡‘ï¼‹åˆ©æ¯ã®æœ€çµ‚åˆè¨ˆé¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">è¿”æ¸ˆé€²æ—</div>
      <div class="stat-value" id="progressPct">â€”</div>
      <div class="stat-sub">å½“åˆå…ƒé‡‘ã«å¯¾ã™ã‚‹è¿”æ¸ˆæ¸ˆã¿å‰²åˆ</div>
    </div>
  </div>

  <div id="deferredWarning" class="deferred-interest">
    âš ï¸ <strong>æ³¨æ„:</strong> æœªæ‰•åˆ©æ¯ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
  </div>

  <!-- â‘¦ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒŠãƒ“ -->
  <div style="display:flex;gap:6px;flex-wrap:wrap;margin:12px 0 6px;justify-content:center;">
    <a href="#" onclick="event.preventDefault();jumpTo('bodyPrepay')" style="font-size:0.68rem;color:var(--accent);text-decoration:none;padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);">ğŸ“… ç¹°ã‚Šä¸Šã’è¿”æ¸ˆ</a>
    <a href="#" onclick="event.preventDefault();jumpTo('bodyRefi')" style="font-size:0.68rem;color:var(--info);text-decoration:none;padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);">ğŸ¦ å€Ÿã‚Šæ›ãˆ</a>
    <a href="#" onclick="event.preventDefault();jumpTo('bodySale')" style="font-size:0.68rem;color:var(--safe);text-decoration:none;padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);">ğŸ  å£²å´</a>
    <a href="#" onclick="event.preventDefault();jumpTo('bodyTools')" style="font-size:0.68rem;color:var(--muted);text-decoration:none;padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);">âš™ æ§é™¤ãƒ»è¨­å®š</a>
  </div>

  <div style="text-align:right; margin-top:8px; margin-bottom:6px;">
    <button class="capture-btn" onclick="openShareModal('summary')">ğŸ“¤ ã“ã®çµæœã‚’å…±æœ‰</button>
  </div>

  <div class="card">
    <div class="card-title">æ®‹é«˜æ¨ç§»</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-labels">
      <span id="paidAmount">â€”</span>
      <span>æ®‹é«˜: <span id="remainBalance">â€”</span></span>
    </div>
    <div style="margin-top:12px; font-size:0.78rem; color:var(--muted); text-align:right;">
      æ®‹ã‚ŠæœŸé–“: <span style="color:var(--text); font-family:'DM Mono',monospace;" id="remainMonths">â€”</span>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('schedule')">è¿”æ¸ˆä¸€è¦§</div>
      <div class="tab" onclick="switchTab('graph')">å†…è¨³ã‚°ãƒ©ãƒ•</div>
      <div class="tab" onclick="switchTab('balance')">æ®‹é«˜æ¨ç§»</div>
      <div class="tab" onclick="switchTab('cumulative')">ç´¯è¨ˆã‚³ã‚¹ãƒˆ</div>
    </div>

    <div id="tab-graph" style="display:none">
      <p style="text-align:center; font-size:0.75rem; color:var(--muted); margin-bottom:10px;">
        <span style="display:inline-block; width:10px; height:10px; background:var(--principal); margin-right:4px;"></span>å…ƒé‡‘
        <span style="display:inline-block; width:10px; height:10px; background:var(--interest); margin-right:4px; margin-left:10px;"></span>åˆ©æ¯
      </p>
      <div class="chart-wrapper">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div id="tab-balance" style="display:none">
      <p style="font-size:0.72rem; color:var(--muted); margin-bottom:10px; text-align:center;">
        <span style="display:inline-block; width:8px; height:8px; background:var(--info); border-radius:50%; margin-right:3px;"></span>ãƒ­ãƒ¼ãƒ³æ®‹é«˜
        <span style="display:inline-block; width:8px; height:8px; background:var(--accent); border-radius:50%; margin-right:3px; margin-left:8px;"></span>è¿”æ¸ˆæ¸ˆã¿å…ƒé‡‘
      </p>
      <div class="chart-wrapper">
        <canvas id="balanceChart"></canvas>
      </div>
    </div>

    <div id="tab-cumulative" style="display:none">
      <p style="font-size:0.72rem; color:var(--muted); margin-bottom:10px; text-align:center;">
        <span style="display:inline-block; width:8px; height:8px; background:#c4715a; border-radius:50%; margin-right:3px;"></span>ãƒ­ãƒ¼ãƒ³ç´¯è¨ˆ
        <span style="display:inline-block; width:8px; height:8px; background:#5a8bc4; border-radius:50%; margin-right:3px; margin-left:8px;"></span>ä½å±…è²»ç´¯è¨ˆï¼ˆç®¡ç†è²»ç­‰å«ã‚€ï¼‰
      </p>
      <div class="chart-wrapper">
        <canvas id="cumulativeChart"></canvas>
      </div>
      <p style="font-size:0.65rem; color:var(--muted); margin-top:8px; text-align:right;">â€»ç®¡ç†è²»ç­‰ã¯ç¾åœ¨ã®å…¥åŠ›å€¤ãŒå…¨æœŸé–“ç¶šãã¨ä»®å®š</p>
    </div>

    <div id="tab-schedule">
      <div class="schedule-mode-btns">
        <button class="schedule-mode-btn active" id="modeYearly" onclick="setScheduleMode('yearly')">ğŸ“Š å¹´å˜ä½</button>
        <button class="schedule-mode-btn" id="modeMonthly" onclick="setScheduleMode('monthly')">ğŸ“‹ æœˆå˜ä½</button>
      </div>
      <div id="scheduleYearly" class="table-wrap" style="max-height:480px;"></div>
      <div id="scheduleMonthly" style="display:none;">
        <div class="table-wrap">
          <table>
            <caption class="sr-only" style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);">æœˆåˆ¥è¿”æ¸ˆäºˆå®šè¡¨</caption>
            <colgroup><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:15%"><col style="width:25%"></colgroup>
            <thead><tr><th>å¹´æœˆ</th><th>è¿”æ¸ˆé¡(å††)</th><th>å…ƒé‡‘(å††)</th><th>åˆ©æ¯(å††)</th><th>æ®‹é«˜(å††)</th></tr></thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="border-top:3px solid var(--accent2)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodyPrepay')" role="button" tabindex="0" aria-expanded="false" aria-controls="bodyPrepay" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCard('bodyPrepay')}">
      <span>ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
      <span class="collapse-icon" id="iconPrepay">â–¼</span>
    </div>
    <div class="collapsible-body" id="bodyPrepay">
    <p style="font-size:0.75rem; color:var(--muted); margin-bottom:14px; margin-top:4px;">ä»Šã™ãç¹°ã‚Šä¸Šã’è¿”æ¸ˆã—ãŸå ´åˆã®åŠ¹æœï¼ˆåˆ©æ¯å‰Šæ¸›é¡ãƒ»æœŸé–“çŸ­ç¸®ï¼‰ã‚’è©¦ç®—ã—ã¾ã™ã€‚</p>

    <div class="prepay-type-row">
      <button class="prepay-type-btn active" id="prepayTypeShorten" onclick="setPrepayType('shorten')">ğŸ“… æœŸé–“çŸ­ç¸®å‹<br><span style="font-size:0.65rem; font-weight:400;">è¿”æ¸ˆæœŸé–“ã‚’ç¸®ã‚ã‚‹</span></button>
      <button class="prepay-type-btn" id="prepayTypeReduce" onclick="setPrepayType('reduce')">ğŸ’´ è¿”æ¸ˆé¡è»½æ¸›å‹<br><span style="font-size:0.65rem; font-weight:400;">æœˆè¿”æ¸ˆé¡ã‚’ä¸‹ã’ã‚‹</span></button>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label>ç¹°ã‚Šä¸Šã’è¿”æ¸ˆé¡ (ä¸‡å††)</label>
        <input type="number" id="prepayAmount" inputmode="decimal" placeholder="ä¾‹ï¼š100" min="1">
        <span class="field-error" id="prepayAmountErr">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
      </div>
      <div class="form-group">
        <label>å®Ÿè¡Œæ™‚æœŸ</label>
        <select id="prepayTiming">
          <option value="0">ä»Šã™ãï¼ˆä»Šæœˆï¼‰</option>
          <option value="6">6ãƒ¶æœˆå¾Œ</option>
          <option value="12">1å¹´å¾Œ</option>
          <option value="24">2å¹´å¾Œ</option>
          <option value="36">3å¹´å¾Œ</option>
          <option value="60">5å¹´å¾Œ</option>
        </select>
      </div>
    </div>

    <button class="btn" style="background:var(--accent2); color:#0f0e0c; margin-top:12px;" onclick="calcPrepayment()">åŠ¹æœã‚’è¨ˆç®—</button>

    <div id="prepayResult" style="display:none; margin-top:4px;">
      <div id="prepayFullPayoffNote" style="display:none;font-size:0.7rem;color:var(--info);margin-bottom:8px;padding:8px 12px;background:rgba(106,157,216,0.08);border:1px solid rgba(106,157,216,0.3);border-radius:var(--radius-sm);"></div>
      <div class="prepay-result-grid">
        <div class="prepay-result-box highlight">
          <div class="prepay-result-label">ğŸ’° åˆ©æ¯å‰Šæ¸›é¡</div>
          <div class="prepay-result-val green" id="prepayInterestSaved">â€”</div>
        </div>
        <div class="prepay-result-box highlight" id="prepayMainBox">
          <div class="prepay-result-label" id="prepayMainLabel">â± æœŸé–“çŸ­ç¸®</div>
          <div class="prepay-result-val gold" id="prepayMainVal">â€”</div>
        </div>
        <div class="prepay-result-box">
          <div class="prepay-result-label">ç¹°ã‚Šä¸Šã’å‰ ç·åˆ©æ¯</div>
          <div class="prepay-result-val" id="prepayOldInterest">â€”</div>
        </div>
        <div class="prepay-result-box">
          <div class="prepay-result-label">ç¹°ã‚Šä¸Šã’å¾Œ ç·åˆ©æ¯</div>
          <div class="prepay-result-val" id="prepayNewInterest">â€”</div>
        </div>
      </div>
      <p style="font-size:0.65rem; color:var(--muted); margin-top:10px; text-align:right;">â€»5å¹´ãƒ«ãƒ¼ãƒ«ãƒ»125%ãƒ«ãƒ¼ãƒ«ã¯è€ƒæ…®ã›ãšè¨ˆç®—ã—ã¦ã„ã¾ã™</p>
      <!-- C: ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
      <div class="prepay-chart-wrap" id="prepayChartWrap" style="display:none;">
        <div style="display:flex;gap:14px;justify-content:center;font-size:0.68rem;color:var(--muted);margin-bottom:8px;">
          <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#c4715a;margin-right:4px;vertical-align:middle;"></span>ç¹°ã‚Šä¸Šã’å‰</span>
          <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--safe);margin-right:4px;vertical-align:middle;"></span>ç¹°ã‚Šä¸Šã’å¾Œ</span>
        </div>
        <div class="chart-wrapper" style="height:180px;"><canvas id="prepayCompareChart"></canvas></div>
      </div>
      <div style="text-align:right; margin-top:8px;">
        <button class="capture-btn" onclick="openShareModal('prepay')">ğŸ“¤ ã“ã®çµæœã‚’å…±æœ‰</button>
      </div>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <div class="card" style="border-top:3px solid var(--info)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodyRefi')" role="button" tabindex="0" aria-expanded="false" aria-controls="bodyRefi" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCard('bodyRefi')}">
      <span>å€Ÿã‚Šæ›ãˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
      <span class="collapse-icon" id="iconRefi">â–¼</span>
    </div>
    <div class="collapsible-body" id="bodyRefi">
    <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px; margin-top:4px;">ç¾åœ¨ã®æ®‹é«˜ã§å€Ÿã‚Šæ›ãˆãŸå ´åˆã®æå¾—ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
    <div class="form-grid">
      <div class="form-group">
        <label>å€Ÿã‚Šæ›ãˆé‡‘åˆ© (%)</label>
        <input type="number" id="refiRate" value="0.4" step="0.001" inputmode="decimal">
      </div>
      <div class="form-group">
        <label>äº‹å‹™æ‰‹æ•°æ–™ (%)</label>
        <input type="number" id="refiFeeRate" value="2.2" step="0.1" inputmode="decimal">
      </div>
      <div class="form-group">
        <label>ãã®ä»–è«¸è²»ç”¨ (ä¸‡å††)</label>
        <input type="number" id="refiFixCost" value="20" placeholder="ç™»è¨˜è²»ç”¨ãªã©" inputmode="decimal">
      </div>
    </div>
    <button class="btn" style="margin-top:12px" onclick="calcRefinance()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
    
    <div id="refiResult" style="display:none; margin-top:16px;">
      <div class="refi-row has-sub">
        <span>ç¾åœ¨ã®æ®‹ã‚Šç·æ”¯æ‰•</span>
        <span id="refiOldTotal">â€”</span>
      </div>
      <div class="refi-row sub">
        <span>â”— æ®‹ã‚Šå…ƒé‡‘ (ç¾åœ¨æ®‹é«˜)</span>
        <span id="refiOldPrincipal">â€”</span>
      </div>
      <div class="refi-row sub sub-last">
        <span>â”— æ®‹ã‚Šåˆ©æ¯</span>
        <span id="refiOldInterest">â€”</span>
      </div>
      <div class="refi-row has-sub" style="margin-top:8px;">
        <span>å€Ÿã‚Šæ›ãˆå¾Œç·æ”¯æ‰•(è«¸è²»ç”¨è¾¼)</span>
        <span id="refiNewTotal">â€”</span>
      </div>
      <div class="refi-row sub">
        <span>â”— ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆåˆ†</span>
        <span id="refiNewLoan">â€”</span>
      </div>
      <div class="refi-row sub sub-last">
        <span>â”— è«¸è²»ç”¨ (æ‰‹æ•°æ–™ç­‰)</span>
        <span id="refiCost">â€”</span>
      </div>
      <div class="tool-summary">
        <div class="tool-summary-label">å€Ÿã‚Šæ›ãˆåŠ¹æœ</div>
        <div class="tool-summary-val refi-diff" id="refiDiffVal">0å††</div>
        <div style="font-size:0.65rem; color:var(--muted); margin-top:4px;">â€»ãƒ—ãƒ©ã‚¹ãªã‚‰å€Ÿã‚Šæ›ãˆãŸæ–¹ãŒãŠå¾—ã§ã™</div>
      </div>
      <!-- E: å€Ÿã‚Šæ›ãˆè‡ªå‹•åˆ¤å®š -->
      <div id="refiAdvice" style="display:none;"></div>
      <div style="text-align:right; margin-top:10px;">
        <button class="capture-btn" onclick="openShareModal('refi')">ğŸ“¤ ã“ã®çµæœã‚’å…±æœ‰</button>
      </div>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <div class="card" style="border-top:3px solid var(--safe)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodySale')" role="button" tabindex="0" aria-expanded="false" aria-controls="bodySale" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCard('bodySale')}">
      <span>å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (æ‰‹å–ã‚Šé¡è¨ˆç®—)</span>
      <span class="collapse-icon" id="iconSale">â–¼</span>
    </div>
    <div class="collapsible-body" id="bodySale">
    <p style="font-size:0.75rem; color:var(--muted); margin-bottom:8px; margin-top:4px;">æŒ‡å®šã—ãŸæ™‚æœŸã®ãƒ­ãƒ¼ãƒ³æ®‹é«˜ã‚„ç¨é‡‘ã‚’å·®ã—å¼•ãã€æœ€çµ‚çš„ãªæ‰‹å–ã‚Šé¡ã‚’è©¦ç®—ã—ã¾ã™ã€‚</p>
    <div style="margin-bottom:12px; min-height:20px;">
      <span id="taxBadge" class="tax-badge" style="display:none;"></span>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>å£²å´äºˆå®šæ™‚æœŸ</label>
        <input type="month" id="saleDate" value="2034-03">
      </div>
      <div class="form-group">
        <label>å£²å´äºˆå®šé¡ (ä¸‡å††)</label>
        <input type="number" id="salePrice" value="5500" step="10" inputmode="decimal">
      </div>
      <div class="form-group">
        <label>è³¼å…¥ä¾¡æ ¼ (ä¸‡å††)</label>
        <input type="number" id="purchasePrice" value="4700" inputmode="decimal">
      </div>
      <div class="form-group">
        <label>è³¼å…¥æ™‚ã®è«¸è²»ç”¨ (ä¸‡å††)</label>
        <input type="number" id="purchaseCost" value="300" placeholder="ä»²ä»‹æ‰‹æ•°æ–™ç­‰" inputmode="decimal">
      </div>
    </div>
    <div style="margin-top:14px; padding-top:14px; border-top:1px solid var(--border);">
      <div style="font-size:0.72rem; color:var(--accent); font-weight:600; margin-bottom:8px;">ğŸ“ æ¸›ä¾¡å„Ÿå´ï¼ˆä»»æ„ï¼‰</div>
      <div style="font-size:0.62rem; color:var(--muted); margin-bottom:12px; line-height:1.6; padding:9px 12px; background:var(--surface3); border-radius:var(--radius-sm);">
        ğŸ’¡ å»ºç‰©ã¯å¹´æ•°ã§ä¾¡å€¤ãŒä¸‹ãŒã‚Šã€ç¨æ³•ä¸Šã®å–å¾—è²»ãŒæ¸›ã‚Šã¾ã™ã€‚è¨ˆç®—çµæœã«ã€Œå„Ÿå´ãªã— / ã‚ã‚Šã€ã®æ¯”è¼ƒè¡¨ãŒå‡ºã‚‹ã®ã§ã€ç¨é‡‘ã¸ã®å½±éŸ¿ãŒä¸€ç›®ã§åˆ†ã‹ã‚Šã¾ã™ã€‚
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>å»ºç‰©å‰²åˆ (%)</label>
          <input type="number" id="buildingRatio" value="50" min="0" max="100" step="1" inputmode="numeric" placeholder="ä¾‹:50">
        </div>
        <div class="form-group">
          <label>å»ºç‰©æ§‹é€ </label>
          <select id="buildingType">
            <option value="rc" selected>RCé€ ï¼ˆãƒãƒ³ã‚·ãƒ§ãƒ³ï¼‰</option>
            <option value="steel">é‡é‡é‰„éª¨é€ </option>
            <option value="light_steel">è»½é‡é‰„éª¨é€ </option>
            <option value="wood">æœ¨é€ </option>
          </select>
        </div>
      </div>
      <div style="font-size:0.58rem; color:var(--muted); margin-top:4px;">
        è€ç”¨å¹´æ•°: <span id="depreciationInfo" style="color:var(--text2);">RCé€  47å¹´ â†’ éäº‹æ¥­ç”¨70å¹´ â†’ å„Ÿå´ç‡ 0.015</span>
      </div>
    </div>
    
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:16px;">
      <div class="checkbox-group" style="margin-top:0;">
        <input type="checkbox" id="use30mDeduction" checked>
        <label for="use30mDeduction">å±…ä½ç”¨è²¡ç”£ã®3,000ä¸‡å††ç‰¹åˆ¥æ§é™¤ã‚’é©ç”¨ã™ã‚‹</label>
      </div>
      <div class="checkbox-group" style="margin-top:0;">
        <input type="checkbox" id="use10yRate" checked>
        <label for="use10yRate">10å¹´è¶…ã®è»½æ¸›ç¨ç‡ (14.21%) ã‚’é©ç”¨ã™ã‚‹</label>
      </div>
      <div style="font-size:0.65rem; color:var(--danger); margin-top:-4px;">â€»ä¸Šè¨˜2ã¤ã®ç‰¹ä¾‹ã¯ã€æ–°å±…ã§ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ä½µç”¨ã§ãã¾ã›ã‚“ã€‚</div>
    </div>
    
    <button class="btn" style="background:var(--safe); color:#fff; margin-top:16px" onclick="calcSale()">å£²å´æ‰‹å–ã‚Šé¡ã‚’è¨ˆç®—</button>

    <div id="saleResult" style="display:none; margin-top:20px;">
      <div class="tool-summary" style="background:rgba(106,170,142,0.1); border-color:var(--safe); margin-bottom:16px;">
        <div class="tool-summary-label">æœ€çµ‚æ‰‹å–ã‚Šé¡ (å«ã¿ç›Š)</div>
        <div class="tool-summary-val" id="saleResNet" style="color:var(--text); font-size:1.6rem;">0å††</div>
      </div>

      <!-- G: æ®‹å‚µvsç‰©ä»¶ä¾¡å€¤ ãƒ‰ãƒ¼ãƒŠãƒ„ -->
  <div class="equity-wrap" id="equityWrap" style="display:none;">
    <canvas id="equityDonut" width="100" height="100"></canvas>
    <div class="equity-info">
      <div class="equity-row"><span style="color:var(--muted);">ğŸ”´ ãƒ­ãƒ¼ãƒ³æ®‹é«˜</span><span style="color:var(--danger);" id="eqDebt">â€”</span></div>
      <div class="equity-row"><span style="color:var(--muted);">ğŸŸ  å£²å´è²»ç”¨</span><span style="color:#e0a868;" id="eqCost">â€”</span></div>
      <div class="equity-row"><span style="color:var(--muted);">ğŸŸ¢ å£²å´äºˆå®šé¡</span><span style="color:var(--safe);" id="eqValue">â€”</span></div>
      <div class="equity-row" style="border-top:1px solid var(--border);padding-top:6px;margin-top:2px;"><span style="font-weight:600;" id="eqResultLabel">å«ã¿ç›Š/æ</span><span id="eqResult">â€”</span></div>
    </div>
  </div>
  <div class="breakeven-box" id="breakevenBox">
        <div class="breakeven-label">ğŸ“ å£²å´æ‰‹å–ã‚ŠãŒãƒ—ãƒ©ã‚¹ã«ãªã‚‹æœ€çŸ­æ™‚æœŸ</div>
        <div class="breakeven-val" id="breakevenVal">â€”</div>
        <div style="font-size:0.62rem; color:var(--muted); margin-top:6px;">â€»ä¸Šè¨˜ã®å£²å´ä¾¡æ ¼ãƒ»ç¨ç‡ã®å…¥åŠ›å€¤ã§è©¦ç®—ã—ãŸç›®å®‰ã§ã™</div>
        <div class="chart-wrapper" style="height:180px; margin-top:12px;">
          <canvas id="breakevenChart"></canvas>
        </div>
      </div>

      <div class="calc-breakdown" id="calcBreakdown"></div>
      <div style="text-align:right; margin-top:10px;">
        <button class="capture-btn" onclick="openShareModal('sale')">ğŸ“¤ ã“ã®çµæœã‚’å…±æœ‰</button>
      </div>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <div class="card" style="border-top:3px solid var(--accent)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodyTools')" role="button" tabindex="0" aria-expanded="false" aria-controls="bodyTools" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCard('bodyTools')}">
      <span>ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ãƒ»è¨­å®š</span>
      <span class="collapse-icon" id="iconTools">â–¼</span>
    </div>
    <div class="collapsible-body" id="bodyTools">
    <div class="tools-tabs" style="margin-top:4px;">
      <div class="tools-tab active" onclick="switchTool('tax')">ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤</div>
      <div class="tools-tab" onclick="switchTool('data')">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    </div>

    <div id="tool-tax" class="tool-content active">
      <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px;">å¹´æœ«æ®‹é«˜ã‚’ã‚‚ã¨ã«æ§é™¤é¡ã‚’è©¦ç®—ã—ã¾ã™ã€‚</p>
      <div class="form-grid">
        <div class="form-group">
          <label>æ§é™¤æœŸé–“</label>
          <select id="taxPeriod">
            <option value="13">13å¹´é–“</option>
            <option value="10">10å¹´é–“</option>
          </select>
        </div>
        <div class="form-group">
          <label>æ§é™¤ç‡ (%)</label>
          <input type="number" id="taxRate" value="0.7" step="0.1">
        </div>
        <div class="form-group">
          <label>å€Ÿå…¥é™åº¦é¡ (ä¸‡å††)</label>
          <select id="taxLimit">
            <option value="2000">2000ä¸‡å††</option>
            <option value="3000" selected>3000ä¸‡å††</option>
            <option value="4000">4000ä¸‡å††</option>
            <option value="4500">4500ä¸‡å††</option>
            <option value="5000">5000ä¸‡å††</option>
          </select>
        </div>
      </div>
      <button class="btn" style="margin-top:12px" onclick="calcTaxDeduction()">æ§é™¤é¡ã‚’è¨ˆç®—</button>
      <div id="taxResult" style="display:none;">
        <div class="tool-summary">
          <div class="tool-summary-label">ç·æ§é™¤é¡ï¼ˆç›®å®‰ï¼‰</div>
          <div class="tool-summary-val" id="taxTotalVal">0å††</div>
          <div style="font-size:0.65rem; color:var(--muted); margin-top:4px;">â€»æ‰€å¾—ç¨ãƒ»ä½æ°‘ç¨ã®ä¸Šé™ç­‰ã¯è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>
    </div>

    <div id="tool-data" class="tool-content">
      <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px;">è¨­å®šã®ä¿å­˜ã‚„ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®æ›¸ãå‡ºã—ã‚’è¡Œãˆã¾ã™ã€‚</p>
      <div style="display:flex; gap:10px; flex-direction:column;">
        <button class="btn-outline" onclick="copyShareLink()">ğŸ”— ã“ã®è¨­å®šã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
        <div class="share-notice" id="shareNotice">âœ“ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
        <button class="btn-outline" onclick="exportData()">ğŸ’¾ è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</button>
        <button class="btn-outline" onclick="exportCSV()">ğŸ“Š è¿”æ¸ˆäºˆå®šã‚’CSVã§ä¿å­˜</button>
        <div style="position:relative; margin-top:4px;">
           <label class="btn" style="display:block; text-align:center; margin:0;">
             ğŸ“‚ è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
             <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
           </label>
        </div>
      </div>

      <div style="margin-top:20px; padding-top:16px; border-top:1px solid var(--border);">
        <div class="card-title" style="margin-bottom:10px; padding-bottom:8px;">ğŸ“Œ ã‚·ãƒŠãƒªã‚ªä¿å­˜ãƒ»æ¯”è¼ƒ</div>
        <p style="font-size:0.7rem; color:var(--muted); margin-bottom:10px;">ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’ã‚·ãƒŠãƒªã‚ªã¨ã—ã¦ä¿å­˜ã—ã€è¤‡æ•°ãƒ—ãƒ©ãƒ³ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚</p>
        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <input type="text" id="scenarioName" placeholder="ã‚·ãƒŠãƒªã‚ªåï¼ˆä¾‹: 35å¹´å›ºå®šï¼‰" style="flex:1; background:var(--surface2); border:1px solid var(--border2); border-radius:var(--radius-sm); padding:8px 10px; color:var(--text); font-family:'Noto Serif JP',serif; font-size:0.75rem;">
          <button class="btn" style="margin:0; padding:8px 14px; font-size:0.75rem; white-space:nowrap;" onclick="saveScenario()">ä¿å­˜</button>
        </div>
        <div id="scenarioList"></div>
      </div>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <a href="rate_compare.html" style="
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background:linear-gradient(135deg,rgba(74,158,255,0.08),rgba(74,158,255,0.04));
    border:1px solid rgba(74,158,255,0.3); border-radius:var(--radius);
    padding:16px 18px; text-decoration:none; margin-bottom:14px;
    transition:border-color 0.2s;
  " onmouseover="this.style.borderColor='rgba(74,158,255,0.6)'" onmouseout="this.style.borderColor='rgba(74,158,255,0.3)'">
    <div>
      <div style="font-size:0.62rem;letter-spacing:0.18em;color:#4a9eff;text-transform:uppercase;margin-bottom:5px;">SIMULATOR</div>
      <div style="font-size:0.9rem;color:var(--text);font-weight:400;letter-spacing:0.04em;">ğŸ“Š è¿”æ¸ˆé¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
      <div style="font-size:0.68rem;color:var(--muted);margin-top:4px;">é‡‘åˆ©0.1%åˆ»ã¿ã§æœˆè¿”æ¸ˆé¡ãƒ»å¿…è¦å¹´åã‚’ä¸€è¦§è¡¨ç¤º</div>
    </div>
    <div style="font-size:1.2rem;color:#4a9eff;flex-shrink:0;">â†’</div>
  </a>

  <footer class="footer-links">
    <a href="https://www.jibunbank.co.jp/interest_and_commission/interest/#flg-interestHistory" target="_blank" class="external-link">
      auã˜ã¶ã‚“éŠ€è¡Œ å¤‰å‹•é‡‘åˆ©ã®åŸºæº–é‡‘åˆ© æ”¹å®šå±¥æ­´
    </a>
  </footer>

</div><!-- /main -->

<!-- Share Modal -->
<div class="share-modal-overlay" id="shareModalOverlay" onclick="if(event.target===this)closeShareModal()">
  <div class="share-modal">
    <div class="share-modal-title" id="shareModalTitle">ğŸ“¤ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’å…±æœ‰</div>
    <div class="share-preview" id="sharePreview">
      <div class="share-preview-loading" id="sharePreviewLoading">ç”»åƒã‚’ç”Ÿæˆä¸­...</div>
    </div>
    <div class="share-btns">
      <button class="share-btn webshare" id="webShareBtn" onclick="doWebShare()" style="display:none">
        ğŸ“¤ ã‚¢ãƒ—ãƒªã§å…±æœ‰
      </button>
      <button class="share-btn download" id="downloadBtn" onclick="doDownload()">
        ğŸ’¾ ç”»åƒã‚’ä¿å­˜
      </button>
      <button class="share-btn xshare" onclick="doXShare()">
        ğ• ã§ã‚·ã‚§ã‚¢
      </button>
      <button class="share-btn lineshare" onclick="doLineShare()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.105.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>
        LINEã§é€ã‚‹
      </button>
    </div>
    <button class="share-modal-close" onclick="closeShareModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- Off-screen Share Card (html2canvas render target) -->
<div id="shareCard"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// Crosshair vertical line plugin for Chart.js
const verticalLinePlugin = {
  id: 'verticalLine',
  afterDraw(chart) {
    if (chart.tooltip._active && chart.tooltip._active.length) {
      const ctx = chart.ctx;
      const x = chart.tooltip._active[0].element.x;
      const topY = chart.chartArea.top;
      const bottomY = chart.chartArea.bottom;
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(x, topY);
      ctx.lineTo(x, bottomY);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(212,180,120,0.4)';
      ctx.stroke();
      ctx.restore();
    }
  }
};
Chart.register(verticalLinePlugin);
</script>
<script>
let scheduleData = [];
let noRuleData = [];
let chartInstance = null;
let rateChanges = [];
let prepayCompareChart = null;

/* --- Core Functions --- */

// â‘¦ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒŠãƒ“ç”¨ã‚¸ãƒ£ãƒ³ãƒ—
function jumpTo(bodyId) {
  const el = document.getElementById(bodyId);
  if (el && !el.classList.contains('open')) toggleCard(bodyId);
  setTimeout(() => el.parentElement.scrollIntoView({behavior:'smooth',block:'start'}), 50);
}

// â‘° aria-expandedå¯¾å¿œ
function toggleCard(bodyId) {
  const body = document.getElementById(bodyId);
  const iconId = 'icon' + bodyId.replace('body', '');
  const icon = document.getElementById(iconId);
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (icon) icon.classList.toggle('open', !isOpen);
  const header = body.parentElement.querySelector(`[aria-controls="${bodyId}"]`);
  if (header) header.setAttribute('aria-expanded', !isOpen);
}

// â‘« saveSettingsçµ±åˆ
function saveSettings(showToast = true) {
  const data = {
    principal: document.getElementById('principal').value,
    rate: document.getElementById('rate').value,
    years: document.getElementById('years').value,
    method: document.getElementById('method').value,
    startDate: document.getElementById('startDate').value,
    useJibunRules: document.getElementById('useJibunRules').checked,
    roundingMode: document.getElementById('roundingMode').value,
    rateChanges,
    costAdmin: document.getElementById('costAdmin').value,
    costRepair: document.getElementById('costRepair').value,
    costOther: document.getElementById('costOther').value,
    saleDate: document.getElementById('saleDate').value,
    salePrice: document.getElementById('salePrice').value,
    purchasePrice: document.getElementById('purchasePrice').value,
    purchaseCost: document.getElementById('purchaseCost').value,
    use30mDeduction: document.getElementById('use30mDeduction').checked,
    use10yRate: document.getElementById('use10yRate').checked,
    buildingRatio: document.getElementById('buildingRatio').value,
    buildingType: document.getElementById('buildingType').value
  };
  localStorage.setItem('mortgage_settings_v13', JSON.stringify(data));
  if (showToast) {
    const n = document.getElementById('saveNotice');
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 2000);
  }
  return data;
}

function loadSettings() {
  const s = localStorage.getItem('mortgage_settings_v13');
  if (!s) return;
  try {
    const d = JSON.parse(s);
    if (d.principal) document.getElementById('principal').value = d.principal;
    if (d.rate) document.getElementById('rate').value = d.rate;
    if (d.years) document.getElementById('years').value = d.years;
    if (d.method) document.getElementById('method').value = d.method;
    if (d.startDate) document.getElementById('startDate').value = d.startDate;
    if (d.useJibunRules !== undefined) document.getElementById('useJibunRules').checked = d.useJibunRules;
    if (d.roundingMode) document.getElementById('roundingMode').value = d.roundingMode;
    if (d.costAdmin) document.getElementById('costAdmin').value = d.costAdmin;
    if (d.costRepair) document.getElementById('costRepair').value = d.costRepair;
    if (d.costOther) document.getElementById('costOther').value = d.costOther;
    
    if (d.saleDate) document.getElementById('saleDate').value = d.saleDate;
    if (d.salePrice) document.getElementById('salePrice').value = d.salePrice;
    if (d.purchasePrice) document.getElementById('purchasePrice').value = d.purchasePrice;
    if (d.purchaseCost) document.getElementById('purchaseCost').value = d.purchaseCost;
    if (d.use30mDeduction !== undefined) document.getElementById('use30mDeduction').checked = d.use30mDeduction;
    if (d.use10yRate !== undefined) document.getElementById('use10yRate').checked = d.use10yRate;
    if (d.buildingRatio) document.getElementById('buildingRatio').value = d.buildingRatio;
    if (d.buildingType) document.getElementById('buildingType').value = d.buildingType;

    if (d.rateChanges) { rateChanges = d.rateChanges; renderRateChanges(); }
    toggleRulesVisibility();
  } catch(e) {}
}

function toggleRulesVisibility() {
  const method = document.getElementById('method').value;
  const container = document.getElementById('ruleOptionContainer');
  if (method === 'equal_payment') {
    container.style.opacity = '1';
    container.style.pointerEvents = 'auto';
  } else {
    container.style.opacity = '0.5';
    container.style.pointerEvents = 'none';
  }
}

/* --- Rate Change UI --- */
function showRateForm() { 
  document.getElementById('rateAddForm').style.display = 'block';
  if (!document.getElementById('rcMonthDate').value) {
    document.getElementById('rcMonthDate').value = document.getElementById('startDate').value;
  }
}
function hideRateForm() { document.getElementById('rateAddForm').style.display = 'none'; }

function confirmRateChange() {
  const startDateStr = document.getElementById('startDate').value;
  const targetDateStr = document.getElementById('rcMonthDate').value;
  const rate = parseFloat(document.getElementById('rcRate').value);

  if (!startDateStr || !targetDateStr || isNaN(rate)) { alert('å¹´æœˆã¨é‡‘åˆ©ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const start = new Date(startDateStr + "-01");
  const target = new Date(targetDateStr + "-01");
  const monthDiff = (target.getFullYear() - start.getFullYear()) * 12 + (target.getMonth() - start.getMonth()) + 1;

  if (monthDiff < 1) { alert('å€Ÿå…¥é–‹å§‹æœˆã‚ˆã‚Šå‰ã®å¹´æœˆã¯æŒ‡å®šã§ãã¾ã›ã‚“'); return; }

  rateChanges = rateChanges.filter(r => r.month !== monthDiff);
  rateChanges.push({ month: monthDiff, rate: rate });
  rateChanges.sort((a, b) => a.month - b.month);
  renderRateChanges();
  hideRateForm();
  document.getElementById('rcRate').value = '';
  // è¿½åŠ å¾Œã«ä¸€è¦§ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    const list = document.getElementById('rateChangeList');
    list.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

function editRateChange(month) {
  const target = rateChanges.find(r => r.month === month);
  if (!target) return;
  const startDateStr = document.getElementById('startDate').value;
  const start = new Date(startDateStr + "-01");
  start.setMonth(start.getMonth() + target.month - 1);
  const y = start.getFullYear();
  const m = ("0" + (start.getMonth() + 1)).slice(-2);
  document.getElementById('rcMonthDate').value = `${y}-${m}`;
  document.getElementById('rcRate').value = target.rate;
  rateChanges = rateChanges.filter(r => r.month !== month);
  renderRateChanges();
  showRateForm();
}

function deleteRateChange(month) {
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  rateChanges = rateChanges.filter(r => r.month !== month);
  renderRateChanges();
}

function renderRateChanges() {
  const list = document.getElementById('rateChangeList');
  const startDateStr = document.getElementById('startDate').value;
  if (rateChanges.length === 0) { list.innerHTML = '<div class="empty-state" style="padding:10px; font-size:0.78rem;">é‡‘åˆ©å¤‰æ›´ãªã—</div>'; return; }
  
  list.innerHTML = rateChanges.map(rc => {
    const d = new Date(startDateStr + "-01");
    d.setMonth(d.getMonth() + rc.month - 1);
    const dateLabel = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
    return `<div class="rate-change-item">
      <div class="rate-item-main">
        <div class="rate-item-date">${dateLabel}ã€œ</div>
        <div class="rate-item-val">å¹´åˆ© <b>${rc.rate}%</b> ã«å¤‰æ›´</div>
      </div>
      <div class="rate-actions">
        <button class="btn-sm edit" onclick="editRateChange(${rc.month})">ä¿®æ­£</button>
        <button class="btn-sm danger" onclick="deleteRateChange(${rc.month})">å‰Šé™¤</button>
      </div>
    </div>`;
  }).join('');
}

/* --- Calculation Logic --- */
function getRateForMonth(month) {
  let rate = parseFloat(document.getElementById('rate').value);
  for (const rc of rateChanges) { if (month >= rc.month) rate = rc.rate; }
  return rate / 100 / 12;
}
function applyRounding(val) {
  const mode = document.getElementById('roundingMode').value;
  if (mode === 'floor') return Math.floor(val);
  if (mode === 'ceil') return Math.ceil(val);
  return Math.round(val);
}
function fmtShort(val) { return Math.round(val).toLocaleString('ja-JP'); }
function fmtMan(val) { return (val / 10000).toFixed(1) + 'ä¸‡å††'; }
function calculatePMT(principal, monthlyRate, numPayments) {
  if (monthlyRate === 0) return principal / numPayments;
  return principal * monthlyRate * Math.pow(1 + monthlyRate, numPayments) / (Math.pow(1 + monthlyRate, numPayments) - 1);
}

function runSimulation(P, initialYearlyRate, n, method, startDate, applyRules) {
  const resultData = [];
  let balance = P;
  const startMoment = new Date(startDate + '-01');
  let currentPayment = 0;
  const r0 = initialYearlyRate / 100 / 12;
  if (method === 'equal_payment') currentPayment = applyRounding(calculatePMT(P, r0, n));
  else currentPayment = (P / n) + (P * r0);
  let hasDeferredInterestWarning = false;
  let accruedUnpaidInterest = 0; // â‘¡ æœªæ‰•åˆ©æ¯ç´¯ç©
  const rateChangeMap = new Map(); // â‘­ MapåŒ–
  rateChanges.forEach(rc => rateChangeMap.set(rc.month, true));
  const equalPrincipalBase = method === 'equal_principal' ? Math.floor(P / n) : 0; // â‘¥

  for (let i = 1; i <= n; i++) {
    const r = getRateForMonth(i);
    let principalPart, interestPart, totalPayment;
    if (method === 'equal_principal') {
      principalPart = (i === n) ? balance : equalPrincipalBase; // â‘¥ æœ€çµ‚æœˆèª¿æ•´
      interestPart = applyRounding(balance * r);
      totalPayment = principalPart + interestPart;
    } else {
      if (applyRules) {
        if (i > 1 && (i - 1) % 60 === 0) {
          const remainingMonths = n - i + 1;
          let theoreticalPayment = calculatePMT(balance, r, remainingMonths);
          const cap = Math.floor(currentPayment * 1.25);
          if (theoreticalPayment > cap) theoreticalPayment = cap;
          currentPayment = applyRounding(theoreticalPayment);
        }
        totalPayment = currentPayment;
      } else {
        if (i === 1 || rateChangeMap.has(i)) { // â‘­
           const remainingMonths = n - i + 1;
           currentPayment = applyRounding(calculatePMT(balance, r, remainingMonths));
        }
        totalPayment = currentPayment;
      }
      interestPart = Math.floor(balance * r) + accruedUnpaidInterest; // â‘¡ æœªæ‰•åˆ©æ¯åŠ ç®—
      principalPart = totalPayment - interestPart;
      if (principalPart < 0) { // â‘¡ æœªæ‰•åˆ©æ¯ã‚’ç´¯ç©
        accruedUnpaidInterest = Math.abs(principalPart);
        principalPart = 0; interestPart = totalPayment;
        hasDeferredInterestWarning = true;
      } else { accruedUnpaidInterest = 0; }
      if (i === n) { totalPayment = balance + interestPart; principalPart = balance; }
    }
    balance = balance - principalPart;
    if (balance < 0) balance = 0;
    const d = new Date(startMoment); d.setMonth(d.getMonth() + i - 1);
    resultData.push({
      month: i, label: `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`,
      payment: totalPayment, principal: principalPart, interest: interestPart, balance: balance,
      isRateChange: rateChangeMap.has(i),
      isPaymentChange: applyRules && i > 1 && (i - 1) % 60 === 0
    });
  }
  return { data: resultData, hasWarning: hasDeferredInterestWarning };
}

function calculate(silent = false) {
  if (!silent) saveSettings(); else saveSettings(false);
  const P = parseFloat(document.getElementById('principal').value) * 10000;
  const initialYearlyRate = parseFloat(document.getElementById('rate').value);
  const n = parseInt(document.getElementById('years').value) * 12;
  const method = document.getElementById('method').value;
  const startDate = document.getElementById('startDate').value;
  const useJibunRules = document.getElementById('useJibunRules').checked && method === 'equal_payment';
  if (!P || !n || !startDate) return;

  const simResult = runSimulation(P, initialYearlyRate, n, method, startDate, useJibunRules);
  scheduleData = simResult.data;
  noRuleData = useJibunRules ? runSimulation(P, initialYearlyRate, n, method, startDate, false).data : scheduleData;

  updateStats(P, method, simResult.hasWarning);
  drawChart();
  document.getElementById('results').classList.add('visible');
  renderYearlySchedule();
  updateTodayCard();
  syncSliders();
  document.getElementById('deferredWarning').style.display = simResult.hasWarning ? 'block' : 'none';
  renderSchedule(startDate);
}

function updateStats(initialP, method, warning) {
  const totalInterest = scheduleData.reduce((s, d) => s + d.interest, 0);
  const totalPayment = scheduleData.reduce((s, d) => s + d.payment, 0);
  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let elapsedMonths = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()) + 1; 
  if (elapsedMonths < 1) elapsedMonths = 1;
  if (elapsedMonths > scheduleData.length) elapsedMonths = scheduleData.length;

  const initialRow = scheduleData[0];
  const currentRow = scheduleData[elapsedMonths - 1]; 
  const noRuleRow = noRuleData[elapsedMonths - 1];

  document.getElementById('statInitial').textContent = fmtShort(initialRow.payment);
  document.getElementById('statCurrent').textContent = fmtShort(currentRow.payment);
  document.getElementById('statTheoretical').textContent = fmtShort(noRuleRow.payment);
  
  const diff = noRuleRow.payment - currentRow.payment;
  const diffEl = document.getElementById('statTheoreticalDiff');
  if (diff > 0) diffEl.innerHTML = `<span style="color:var(--safe)">â–¼ ${diff.toLocaleString()}å†† ä½æ¸›</span><br><span style="font-size:0.6rem;">5å¹´ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚ŠæŠ‘åˆ¶ä¸­</span>`;
  else if (diff < 0) diffEl.innerHTML = `<span style="color:var(--danger)">â–² ${Math.abs(diff).toLocaleString()}å†† å¢—åŠ </span><br><span style="font-size:0.6rem;">5å¹´ãƒ«ãƒ¼ãƒ«ã§æ®ãˆç½®ãä¸­</span>`;
  else diffEl.textContent = 'ç¾åœ¨ã¨åŒé¡';

  const useJibunRules = document.getElementById('useJibunRules').checked && method === 'equal_payment';
  const nextChangeEl = document.getElementById('statNextChange');
  const nextChangeDateEl = document.getElementById('statNextChangeDate');
  
  if (useJibunRules) {
    let nextChangePayment = null;
    let nextChangeLabel = '';
    for (let i = elapsedMonths; i < scheduleData.length; i++) {
      if (scheduleData[i].isPaymentChange) {
        nextChangePayment = scheduleData[i].payment;
        nextChangeLabel = scheduleData[i].label;
        break;
      }
    }
    if (nextChangePayment !== null) {
      nextChangeEl.textContent = fmtShort(nextChangePayment);
      nextChangeDateEl.innerHTML = `${nextChangeLabel}ã€œ<br>é©ç”¨äºˆå®š`;
    } else {
      nextChangeEl.textContent = 'â€”';
      nextChangeDateEl.innerHTML = `ä»Šå¾Œã®è¦‹ç›´ã—<br>äºˆå®šãªã—`;
    }
  } else {
    nextChangeEl.textContent = 'â€”';
    nextChangeDateEl.innerHTML = `5å¹´ãƒ«ãƒ¼ãƒ«<br>éé©ç”¨`;
  }

  document.getElementById('statTotalInterest').textContent = fmtShort(totalInterest);
  document.getElementById('statTotal').textContent = fmtShort(totalPayment);
  const curBal = currentRow.balance;
  const paid = initialP - curBal;
  const pct = Math.min(100, (paid / initialP) * 100);
  document.getElementById('progressPct').textContent = pct.toFixed(1) + '%';
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('paidAmount').textContent = 'å…ƒé‡‘è¿”æ¸ˆæ¸ˆ: ' + fmtMan(paid);
  document.getElementById('remainBalance').textContent = fmtMan(curBal);
  const remainMo = Math.max(0, scheduleData.length - elapsedMonths);
  document.getElementById('remainMonths').textContent = `${Math.floor(remainMo/12)}å¹´${remainMo%12}ãƒ¶æœˆ`;

  const cAdmin = parseInt(document.getElementById('costAdmin').value) || 0;
  const cRepair = parseInt(document.getElementById('costRepair').value) || 0;
  const cOther = parseInt(document.getElementById('costOther').value) || 0;
  const runCost = cAdmin + cRepair + cOther;
  const loanCost = currentRow.payment;
  const totalCost = loanCost + runCost;
  
  document.getElementById('totalMonthlyCost').textContent = fmtShort(totalCost) + 'å††';
  document.getElementById('detailLoan').textContent = fmtShort(loanCost);
  document.getElementById('detailRun').textContent = fmtShort(runCost);
}

function renderSchedule(startDateStr) {
  const tbody = document.getElementById('scheduleBody');
  tbody.innerHTML = '';
  const today = new Date();
  const startMoment = new Date(startDateStr + '-01');
  const currentMonthIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());
  scheduleData.forEach((row, idx) => {
    const tr = document.createElement('tr');
    if (idx === currentMonthIdx) tr.classList.add('highlight');
    if (row.isRateChange) tr.classList.add('rate-change');
    if (row.isPaymentChange) tr.classList.add('payment-change');
    let badges = '';
    if (idx === currentMonthIdx) badges += '<span style="color:var(--accent)">â—€ ä»Šæœˆ</span>';
    if (row.isRateChange) badges += (badges ? ' ' : '') + '<span class="badge-warn">é‡‘åˆ©å¤‰æ›´</span>';
    if (row.isPaymentChange) badges += (badges ? ' ' : '') + '<span class="badge-rule">5å¹´ãƒ«ãƒ¼ãƒ«</span>';
    const labelCell = badges ? `${row.label}<br><span style="display:block; margin-top:2px; white-space:normal;">${badges}</span>` : row.label;
    tr.innerHTML = `<td>${labelCell}</td><td>${fmtShort(row.payment)}</td><td>${fmtShort(row.principal)}</td><td>${fmtShort(row.interest)}</td><td>${fmtShort(row.balance)}</td>`;
    tbody.appendChild(tr);
  });
}

function drawChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  const yearlyData = [];
  let tempP = 0, tempI = 0, currentYear = '';
  scheduleData.forEach((row) => {
    const year = row.label.split('å¹´')[0];
    if (currentYear !== year && currentYear !== '') { yearlyData.push({ year: currentYear, principal: tempP, interest: tempI }); tempP = 0; tempI = 0; }
    currentYear = year; tempP += row.principal; tempI += row.interest;
  });
  yearlyData.push({ year: currentYear, principal: tempP, interest: tempI });
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: yearlyData.map(d => d.year),
      datasets: [ { label: 'å…ƒé‡‘', data: yearlyData.map(d => d.principal / 10000), backgroundColor: '#c8a96e', stack: 'S'}, { label: 'åˆ©æ¯', data: yearlyData.map(d => d.interest / 10000), backgroundColor: '#c4715a', stack: 'S'} ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { stacked: true, ticks: { color: '#b0a898', font: { size: 9 } }, grid: { color: '#2e2c28' } },
        y: { stacked: true, ticks: { color: '#b0a898', font: { size: 9 }, callback: v => v + 'ä¸‡å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}

let balanceChartInstance = null;
let cumulativeChartInstance = null;

/* â”€â”€ æ®‹é«˜æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ â”€â”€ */
function drawBalanceChart() {
  const ctx = document.getElementById('balanceChart').getContext('2d');
  if (balanceChartInstance) balanceChartInstance.destroy();

  const initialP = scheduleData[0].balance + scheduleData[0].principal;
  const startYear = parseInt(scheduleData[0].label.split('å¹´')[0]);
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  const today = new Date();
  const currentMonthIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());

  const labels = [startYear + 'å¹´'];
  const balData = [Math.round(initialP / 10000)];
  const paidData = [0];
  let lastYear = startYear;

  scheduleData.forEach((row, idx) => {
    const year = parseInt(row.label.split('å¹´')[0]);
    const isLast = idx === scheduleData.length - 1;
    if ((row.label.includes('12æœˆ') && year !== startYear) || isLast) {
      if (year !== lastYear || isLast) {
        labels.push(isLast && !row.label.includes('12æœˆ') ? year + 'å¹´(å®Œæ¸ˆ)' : year + 'å¹´');
        balData.push(Math.round(row.balance / 10000));
        paidData.push(Math.round((initialP - row.balance) / 10000));
        lastYear = year;
      }
    }
  });

  const currentYearStr = currentMonthIdx >= 0 && currentMonthIdx < scheduleData.length
    ? parseInt(scheduleData[currentMonthIdx].label.split('å¹´')[0]) + 'å¹´' : null;
  const nowIdx = labels.indexOf(currentYearStr);

  balanceChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'ãƒ­ãƒ¼ãƒ³æ®‹é«˜',
          data: balData,
          borderColor: '#5a8bc4',
          backgroundColor: 'rgba(90,139,196,0.12)',
          fill: true, tension: 0.3,
          pointRadius: balData.map((_, i) => i === nowIdx ? 7 : 2),
          pointBackgroundColor: balData.map((_, i) => i === nowIdx ? '#e8c98a' : '#5a8bc4'),
          order: 1
        },
        {
          label: 'è¿”æ¸ˆæ¸ˆã¿å…ƒé‡‘',
          data: paidData,
          borderColor: '#c8a96e',
          backgroundColor: 'rgba(200,169,110,0.08)',
          fill: true, tension: 0.3,
          pointRadius: 2, borderDash: [4, 3],
          order: 2
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toLocaleString('ja-JP') + 'ä¸‡å††' } },
        annotation: nowIdx >= 0 ? { annotations: { nowLine: {
          type: 'line', xMin: nowIdx, xMax: nowIdx,
          borderColor: 'rgba(232,201,138,0.6)', borderWidth: 1.5, borderDash: [4, 3],
          label: { content: 'ç¾åœ¨', display: true, position: 'start', color: '#e8c98a', font: { size: 10 }, backgroundColor: 'rgba(200,169,110,0.15)' }
        }}} : {}
      },
      scales: {
        x: { ticks: { color: '#b0a898', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#2e2c28' } },
        y: { ticks: { color: '#b0a898', font: { size: 10 }, callback: v => v + 'ä¸‡å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}

/* â”€â”€ ç´¯è¨ˆã‚³ã‚¹ãƒˆã‚°ãƒ©ãƒ• â”€â”€ */
function drawCumulativeChart() {
  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  if (cumulativeChartInstance) cumulativeChartInstance.destroy();
  const cAdmin = parseInt(document.getElementById('costAdmin').value) || 0;
  const cRepair = parseInt(document.getElementById('costRepair').value) || 0;
  const cOther = parseInt(document.getElementById('costOther').value) || 0;
  const runMonthly = cAdmin + cRepair + cOther;
  const startDate = document.getElementById('startDate').value;
  const startMoment = new Date(startDate + '-01');
  const today = new Date();
  const currentMonthIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());

  const labels = [], loanCum = [], totalCum = [];
  let loanSum = 0, totalSum = 0;
  const startYear = parseInt(scheduleData[0].label.split('å¹´')[0]);
  labels.push(startYear + 'å¹´'); loanCum.push(0); totalCum.push(0);
  let lastYear = startYear, tempLoan = 0, tempTotal = 0;
  scheduleData.forEach((row, idx) => {
    const year = parseInt(row.label.split('å¹´')[0]);
    const isLast = idx === scheduleData.length - 1;
    tempLoan += row.payment; tempTotal += row.payment + runMonthly;
    if ((row.label.includes('12æœˆ') && year !== startYear) || isLast) {
      if (year !== lastYear || isLast) {
        loanSum += tempLoan; totalSum += tempTotal;
        labels.push(isLast && !row.label.includes('12æœˆ') ? year + 'å¹´(å®Œæ¸ˆ)' : year + 'å¹´');
        loanCum.push(Math.round(loanSum / 10000));
        totalCum.push(Math.round(totalSum / 10000));
        tempLoan = 0; tempTotal = 0; lastYear = year;
      }
    }
  });

  const nowYearLabel = currentMonthIdx >= 0 && currentMonthIdx < scheduleData.length
    ? parseInt(scheduleData[currentMonthIdx].label.split('å¹´')[0]) + 'å¹´' : null;
  const nowIdx = labels.indexOf(nowYearLabel);

  cumulativeChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'ä½å±…è²»ç´¯è¨ˆ', data: totalCum, borderColor: '#5a8bc4', backgroundColor: 'rgba(90,139,196,0.1)', fill: true, tension: 0.3, pointRadius: 2 },
        { label: 'ãƒ­ãƒ¼ãƒ³ç´¯è¨ˆ', data: loanCum, borderColor: '#c4715a', backgroundColor: 'rgba(196,113,90,0.08)', fill: true, tension: 0.3, pointRadius: 2, borderDash: [4,3] }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toLocaleString() + 'ä¸‡å††' } },
        annotation: nowIdx >= 0 ? {
          annotations: { nowLine: { type: 'line', xMin: nowIdx, xMax: nowIdx, borderColor: 'rgba(232,201,138,0.6)', borderWidth: 1.5, borderDash: [4,3], label: { content: 'ç¾åœ¨', display: true, position: 'start', color: '#e8c98a', font: { size: 10 }, backgroundColor: 'rgba(200,169,110,0.15)' } } }
        } : {}
      },
      scales: {
        x: { ticks: { color: '#b0a898', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#2e2c28' } },
        y: { ticks: { color: '#b0a898', font: { size: 10 }, callback: v => v + 'ä¸‡å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}

function switchTab(name) {
  ['schedule','graph','balance','cumulative'].forEach(t => document.getElementById('tab-'+t).style.display = t === name ? '' : 'none');
  document.querySelectorAll('.tab').forEach((el, i) => el.classList.toggle('active', ['schedule','graph','balance','cumulative'][i] === name));
  if (name === 'balance' && scheduleData.length > 0) drawBalanceChart();
  if (name === 'cumulative' && scheduleData.length > 0) drawCumulativeChart();
}
function switchTool(name) {
  ['tax','data'].forEach(t => document.getElementById('tool-'+t).classList.remove('active'));
  document.getElementById('tool-'+name).classList.add('active');
  document.querySelectorAll('.tools-tab').forEach((el, i) => el.classList.toggle('active', ['tax','data'][i] === name));
}

/* â”€â”€ ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â”€â”€ */
let prepayType = 'shorten';
function setPrepayType(type) {
  prepayType = type;
  document.getElementById('prepayTypeShorten').classList.toggle('active', type === 'shorten');
  document.getElementById('prepayTypeReduce').classList.toggle('active', type === 'reduce');
}

function calcPrepayment() {
  const amountEl = document.getElementById('prepayAmount');
  const errEl = document.getElementById('prepayAmountErr');
  const amount = parseFloat(amountEl.value) * 10000;
  if (!amount || amount <= 0) { amountEl.classList.add('input-error'); errEl.classList.add('show'); return; }
  amountEl.classList.remove('input-error'); errEl.classList.remove('show');
  if (scheduleData.length === 0) return;

  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  const timing = parseInt(document.getElementById('prepayTiming').value) || 0;
  let applyIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()) + timing;
  applyIdx = Math.max(0, Math.min(applyIdx, scheduleData.length - 1));

  const balBefore = applyIdx === 0 ? (parseFloat(document.getElementById('principal').value) * 10000) : scheduleData[applyIdx - 1].balance;
  // â‘¨ æ®‹é«˜è¶…éãƒã‚§ãƒƒã‚¯
  let actualAmount = amount, fullPayoffNote = '';
  if (amount >= balBefore) { actualAmount = balBefore; fullPayoffNote = 'â€»æ®‹é«˜ã‚’è¶…ãˆã‚‹é‡‘é¡ã®ãŸã‚ã€å…¨é¡ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã¨ã—ã¦è¨ˆç®—ã—ã¾ã—ãŸã€‚'; }
  const balAfter = Math.max(0, balBefore - actualAmount);
  const remainMonths = scheduleData.length - applyIdx;

  let oldInterest = 0;
  for (let i = applyIdx; i < scheduleData.length; i++) oldInterest += scheduleData[i].interest;

  // â‘¢ é‡‘åˆ©å¤‰å‹•å¯¾å¿œã®ç¹°ã‚Šä¸Šã’å¾Œæ®‹é«˜æ¨ç§»ã‚’è¨˜éŒ²(C: ãƒãƒ£ãƒ¼ãƒˆç”¨)
  let newBalSchedule = [];

  if (prepayType === 'shorten') {
    const origPayment = scheduleData[applyIdx].payment;
    let bal = balAfter, newMonths = 0, newInterest = 0;
    while (bal > 0 && newMonths < 9999) {
      const mIdx = applyIdx + newMonths + 1;
      const rr = getRateForMonth(mIdx); // â‘¢ é‡‘åˆ©å¤‰å‹•å¯¾å¿œ
      const interest = Math.floor(bal * rr);
      const principal = Math.min(origPayment - interest, bal);
      if (principal <= 0) break;
      newInterest += interest; bal -= principal; newMonths++;
      if (newMonths % 12 === 0 || bal <= 0) newBalSchedule.push({month: mIdx, balance: bal});
    }
    const shortened = remainMonths - newMonths;
    const savedInterest = oldInterest - newInterest;
    document.getElementById('prepayMainLabel').textContent = 'â± æœŸé–“çŸ­ç¸®';
    document.getElementById('prepayMainVal').textContent = shortened > 0 ? `${Math.floor(shortened/12)}å¹´${shortened%12}ãƒ¶æœˆçŸ­ç¸®` : 'å¤‰åŒ–ãªã—';
    document.getElementById('prepayInterestSaved').textContent = fmtShort(savedInterest) + 'å††';
    document.getElementById('prepayOldInterest').textContent = fmtShort(oldInterest) + 'å††';
    document.getElementById('prepayNewInterest').textContent = fmtShort(newInterest) + 'å††';
  } else {
    // â‘£ æœˆæ¬¡ãƒ«ãƒ¼ãƒ—ã§æ­£ç¢ºã«è¨ˆç®—
    const r0 = getRateForMonth(applyIdx + 1);
    const newPayment = r0 > 0 ? Math.floor(balAfter * r0 * Math.pow(1+r0, remainMonths) / (Math.pow(1+r0, remainMonths) - 1)) : Math.floor(balAfter / remainMonths);
    let bal = balAfter, newInterest = 0;
    for (let mm = 0; mm < remainMonths && bal > 0; mm++) {
      const rr = getRateForMonth(applyIdx + mm + 1);
      const interest = Math.floor(bal * rr);
      const principal = (mm === remainMonths - 1) ? bal : Math.min(newPayment - interest, bal);
      newInterest += interest; bal -= principal;
      if ((mm + 1) % 12 === 0 || bal <= 0) newBalSchedule.push({month: applyIdx + mm + 1, balance: bal});
    }
    const savedInterest = oldInterest - newInterest;
    const origPayment = scheduleData[applyIdx].payment;
    document.getElementById('prepayMainLabel').textContent = 'ğŸ’´ æœˆè¿”æ¸ˆé¡è»½æ¸›';
    document.getElementById('prepayMainVal').textContent = `${fmtShort(origPayment - newPayment)}å††/æœˆ æ¸›å°‘`;
    document.getElementById('prepayInterestSaved').textContent = fmtShort(Math.max(0, savedInterest)) + 'å††';
    document.getElementById('prepayOldInterest').textContent = fmtShort(oldInterest) + 'å††';
    document.getElementById('prepayNewInterest').textContent = fmtShort(Math.max(0, newInterest)) + 'å††';
  }
  document.getElementById('prepayResult').style.display = 'block';
  const noteEl = document.getElementById('prepayFullPayoffNote');
  if (noteEl) { noteEl.textContent = fullPayoffNote; noteEl.style.display = fullPayoffNote ? 'block' : 'none'; }

  // C: ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæç”»
  drawPrepayCompareChart(applyIdx, newBalSchedule);
}

function drawPrepayCompareChart(applyIdx, newBalSchedule) {
  const wrap = document.getElementById('prepayChartWrap');
  const ctx = document.getElementById('prepayCompareChart').getContext('2d');
  if (prepayCompareChart) prepayCompareChart.destroy();
  if (!newBalSchedule.length) { wrap.style.display='none'; return; }
  wrap.style.display='block';
  // å¹´æ¬¡ã®å…ƒãƒ‡ãƒ¼ã‚¿
  const labels = [], oldBal = [], newBal = [];
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let ni = 0;
  for (let i = 11; i < scheduleData.length; i += 12) {
    const d = new Date(startMoment); d.setMonth(d.getMonth() + i);
    labels.push(d.getFullYear() + 'å¹´');
    oldBal.push(Math.round(scheduleData[i].balance / 10000));
    // å¯¾å¿œã™ã‚‹ç¹°ã‚Šä¸Šã’å¾Œãƒ‡ãƒ¼ã‚¿
    while (ni < newBalSchedule.length - 1 && newBalSchedule[ni + 1].month <= i + 1) ni++;
    if (ni < newBalSchedule.length && newBalSchedule[ni].month <= i + 1) newBal.push(Math.round(newBalSchedule[ni].balance / 10000));
    else if (i + 1 <= applyIdx) newBal.push(Math.round(scheduleData[i].balance / 10000));
    else newBal.push(0);
  }
  prepayCompareChart = new Chart(ctx, {
    type:'line', data: {
      labels,
      datasets: [
        { label:'ç¹°ã‚Šä¸Šã’å‰', data:oldBal, borderColor:'#c4715a', backgroundColor:'rgba(196,113,90,0.1)', fill:true, tension:0.3, pointRadius:0, borderWidth:2 },
        { label:'ç¹°ã‚Šä¸Šã’å¾Œ', data:newBal, borderColor:'#6ec496', backgroundColor:'rgba(110,196,150,0.1)', fill:true, tension:0.3, pointRadius:0, borderWidth:2 }
      ]
    },
    options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false} },
      scales:{ x:{ticks:{color:'#9a9488',font:{size:8},maxRotation:45},grid:{color:'#2e2c28'}}, y:{ticks:{color:'#9a9488',font:{size:8},callback:v=>v+'ä¸‡'},grid:{color:'#2e2c28'}} } }
  });
}

/* â”€â”€ å…±æœ‰ãƒªãƒ³ã‚¯ â”€â”€ */
function copyShareLink() {
  const d = {
    principal: document.getElementById('principal').value,
    rate: document.getElementById('rate').value,
    years: document.getElementById('years').value,
    method: document.getElementById('method').value,
    startDate: document.getElementById('startDate').value,
    useJibunRules: document.getElementById('useJibunRules').checked ? '1' : '0',
    roundingMode: document.getElementById('roundingMode').value,
    costAdmin: document.getElementById('costAdmin').value,
    costRepair: document.getElementById('costRepair').value,
    costOther: document.getElementById('costOther').value,
    saleDate: document.getElementById('saleDate').value,
    salePrice: document.getElementById('salePrice').value,
    purchasePrice: document.getElementById('purchasePrice').value,
    purchaseCost: document.getElementById('purchaseCost').value,
    use30m: document.getElementById('use30mDeduction').checked ? '1' : '0',
    use10y: document.getElementById('use10yRate').checked ? '1' : '0'
  };
  const params = new URLSearchParams(d).toString();
  const url = location.href.split('?')[0] + '?' + params;
  navigator.clipboard.writeText(url).then(() => {
    const n = document.getElementById('shareNotice');
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 2500);
  }).catch(() => {
    prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
  });
}

function loadFromURL() {
  const params = new URLSearchParams(location.search);
  if (!params.has('principal')) return;
  const ids = ['principal','rate','years','method','startDate','roundingMode','costAdmin','costRepair','costOther','saleDate','salePrice','purchasePrice','purchaseCost'];
  ids.forEach(id => { if (params.has(id)) document.getElementById(id).value = params.get(id); });
  if (params.has('useJibunRules')) document.getElementById('useJibunRules').checked = params.get('useJibunRules') === '1';
  if (params.has('use30m')) document.getElementById('use30mDeduction').checked = params.get('use30m') === '1';
  if (params.has('use10y')) document.getElementById('use10yRate').checked = params.get('use10y') === '1';
  if (params.has('buildingRatio')) document.getElementById('buildingRatio').value = params.get('buildingRatio');
  if (params.has('buildingType')) document.getElementById('buildingType').value = params.get('buildingType');
  toggleRulesVisibility();
}

/* --- ä¾¿åˆ©ãƒ„ãƒ¼ãƒ« --- */
function calcTaxDeduction() {
  if (scheduleData.length === 0) { alert('å…ˆã«ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const period = parseInt(document.getElementById('taxPeriod').value);
  const rate = parseFloat(document.getElementById('taxRate').value) / 100;
  const limit = parseInt(document.getElementById('taxLimit').value) * 10000;
  // å€Ÿå…¥é–‹å§‹å¹´ã‚’å–å¾—
  const startYear = parseInt(scheduleData[0].label.split('å¹´')[0]);
  let totalDeduction = 0;
  for (let i = 1; i <= period; i++) {
    const targetYear = startYear + i - 1;
    // ãã®å¹´ã®12æœˆæœ«ã®è¡Œã‚’æ¤œç´¢
    const targetRow = scheduleData.find(row => row.label === `${targetYear}å¹´12æœˆ`);
    if (targetRow) {
      const deduct = Math.min(targetRow.balance, limit) * rate;
      totalDeduction += Math.floor(deduct);
    }
  }
  document.getElementById('taxTotalVal').textContent = Math.round(totalDeduction).toLocaleString() + 'å††';
  document.getElementById('taxResult').style.display = 'block';
}

function calcRefinance() {
  if (scheduleData.length === 0) { alert('å…ˆã«ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let elapsedMonths = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()) + 1;
  if (elapsedMonths < 1) elapsedMonths = 1;
  if (elapsedMonths > scheduleData.length) elapsedMonths = scheduleData.length;
  const currentRow = scheduleData[elapsedMonths - 1];
  const currentBalance = currentRow.balance;
  const remainMonths = scheduleData.length - elapsedMonths + 1; // ç¾åœ¨æœˆã‚’å«ã‚€æ®‹ã‚Šè¿”æ¸ˆå›æ•°
  let oldTotalRemaining = 0;
  let oldTotalInterest = 0;
  // ç¾åœ¨æœˆï¼ˆelapsedMonths-1ï¼‰ã‚’å«ã‚ãŸæ®‹ã‚Šå…¨é¡ã‚’é›†è¨ˆ
  for (let i = elapsedMonths - 1; i < scheduleData.length; i++) {
    oldTotalRemaining += scheduleData[i].payment;
    oldTotalInterest += scheduleData[i].interest;
  }
  const newRate = parseFloat(document.getElementById('refiRate').value) / 100 / 12;
  const feeRate = parseFloat(document.getElementById('refiFeeRate').value) / 100;
  const fixCost = parseFloat(document.getElementById('refiFixCost').value) * 10000;
  const adminFee = Math.floor(currentBalance * feeRate);
  const initialCost = adminFee + fixCost;
  const newPayment = Math.round(currentBalance * newRate * Math.pow(1 + newRate, remainMonths) / (Math.pow(1 + newRate, remainMonths) - 1));
  const newLoanTotal = newPayment * remainMonths;
  const newTotalPayment = newLoanTotal + initialCost;
  const diff = oldTotalRemaining - newTotalPayment;
  document.getElementById('refiOldTotal').textContent = fmtShort(oldTotalRemaining) + 'å††';
  document.getElementById('refiOldPrincipal').textContent = fmtShort(currentBalance) + 'å††';
  document.getElementById('refiOldInterest').textContent = fmtShort(oldTotalInterest) + 'å††';
  document.getElementById('refiNewTotal').textContent = fmtShort(newTotalPayment) + 'å††';
  document.getElementById('refiNewLoan').textContent = fmtShort(newLoanTotal) + 'å††';
  document.getElementById('refiCost').textContent = fmtShort(initialCost) + 'å††';
  const diffEl = document.getElementById('refiDiffVal');
  if (diff > 0) {
    diffEl.textContent = '+' + fmtShort(diff) + 'å†† (ãŠå¾—)';
    diffEl.className = 'tool-summary-val refi-diff plus';
  } else {
    diffEl.textContent = fmtShort(diff) + 'å†† (æ)';
    diffEl.className = 'tool-summary-val refi-diff minus';
  }
  document.getElementById('refiResult').style.display = 'block';
  updateRefiAdvice();
}

function exportData() {
  const settings = saveSettings();
  const data = { settings };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const today = new Date();
  const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
  a.download = `ä½å®…ãƒ­ãƒ¼ãƒ³è¨­å®š_${dateStr}.json`;
  a.click();
}

function exportCSV() {
  if (!scheduleData || scheduleData.length === 0) { alert('å…ˆã«è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
  let csvContent = "å®Ÿè¡Œå¹´æœˆ,ãŠæ”¯æ‰•é¡,å…ƒé‡‘åˆ†,åˆ©æ¯åˆ†,å€Ÿå…¥æ®‹é«˜\n";
  scheduleData.forEach(row => {
    csvContent += `${row.label},${row.payment},${row.principal},${row.interest},${row.balance}\n`;
  });
  const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  const today = new Date();
  const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
  link.setAttribute("href", url);
  link.setAttribute("download", `ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆä¸€è¦§_${dateStr}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.settings) localStorage.setItem('mortgage_settings_v13', JSON.stringify(data.settings));
      alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚ç”»é¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚');
      location.reload();
    } catch(err) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
  };
  reader.readAsText(file);
}

/* â”€â”€ ã‚·ãƒŠãƒªã‚ªä¿å­˜ãƒ»æ¯”è¼ƒ â”€â”€ */
let scenarios = JSON.parse(localStorage.getItem('mortgage_scenarios') || '[]');

function saveScenario() {
  const name = document.getElementById('scenarioName').value.trim();
  if (!name) { alert('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (scheduleData.length === 0) { alert('å…ˆã«è¨ˆç®—ã—ã¦ãã ã•ã„'); return; }
  const totalInterest = scheduleData.reduce((s, d) => s + d.interest, 0);
  const totalPayment = scheduleData.reduce((s, d) => s + d.payment, 0);
  const scenario = {
    id: Date.now(),
    name,
    principal: document.getElementById('principal').value,
    rate: document.getElementById('rate').value,
    years: document.getElementById('years').value,
    method: document.getElementById('method').value,
    totalInterest,
    totalPayment,
    initialPayment: scheduleData[0].payment,
    savedAt: new Date().toLocaleDateString('ja-JP')
  };
  scenarios = scenarios.filter(s => s.name !== name); // åŒåã¯ä¸Šæ›¸ã
  scenarios.push(scenario);
  if (scenarios.length > 6) scenarios.shift(); // æœ€å¤§6ä»¶
  localStorage.setItem('mortgage_scenarios', JSON.stringify(scenarios));
  document.getElementById('scenarioName').value = '';
  renderScenarios();
}

function deleteScenario(id) {
  scenarios = scenarios.filter(s => s.id !== id);
  localStorage.setItem('mortgage_scenarios', JSON.stringify(scenarios));
  renderScenarios();
}

function loadScenario(id) {
  const s = scenarios.find(sc => sc.id === id);
  if (!s) return;
  document.getElementById('principal').value = s.principal;
  document.getElementById('rate').value = s.rate;
  document.getElementById('years').value = s.years;
  document.getElementById('method').value = s.method;
  toggleRulesVisibility();
  calculate();
  // ãƒ­ãƒ¼ãƒ³æƒ…å ±ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã
  const body = document.getElementById('bodyLoan');
  if (!body.classList.contains('open')) toggleCard('bodyLoan');
}

function renderScenarios() {
  const list = document.getElementById('scenarioList');
  if (!list) return;
  if (scenarios.length === 0) {
    list.innerHTML = '<div style="font-size:0.72rem;color:var(--muted);text-align:center;padding:12px;">ä¿å­˜ã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  const methodLabel = m => m === 'equal_payment' ? 'å…ƒåˆ©å‡ç­‰' : 'å…ƒé‡‘å‡ç­‰';
  list.innerHTML = scenarios.map(s => `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <span style="font-size:0.75rem;font-weight:700;color:var(--accent2);">${s.name}</span>
        <div style="display:flex;gap:6px;">
          <button onclick="loadScenario(${s.id})" style="background:var(--surface3);border:1px solid var(--border2);border-radius:4px;padding:3px 8px;color:var(--text2);font-size:0.65rem;cursor:pointer;">é©ç”¨</button>
          <button onclick="deleteScenario(${s.id})" style="background:transparent;border:1px solid rgba(224,120,104,0.4);border-radius:4px;padding:3px 8px;color:var(--danger);font-size:0.65rem;cursor:pointer;">å‰Šé™¤</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:0.65rem;color:var(--muted);">
        <span>å€Ÿå…¥: ${Number(s.principal).toLocaleString()}ä¸‡å†† / ${s.rate}% / ${s.years}å¹´</span>
        <span>${methodLabel(s.method)}</span>
        <span>ç·åˆ©æ¯: <span style="color:var(--danger);font-family:'DM Mono',monospace;">${fmtShort(s.totalInterest)}å††</span></span>
        <span>ç·æ”¯æ‰•: <span style="color:var(--text);font-family:'DM Mono',monospace;">${fmtShort(s.totalPayment)}å††</span></span>
      </div>
      <div style="font-size:0.6rem;color:var(--muted);margin-top:5px;text-align:right;">${s.savedAt}</div>
    </div>
  `).join('');
}

/* â”€â”€ è‡ªå‹•è¨ˆç®— â”€â”€ */
let _autoCalcTimer = null;
function scheduleAutoCalc() {
  clearTimeout(_autoCalcTimer);
  _autoCalcTimer = setTimeout(() => {
    if (document.getElementById('principal').value && document.getElementById('years').value) {
      calculate(true); // silent: ãƒˆãƒ¼ã‚¹ãƒˆéè¡¨ç¤º
    }
  }, 600);
}

// å…¥åŠ›å¤‰æ›´æ™‚ã«è‡ªå‹•è¨ˆç®—
document.addEventListener('DOMContentLoaded', () => {
  ['principal','rate','years','method','startDate','roundingMode',
   'useJibunRules','costAdmin','costRepair','costOther'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', scheduleAutoCalc);
  });
  // F: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åŒæœŸ
  ['principalSlider','rateSlider','yearsSlider'].forEach(sid => {
    const sl = document.getElementById(sid);
    if (sl) sl.addEventListener('input', () => {
      const target = sid.replace('Slider','');
      document.getElementById(target).value = sl.value;
      scheduleAutoCalc();
    });
  });
  ['principal','rate','years'].forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
      const sl = document.getElementById(id + 'Slider');
      if (sl) sl.value = document.getElementById(id).value;
    });
  });
  // â‘© ã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‡ªå‹•è¨ˆç®—
  ['prepayAmount','prepayTiming'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => { if (scheduleData.length > 0 && document.getElementById('prepayAmount').value) calcPrepayment(); });
  });
  ['refiRate','refiFeeRate','refiFixCost'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => { if (scheduleData.length > 0) { calcRefinance(); updateRefiAdvice(); } });
  });
  ['saleDate','salePrice','purchasePrice','purchaseCost','use30mDeduction','use10yRate','buildingRatio','buildingType'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => { if (scheduleData.length > 0 && document.getElementById('saleResult')?.style.display !== 'none') calcSale(); });
  });
  // å»ºç‰©æ§‹é€ å¤‰æ›´æ™‚ã«è€ç”¨å¹´æ•°è¡¨ç¤ºã‚’æ›´æ–°
  const btEl = document.getElementById('buildingType');
  if (btEl) btEl.addEventListener('change', updateDepreciationInfo);
  const brEl = document.getElementById('buildingRatio');
  if (brEl) brEl.addEventListener('change', updateDepreciationInfo);
  renderScenarios();
});

function getDepreciationRate(type) {
  // éäº‹æ¥­ç”¨ï¼ˆå±…ä½ç”¨ï¼‰ã®è€ç”¨å¹´æ•°Ã—1.5 â†’ å„Ÿå´ç‡
  const map = { rc: {years:70, rate:0.015}, steel: {years:51, rate:0.020}, light_steel: {years:40, rate:0.025}, wood: {years:33, rate:0.031} };
  return map[type] || map.rc;
}
function updateDepreciationInfo() {
  const type = document.getElementById('buildingType').value;
  const info = getDepreciationRate(type);
  const labels = {rc:'RCé€ ',steel:'é‡é‡é‰„éª¨é€ ',light_steel:'è»½é‡é‰„éª¨é€ ',wood:'æœ¨é€ '};
  const usefulYears = {rc:47, steel:34, light_steel:27, wood:22};
  document.getElementById('depreciationInfo').textContent = `${labels[type]} ${usefulYears[type]}å¹´ â†’ éäº‹æ¥­ç”¨${Math.round(usefulYears[type]*1.5)}å¹´ â†’ å„Ÿå´ç‡ ${info.rate.toFixed(3)}`;
}

/* --- å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ --- */
let breakevenChartInstance = null;

// å¹´ã”ã¨ã®ç¨é¡ã‚’æ­£ç¢ºã«è¨ˆç®—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
function calcTaxForYear(sPrice, pPrice, pCost, sCost, taxHoldYrs, use30m, use10y) {
  const capitalGain = sPrice - (pPrice + pCost) - sCost;
  if (capitalGain <= 0) return 0;
  let taxableGain = capitalGain;
  if (use30m) taxableGain = Math.max(0, taxableGain - 30000000);
  if (taxableGain <= 0) return 0;
  let tax = 0;
  if (taxHoldYrs > 10 && use10y) {
    if (taxableGain <= 60000000) tax = taxableGain * 0.1421;
    else tax = (60000000 * 0.1421) + ((taxableGain - 60000000) * 0.20315);
  } else if (taxHoldYrs > 5) {
    tax = taxableGain * 0.20315;
  } else {
    tax = taxableGain * 0.3963;
  }
  return Math.floor(tax);
}

function drawBreakevenChart(sPrice, sCost, pPrice, pCost, use30m, use10y, startMoment, buildingRatio, depInfo, landCost) {
  const ctx = document.getElementById('breakevenChart').getContext('2d');
  if (breakevenChartInstance) breakevenChartInstance.destroy();

  const startYear = parseInt(scheduleData[0].label.split('å¹´')[0]);
  const labels = [];
  const netData = [];
  const taxLabels = [];
  let lastYear = startYear - 1;

  scheduleData.forEach((row, idx) => {
    const year = parseInt(row.label.split('å¹´')[0]);
    const isLast = idx === scheduleData.length - 1;
    if ((row.label.includes('12æœˆ') || isLast) && year !== lastYear) {
      const bal = idx === 0
        ? parseFloat(document.getElementById('principal').value) * 10000
        : scheduleData[idx - 1].balance;
      const holdingYears = year - 1 - startMoment.getFullYear();
      const yrsHeld = year - startMoment.getFullYear();
      const buildCost = pPrice * (buildingRatio || 0);
      const depAmt = Math.floor(buildCost * (depInfo ? depInfo.rate : 0) * yrsHeld);
      const adjBuild = Math.max(buildCost * 0.05, buildCost - depAmt);
      const acqCost = Math.floor((landCost || pPrice) + (buildingRatio > 0 ? adjBuild - (pPrice - buildCost) : 0) + pCost);
      const taxY = calcTaxForYear(sPrice, acqCost, 0, sCost, holdingYears, use30m, use10y);
      const net = sPrice - bal - sCost - taxY;
      labels.push(year + 'å¹´');
      netData.push(Math.round(net / 10000));
      // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã®ç¨åŒºåˆ†ãƒ©ãƒ™ãƒ«
      if (holdingYears > 10 && use10y) taxLabels.push('è»½æ¸›ç¨ç‡');
      else if (holdingYears > 5) taxLabels.push('é•·æœŸè­²æ¸¡');
      else taxLabels.push('çŸ­æœŸè­²æ¸¡');
      lastYear = year;
    }
  });

  const colors = netData.map(v => v >= 0 ? 'rgba(106,170,142,0.75)' : 'rgba(196,113,90,0.75)');
  const borderColors = netData.map(v => v >= 0 ? '#6aaa8e' : '#c4715a');

  breakevenChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'å£²å´æ‰‹å–ã‚Šé¡',
        data: netData,
        backgroundColor: colors,
        borderColor: borderColors,
        borderWidth: 1,
        borderRadius: 3
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index', intersect: false,
          callbacks: {
            label: c => (c.parsed.y >= 0 ? '+' : '') + c.parsed.y.toLocaleString() + 'ä¸‡å††',
            afterLabel: c => 'ç¨åŒºåˆ†: ' + taxLabels[c.dataIndex]
          }
        },
        annotation: {
          annotations: {
            zeroLine: { type: 'line', yMin: 0, yMax: 0, borderColor: 'rgba(232,201,138,0.8)', borderWidth: 1.5 }
          }
        }
      },
      scales: {
        x: { ticks: { color: '#b0a898', font: { size: 9 }, maxRotation: 45 }, grid: { color: '#2e2c28' } },
        y: { ticks: { color: '#b0a898', font: { size: 9 }, callback: v => v + 'ä¸‡å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}


function calcSale() {
  if (scheduleData.length === 0) { alert('å…ˆã«ä¸Šéƒ¨ã®ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  saveSettings();
  const saleDateStr = document.getElementById('saleDate').value;
  const sPrice = (parseFloat(document.getElementById('salePrice').value) || 0) * 10000;
  const pPrice = (parseFloat(document.getElementById('purchasePrice').value) || 0) * 10000;
  const pCost = (parseFloat(document.getElementById('purchaseCost').value) || 0) * 10000;
  const use30m = document.getElementById('use30mDeduction').checked;
  const use10y = document.getElementById('use10yRate').checked;
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  const saleMoment = new Date(saleDateStr + '-01');
  let elapsedMonths = (saleMoment.getFullYear() - startMoment.getFullYear()) * 12 + (saleMoment.getMonth() - startMoment.getMonth());
  let remainBalance = 0;
  if (elapsedMonths < 0) { alert('å£²å´æ™‚æœŸã¯å€Ÿå…¥é–‹å§‹(è³¼å…¥æœˆ)ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„'); return; }
  else if (elapsedMonths >= scheduleData.length) { remainBalance = 0; }
  else { remainBalance = elapsedMonths === 0 ? parseFloat(document.getElementById('principal').value) * 10000 : scheduleData[elapsedMonths - 1].balance; }
  let brokerFee = 0;
  if (sPrice > 4000000) brokerFee = (sPrice * 0.03 + 60000) * 1.1;
  else if (sPrice > 2000000) brokerFee = (sPrice * 0.04 + 20000) * 1.1;
  else brokerFee = (sPrice * 0.05) * 1.1;
  const sCost = Math.floor(brokerFee + 10000);
  // æ¸›ä¾¡å„Ÿå´è¨ˆç®—
  const buildingRatio = (parseFloat(document.getElementById('buildingRatio').value) || 0) / 100;
  const buildingType = document.getElementById('buildingType').value;
  const depInfo = getDepreciationRate(buildingType);
  const holdingYears = saleMoment.getFullYear() - startMoment.getFullYear();
  const taxHoldingYears = saleMoment.getFullYear() - 1 - startMoment.getFullYear();
  const buildingCost = pPrice * buildingRatio;
  const landCost = pPrice * (1 - buildingRatio);
  const depreciationAmount = Math.floor(buildingCost * depInfo.rate * holdingYears);
  const adjustedBuildingCost = Math.max(buildingCost * 0.05, buildingCost - depreciationAmount);
  const acquisitionCost = Math.floor(landCost + adjustedBuildingCost + pCost);
  const acquisitionCostNoDep = Math.floor(pPrice + pCost); // æ¸›ä¾¡å„Ÿå´ãªã—ã®å–å¾—è²»
  const capitalGainNoDep = sPrice - acquisitionCostNoDep - sCost; // æ¸›ä¾¡å„Ÿå´ãªã—ã®è­²æ¸¡ç›Š
  let capitalGain = sPrice - acquisitionCost - sCost;
  let tax = 0; let taxLabel = "éèª²ç¨"; let appliedRateText = ""; let taxBadgeClass = "tax-long";
  let taxableGain = capitalGain;
  if (capitalGain > 0) {
    if (use30m) { taxableGain = Math.max(0, taxableGain - 30000000); }
    if (taxableGain > 0) {
      if (taxHoldingYears > 10 && use10y) {
        if (taxableGain <= 60000000) { appliedRateText = "14.21%"; tax = taxableGain * 0.1421; taxLabel = "è»½æ¸›ç¨ç‡é©ç”¨"; taxBadgeClass = "tax-reduced"; }
        else { tax = (60000000 * 0.1421) + ((taxableGain - 60000000) * 0.20315); appliedRateText = "ä¸€éƒ¨è¶…é"; taxLabel = "è»½æ¸›ç¨ç‡(ä¸€éƒ¨é•·æœŸ)"; taxBadgeClass = "tax-reduced"; }
      } else if (taxHoldingYears > 5) { appliedRateText = "20.315%"; tax = taxableGain * 0.20315; taxLabel = "é•·æœŸè­²æ¸¡æ‰€å¾—"; taxBadgeClass = "tax-long"; }
      else { appliedRateText = "39.63%"; tax = taxableGain * 0.3963; taxLabel = "çŸ­æœŸè­²æ¸¡æ‰€å¾—"; taxBadgeClass = "tax-short"; }
    } else { taxLabel = "ç¨é¡0å†† (3,000ä¸‡æ§é™¤æ å†…)"; appliedRateText = "0%"; taxBadgeClass = "tax-long"; }
  } else { taxLabel = "ç¨é¡0å†† (è­²æ¸¡ç›Šãªã—)"; appliedRateText = "0%"; taxBadgeClass = "tax-long"; }
  tax = Math.floor(tax);
  // æ¸›ä¾¡å„Ÿå´ãªã—ã®ç¨é¡ã‚’æ¯”è¼ƒç”¨ã«è¨ˆç®—
  const taxNoDep = (buildingRatio > 0 && depreciationAmount > 0) ? calcTaxForYear(sPrice, acquisitionCostNoDep, 0, sCost, taxHoldingYears, use30m, use10y) : tax;
  const taxDiffByDep = tax - taxNoDep; // æ¸›ä¾¡å„Ÿå´ã«ã‚ˆã‚‹ç¨é¡å·®
  const netProceeds = sPrice - remainBalance - sCost - tax;
  const badge = document.getElementById('taxBadge');
  badge.textContent = taxLabel; badge.className = `tax-badge ${taxBadgeClass}`; badge.style.display = 'inline-block';
  document.getElementById('saleResNet').textContent = fmtShort(netProceeds) + 'å††';

  // æç›Šåˆ†å²ç‚¹ï¼šæ‰‹å–ã‚ŠãŒãƒ—ãƒ©ã‚¹ã«ãªã‚‹æœ€çŸ­æœˆã‚’æ¤œç´¢ï¼ˆå¹´ã”ã¨ã«ç¨é¡ã‚’å†è¨ˆç®—ï¼‰
  const beBox = document.getElementById('breakevenBox');
  const beVal = document.getElementById('breakevenVal');
  let breakevenLabel = null;
  for (let m = 0; m < scheduleData.length; m++) {
    const bal = m === 0 ? parseFloat(document.getElementById('principal').value)*10000 : scheduleData[m-1].balance;
    const yearForM = parseInt(scheduleData[m].label.split('å¹´')[0]);
    const holdYrs = yearForM - 1 - startMoment.getFullYear();
    const yrsM = yearForM - startMoment.getFullYear();
    const depM = Math.floor(buildingCost * depInfo.rate * yrsM);
    const adjBM = Math.max(buildingCost * 0.05, buildingCost - depM);
    const acqM = Math.floor(landCost + adjBM + pCost);
    const taxM = calcTaxForYear(sPrice, acqM, 0, sCost, holdYrs, use30m, use10y);
    const netChk = sPrice - bal - sCost - taxM;
    if (netChk >= 0) { breakevenLabel = scheduleData[m].label; break; }
  }
  if (breakevenLabel) {
    beVal.textContent = breakevenLabel + 'ä»¥é™';
  } else {
    beVal.textContent = 'å…¨æœŸé–“ãƒã‚¤ãƒŠã‚¹';
  }
  beBox.style.display = 'block';
  drawBreakevenChart(sPrice, sCost, pPrice, pCost, use30m, use10y, startMoment, buildingRatio, depInfo, landCost);
  const breakdownHtml = `
    <div class="step-box">
      <span class="step-num s1">1</span>
      <div class="step-title c1">è­²æ¸¡ç›Šã®è¨ˆç®—</div>
      <div class="step-row"><span>å£²å´äºˆå®šé¡</span><span>${fmtShort(sPrice)}å††</span></div>
      <div class="step-row sub"><span><span class="step-sign">âˆ’</span>å–å¾—è²»${buildingRatio > 0 && depreciationAmount > 0 ? 'ï¼ˆæ¸›ä¾¡å„Ÿå´å¾Œï¼‰' : ''}</span><span>${fmtShort(acquisitionCost)}å††</span></div>
      <div class="step-row sub"><span><span class="step-sign">âˆ’</span>å£²å´è«¸è²»ç”¨ï¼ˆæ¦‚ç®—ï¼‰</span><span>${fmtShort(sCost)}å††</span></div>
      <div class="step-row result ${capitalGain >= 0 ? 'positive' : 'negative'}"><span>ï¼ è­²æ¸¡ç›Š</span><span>${capitalGain >= 0 ? '+' : ''}${fmtShort(capitalGain)}å††</span></div>

      ${buildingRatio > 0 && depreciationAmount > 0 ? `
      <div class="dep-card">
        <div class="dep-card-header">ğŸ“ æ¸›ä¾¡å„Ÿå´ã®å½±éŸ¿ï¼ˆå–å¾—è²»ã¨ç¨é‡‘ãŒã©ã†å¤‰ã‚ã‚‹ã‹ï¼‰</div>
        <div class="dep-cols" style="position:relative;">
          <div style="position:absolute;left:50%;top:0;bottom:0;width:1px;background:var(--border2);"></div>
          <div class="dep-col before">
            <div class="dep-col-title">ã‚‚ã—å„Ÿå´ãªã—</div>
            <div class="dep-col-row"><span>å–å¾—è²»</span><span>${fmtMan(acquisitionCostNoDep)}</span></div>
            <div class="dep-col-row result-row"><span>è­²æ¸¡ç›Š</span><span>${fmtMan(capitalGainNoDep)}</span></div>
            <div class="dep-col-row result-row"><span>ç¨é‡‘</span><span>${fmtMan(taxNoDep)}</span></div>
          </div>
          <div class="dep-col after">
            <div class="dep-col-title">å„Ÿå´ã‚ã‚Šï¼ˆå®Ÿéš›ï¼‰</div>
            <div class="dep-col-row changed"><span>å–å¾—è²»</span><span>${fmtMan(acquisitionCost)}</span></div>
            <div class="dep-col-row result-row changed"><span>è­²æ¸¡ç›Š</span><span>${fmtMan(capitalGain)}</span></div>
            <div class="dep-col-row result-row changed"><span>ç¨é‡‘</span><span>${fmtMan(tax)}</span></div>
          </div>
        </div>
        <div class="dep-bottom">
          ${taxDiffByDep > 0 ? `<div class="dep-bottom-row">
            <span class="dep-label">âš  æ¸›ä¾¡å„Ÿå´ã§å¢—ãˆãŸç¨é‡‘</span>
            <span class="dep-val" style="color:var(--danger);">+${fmtMan(taxDiffByDep)}</span>
          </div>
          <div class="dep-bottom-note">
            ${holdingYears}å¹´é–“ã§å»ºç‰©éƒ¨åˆ†ï¼ˆ${fmtMan(buildingCost)}ï¼‰ã®å¸³ç°¿ä¾¡å€¤ãŒ ${fmtMan(depreciationAmount)} ä¸‹ãŒã‚Šã€ãã®åˆ†ã€Œå„²ã‘ã€ãŒå¤§ããè¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™ã€‚
          </div>` : `<div class="dep-bottom-row">
            <span class="dep-label">âœ… æ¸›ä¾¡å„Ÿå´ã«ã‚ˆã‚‹ç¨é‡‘ã¸ã®å½±éŸ¿</span>
            <span class="dep-val" style="color:var(--safe);">ãªã—</span>
          </div>
          <div class="dep-bottom-note">ç‰¹åˆ¥æ§é™¤ã®ç¯„å›²å†…ã®ãŸã‚ã€æ¸›ä¾¡å„Ÿå´ã«ã‚ˆã‚‹ç¨é¡ã®å¤‰åŒ–ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`}
        </div>
      </div>
      ` : `${buildingRatio <= 0 ? `<div class="step-detail" style="font-size:0.56rem;">
        å–å¾—è²» ï¼ è³¼å…¥ä¾¡æ ¼ ${fmtShort(pPrice)}å†† + è«¸è²»ç”¨ ${fmtShort(pCost)}å†† ï¼ ${fmtShort(acquisitionCostNoDep)}å††<br>
        <span style="color:var(--muted);">â€» å»ºç‰©å‰²åˆã‚’è¨­å®šã™ã‚‹ã¨æ¸›ä¾¡å„Ÿå´ãŒè€ƒæ…®ã•ã‚Œã€ã‚ˆã‚Šæ­£ç¢ºãªè¨ˆç®—ã«ãªã‚Šã¾ã™ã€‚</span>
      </div>` : ''}`}
      ${capitalGain > 0 && use30m ? `<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);">
        <div class="step-row sub" style="color:var(--safe);"><span><span class="step-sign">âˆ’</span>3,000ä¸‡å††ç‰¹åˆ¥æ§é™¤</span><span class="step-badge safe">é©ç”¨</span></div>
        <div class="step-row result positive"><span>ï¼ èª²ç¨è­²æ¸¡æ‰€å¾—</span><span>${fmtShort(taxableGain)}å††</span></div>
      </div>` : ''}
    </div>

    <div class="step-connector">â–¼</div>

    <div class="step-box">
      <span class="step-num s2">2</span>
      <div class="step-title c2">ç¨ç‡ã®åˆ¤å®š</div>
      <div class="step-row"><span>æ‰€æœ‰æœŸé–“</span><span>${taxHoldingYears}å¹´</span></div>
      <div class="step-row sub" style="color:var(--muted);font-size:0.6rem;"><span>â€» è­²æ¸¡å¹´ã®1æœˆ1æ—¥æ™‚ç‚¹ã§åˆ¤å®š</span></div>
      <div class="step-row result" style="color:var(--info);"><span>åˆ¤å®š</span>
        <span class="step-badge ${taxBadgeClass === 'tax-short' ? 'danger' : taxBadgeClass === 'tax-reduced' ? 'safe' : 'info'}">${taxLabel}${appliedRateText ? ' (' + appliedRateText + ')' : ''}</span>
      </div>
    </div>

    <div class="step-connector">â–¼</div>

    <div class="step-box"${tax > 0 ? ' style="border-color:rgba(224,120,104,0.25);"' : ''}>
      <span class="step-num s3">3</span>
      <div class="step-title c3">è­²æ¸¡ç¨</div>
      <div class="step-row"><span>èª²ç¨è­²æ¸¡æ‰€å¾—</span><span>${fmtShort(taxableGain)}å††</span></div>
      <div class="step-row sub"><span><span class="step-sign">Ã—</span>ç¨ç‡</span><span>${appliedRateText}</span></div>
      <div class="step-row result ${tax > 0 ? 'negative' : 'positive'}"><span>ï¼ è­²æ¸¡ç¨</span><span>${tax > 0 ? '' : ''}${fmtShort(tax)}å††</span></div>
    </div>

    <div class="step-connector">â–¼</div>

    <div class="step-final">
      <span class="step-num s4">4</span>
      <div class="step-title c4">æœ€çµ‚æ‰‹å–ã‚Šé¡</div>
      <div class="step-final-items">
        <div class="step-final-item"><span>å£²å´é¡</span><span>${fmtShort(sPrice)}å††</span></div>
        <div class="step-final-item"><span>æ®‹å‚µè¿”æ¸ˆ</span><span>âˆ’${fmtShort(remainBalance)}å††</span></div>
        <div class="step-final-item"><span>å£²å´è²»ç”¨</span><span>âˆ’${fmtShort(sCost)}å††</span></div>
        <div class="step-final-item"><span>è­²æ¸¡ç¨</span><span>âˆ’${fmtShort(tax)}å††</span></div>
      </div>
      <div class="step-row result ${netProceeds >= 0 ? 'positive' : 'negative'}" style="font-size:1.1rem;">
        <span>ï¼ æ‰‹å–ã‚Šé¡</span>
        <span>${netProceeds >= 0 ? '+' : ''}${fmtShort(netProceeds)}å††</span>
      </div>
    </div>
    <div style="font-size:0.6rem; color:var(--muted); text-align:right; margin-top:10px; margin-left:36px;">â€»å£²å´è«¸è²»ç”¨ã¯ä»²ä»‹æ‰‹æ•°æ–™ï¼‹å°ç´™ä»£ã®æ¦‚ç®—ã§ã™ã€‚</div>
  `;
  document.getElementById('calcBreakdown').innerHTML = breakdownHtml;
  document.getElementById('saleResult').style.display = 'block';
  // G: æ®‹å‚µvsç‰©ä»¶ä¾¡å€¤ãƒ‰ãƒ¼ãƒŠãƒ„
  drawEquityDonut(remainBalance, sPrice, sCost);
}

/* â”€â”€ Share / Capture â”€â”€ */
let _shareBlob = null;
let _shareTitle = '';
let _shareText = '';

function scRow(label, value, sub) {
  return `<div class="sc-row"><span>${label}</span><span>${value}${sub ? `<span style="font-size:10px;color:#9a9488;margin-left:3px;">${sub}</span>` : ''}</span></div>`;
}
function scSection(title, rows) {
  return `<div class="sc-box" style="padding:10px 14px;margin-bottom:8px;">
    <div style="font-size:10px;color:#d4b478;font-weight:700;margin-bottom:8px;letter-spacing:0.06em;">${title}</div>
    ${rows}
  </div>`;
}

function buildShareCard(type) {
  const today = new Date();
  const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
  const card = document.getElementById('shareCard');

  // å…±é€šå…¥åŠ›ãƒ‡ãƒ¼ã‚¿
  const principal  = document.getElementById('principal').value;
  const rate       = document.getElementById('rate').value;
  const years      = document.getElementById('years').value;
  const startDate  = document.getElementById('startDate').value;
  const methodVal  = document.getElementById('method').value;
  const methodLabel = methodVal === 'equal_payment' ? 'å…ƒåˆ©å‡ç­‰' : 'å…ƒé‡‘å‡ç­‰';
  const useRules   = document.getElementById('useJibunRules').checked;

  const baseInputRows = `
    ${scRow('å€Ÿå…¥é‡‘é¡', Number(principal).toLocaleString() + 'ä¸‡å††')}
    ${scRow('å½“åˆå¹´åˆ©', rate + '%')}
    ${scRow('è¿”æ¸ˆæœŸé–“', years + 'å¹´')}
    ${scRow('å€Ÿå…¥é–‹å§‹', startDate.replace('-', 'å¹´') + 'æœˆã€œ')}
    ${scRow('è¿”æ¸ˆæ–¹å¼', methodLabel + (useRules ? 'ãƒ»5å¹´/125%ãƒ«ãƒ¼ãƒ«é©ç”¨' : ''))}
  `;

  if (type === 'summary') {
    _shareTitle = 'ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆçŠ¶æ³';
    const initial  = document.getElementById('statInitial').textContent;
    const current  = document.getElementById('statCurrent').textContent;
    const interest = document.getElementById('statTotalInterest').textContent;
    const total    = document.getElementById('statTotal').textContent;
    const pct      = document.getElementById('progressPct').textContent;
    const remain   = document.getElementById('remainBalance').textContent;
    const months   = document.getElementById('remainMonths').textContent;
    const paidAmt  = document.getElementById('paidAmount').textContent;
    const cAdmin   = parseInt(document.getElementById('costAdmin').value) || 0;
    const cRepair  = parseInt(document.getElementById('costRepair').value) || 0;
    const cOther   = parseInt(document.getElementById('costOther').value) || 0;
    const runCost  = cAdmin + cRepair + cOther;
    _shareText = `ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆçŠ¶æ³ (${dateStr})\nç¾åœ¨ã®æœˆè¿”æ¸ˆé¡: ${current}å††\nç·åˆ©æ¯: ${interest}å††\næ®‹é«˜: ${remain}\nè¿”æ¸ˆé€²æ—: ${pct}`;

    card.innerHTML = `
      <div class="sc-header">
        <div><div class="sc-title">ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</div><div class="sc-subtitle">è¿”æ¸ˆçŠ¶æ³ã‚µãƒãƒªãƒ¼</div></div>
        <div class="sc-date">${dateStr}</div>
      </div>

      ${scSection('ğŸ“‹ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿', baseInputRows + (runCost > 0 ? scRow('æœˆé¡ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆ', runCost.toLocaleString() + 'å††') : ''))}

      <div style="font-size:10px;color:#9a9488;margin:10px 0 6px;font-weight:700;letter-spacing:0.06em;">ğŸ“Š è¿”æ¸ˆçŠ¶æ³</div>
      <div class="sc-grid sc-grid-2" style="margin-bottom:8px;">
        <div class="sc-box"><div class="sc-label">å½“åˆ æœˆè¿”æ¸ˆé¡</div><div class="sc-value" style="font-size:15px;">${initial}<span style="font-size:10px;">å††</span></div></div>
        <div class="sc-box accent"><div class="sc-label">ç¾åœ¨ æœˆè¿”æ¸ˆé¡</div><div class="sc-value gold" style="font-size:15px;">${current}<span style="font-size:10px;">å††</span></div></div>
      </div>
      <div class="sc-grid sc-grid-3" style="margin-bottom:8px;">
        <div class="sc-box danger"><div class="sc-label">ç·åˆ©æ¯</div><div class="sc-value red" style="font-size:13px;">${interest}<span style="font-size:9px;">å††</span></div></div>
        <div class="sc-box"><div class="sc-label">ç·æ”¯æ‰•é¡</div><div class="sc-value" style="font-size:13px;">${total}<span style="font-size:9px;">å††</span></div></div>
        <div class="sc-box"><div class="sc-label">è¿”æ¸ˆé€²æ—</div><div class="sc-value gold" style="font-size:15px;">${pct}</div></div>
      </div>
      <div class="sc-box" style="padding:10px 14px;">
        ${scRow('ãƒ­ãƒ¼ãƒ³æ®‹é«˜', remain)}
        ${scRow('æ®‹ã‚ŠæœŸé–“', months)}
        ${scRow('è¿”æ¸ˆæ¸ˆã¿å…ƒé‡‘', paidAmt.replace('å…ƒé‡‘è¿”æ¸ˆæ¸ˆ: ', ''))}
      </div>
      <div class="sc-footer" style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div style="font-size:10px;color:#9a9488;text-align:left;line-height:1.6;">
          ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒª<br>
          <span style="font-size:9px;">ç¹°ã‚Šä¸Šã’è¿”æ¸ˆãƒ»å€Ÿã‚Šæ›ãˆãƒ»å£²å´ã‚’ç„¡æ–™ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
        </div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=56x56&color=9a9488&bgcolor=1a1816&data=" style="width:56px;height:56px;border-radius:4px;flex-shrink:0;" crossorigin="anonymous">
      </div>`;

  } else if (type === 'prepay') {
    _shareTitle = 'ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³';
    const saved    = document.getElementById('prepayInterestSaved').textContent;
    const main     = document.getElementById('prepayMainVal').textContent;
    const label    = document.getElementById('prepayMainLabel').textContent;
    const oldInt   = document.getElementById('prepayOldInterest').textContent;
    const newInt   = document.getElementById('prepayNewInterest').textContent;
    const amount   = document.getElementById('prepayAmount').value;
    const timing   = document.getElementById('prepayTiming').value;
    const typeIsShorten = document.getElementById('prepayTypeShorten').classList.contains('active');
    _shareText = `ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (${dateStr})\nåˆ©æ¯å‰Šæ¸›é¡: ${saved}å††\n${label}: ${main}`;

    card.innerHTML = `
      <div class="sc-header">
        <div><div class="sc-title">ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</div><div class="sc-subtitle">ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div></div>
        <div class="sc-date">${dateStr}</div>
      </div>

      ${scSection('ğŸ“‹ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿', baseInputRows
        + scRow('ç¹°ã‚Šä¸Šã’è¿”æ¸ˆé¡', Number(amount).toLocaleString() + 'ä¸‡å††')
        + scRow('è¿”æ¸ˆã‚¿ã‚¤ãƒ—', typeIsShorten ? 'æœŸé–“çŸ­ç¸®å‹' : 'è¿”æ¸ˆé¡è»½æ¸›å‹')
        + scRow('å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°', timing === '0' || !timing ? 'ä»Šã™ã' : `${timing}ãƒ¶æœˆå¾Œ`)
      )}

      ${scSection('ğŸ“Š è¨ˆç®—éç¨‹', `
        ${scRow('ç¹°ã‚Šä¸Šã’å‰ ç·åˆ©æ¯', oldInt + 'å††')}
        ${scRow('ç¹°ã‚Šä¸Šã’å¾Œ ç·åˆ©æ¯', newInt + 'å††')}
      `)}

      <div style="font-size:10px;color:#9a9488;margin:10px 0 6px;font-weight:700;letter-spacing:0.06em;">âœ… ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
      <div class="sc-grid sc-grid-2">
        <div class="sc-box green"><div class="sc-label">ğŸ’° åˆ©æ¯å‰Šæ¸›é¡</div><div class="sc-value green" style="font-size:15px;">${saved}<span style="font-size:10px;">å††</span></div></div>
        <div class="sc-box accent"><div class="sc-label">${label}</div><div class="sc-value gold" style="font-size:14px;">${main}</div></div>
      </div>
      <div class="sc-footer" style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div style="font-size:10px;color:#9a9488;text-align:left;line-height:1.6;">
          ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒª<br>
          <span style="font-size:9px;">ç¹°ã‚Šä¸Šã’è¿”æ¸ˆãƒ»å€Ÿã‚Šæ›ãˆãƒ»å£²å´ã‚’ç„¡æ–™ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
        </div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=56x56&color=9a9488&bgcolor=1a1816&data=" style="width:56px;height:56px;border-radius:4px;flex-shrink:0;" crossorigin="anonymous">
      </div>`;

  } else if (type === 'refi') {
    _shareTitle = 'å€Ÿã‚Šæ›ãˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³';
    const diff     = document.getElementById('refiDiffVal').textContent;
    const oldTot   = document.getElementById('refiOldTotal').textContent;
    const oldPri   = document.getElementById('refiOldPrincipal').textContent;
    const oldInt   = document.getElementById('refiOldInterest').textContent;
    const newTot   = document.getElementById('refiNewTotal').textContent;
    const newLoan  = document.getElementById('refiNewLoan').textContent;
    const cost     = document.getElementById('refiCost').textContent;
    const refiRate = document.getElementById('refiRate').value;
    const feeRate  = document.getElementById('refiFeeRate').value;
    const fixCost  = document.getElementById('refiFixCost').value;
    const isProfit = diff.includes('ãŠå¾—');
    _shareText = `å€Ÿã‚Šæ›ãˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (${dateStr})\nå€Ÿã‚Šæ›ãˆåŠ¹æœ: ${diff}`;

    card.innerHTML = `
      <div class="sc-header">
        <div><div class="sc-title">ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</div><div class="sc-subtitle">å€Ÿã‚Šæ›ãˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div></div>
        <div class="sc-date">${dateStr}</div>
      </div>

      ${scSection('ğŸ“‹ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿', baseInputRows
        + scRow('å€Ÿã‚Šæ›ãˆå¾Œé‡‘åˆ©', refiRate + '%')
        + scRow('äº‹å‹™æ‰‹æ•°æ–™ç‡', feeRate + '%')
        + scRow('ãã®ä»–å›ºå®šè²»', Number(fixCost).toLocaleString() + 'ä¸‡å††')
      )}

      ${scSection('ğŸ“Š è¨ˆç®—éç¨‹', `
        <div style="font-size:10px;color:#9a9488;margin-bottom:4px;">ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ³ï¼ˆæ®‹ã‚Šï¼‰</div>
        ${scRow('æ®‹ã‚Šç·æ”¯æ‰•', oldTot + 'å††')}
        ${scRow('â”— æ®‹ã‚Šå…ƒé‡‘', oldPri + 'å††')}
        ${scRow('â”— æ®‹ã‚Šåˆ©æ¯', oldInt + 'å††')}
        <div style="font-size:10px;color:#9a9488;margin:8px 0 4px;">å€Ÿã‚Šæ›ãˆå¾Œ</div>
        ${scRow('ç·æ”¯æ‰•ï¼ˆè«¸è²»ç”¨è¾¼ï¼‰', newTot + 'å††')}
        ${scRow('â”— ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆåˆ†', newLoan + 'å††')}
        ${scRow('â”— è«¸è²»ç”¨', cost + 'å††')}
      `)}

      <div class="sc-box" style="padding:16px;text-align:center;border-color:${isProfit ? 'rgba(110,196,150,0.5)' : 'rgba(224,120,104,0.5)'};background:${isProfit ? 'rgba(110,196,150,0.07)' : 'rgba(224,120,104,0.07)'};">
        <div class="sc-label">å€Ÿã‚Šæ›ãˆåŠ¹æœï¼ˆç¯€ç´„é¡ï¼‰</div>
        <div class="sc-value" style="font-size:22px;color:${isProfit ? '#6ec496' : '#e07868'};" id="_refiDiffRender">${diff}</div>
      </div>
      <div class="sc-footer" style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div style="font-size:10px;color:#9a9488;text-align:left;line-height:1.6;">
          ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒª<br>
          <span style="font-size:9px;">ç¹°ã‚Šä¸Šã’è¿”æ¸ˆãƒ»å€Ÿã‚Šæ›ãˆãƒ»å£²å´ã‚’ç„¡æ–™ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
        </div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=56x56&color=9a9488&bgcolor=1a1816&data=" style="width:56px;height:56px;border-radius:4px;flex-shrink:0;" crossorigin="anonymous">
      </div>`;

  } else if (type === 'sale') {
    _shareTitle = 'å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³';
    const net      = document.getElementById('saleResNet').textContent;
    const be       = document.getElementById('breakevenVal').textContent;
    const badge    = document.getElementById('taxBadge').textContent;
    const sPrice   = document.getElementById('salePrice').value;
    const pPrice   = document.getElementById('purchasePrice').value;
    const pCost    = document.getElementById('purchaseCost').value;
    const saleDate = document.getElementById('saleDate').value;
    const use30m   = document.getElementById('use30mDeduction').checked;
    const use10y   = document.getElementById('use10yRate').checked;

    // ã‚°ãƒ©ãƒ•ã®canvasã‚’Base64ç”»åƒã¨ã—ã¦å–å¾—
    const chartCanvas = document.getElementById('breakevenChart');
    const chartImgSrc = chartCanvas ? chartCanvas.toDataURL('image/png') : null;

    // è¨ˆç®—éç¨‹ï¼šstep-boxã‹ã‚‰å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœè¡Œã ã‘æŠ½å‡ºï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰
    const breakdown = document.getElementById('calcBreakdown');
    let calcRows = '';
    if (breakdown) {
      breakdown.querySelectorAll('.step-box, .step-final').forEach(box => {
        const resultRow = box.querySelector('.step-row.result');
        if (resultRow) {
          const spans = resultRow.querySelectorAll('span');
          if (spans.length >= 2) {
            const label = spans[0].textContent.trim();
            const value = spans[1].textContent.trim();
            const isLast = box.style.borderColor || box.querySelector('[style*="safe"]');
            calcRows += `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #2c2a28;font-size:11px;">
              <span style="color:#d0cbbf;">${label}</span>
              <span style="font-family:'DM Mono',monospace;color:#f0d080;font-weight:600;">${value}</span>
            </div>`;
          }
        }
      });
    }

    _shareText = `å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (${dateStr})\næœ€çµ‚æ‰‹å–ã‚Šé¡: ${net}\nãƒ—ãƒ©ã‚¹è»¢æ›: ${be}`;

    card.innerHTML = `
      <div class="sc-header">
        <div><div class="sc-title">ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</div><div class="sc-subtitle">å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div></div>
        <div class="sc-date">${dateStr}</div>
      </div>

      <!-- å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆ2åˆ—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
      <div class="sc-box" style="padding:10px 14px;margin-bottom:8px;">
        <div style="font-size:10px;color:#d4b478;font-weight:700;margin-bottom:8px;letter-spacing:0.06em;">ğŸ“‹ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 16px;">
          ${[
            ['å€Ÿå…¥é‡‘é¡', principal + 'ä¸‡å††'],
            ['å½“åˆå¹´åˆ©', rate + '%'],
            ['è¿”æ¸ˆæœŸé–“', years + 'å¹´'],
            ['å€Ÿå…¥é–‹å§‹', startDate.replace('-','å¹´')+'æœˆã€œ'],
            ['å£²å´äºˆå®š', saleDate.replace('-','å¹´')+'æœˆ'],
            ['å£²å´äºˆå®šé¡', Number(sPrice).toLocaleString()+'ä¸‡å††'],
            ['è³¼å…¥ä¾¡æ ¼', Number(pPrice).toLocaleString()+'ä¸‡å††'],
            ['è³¼å…¥æ™‚è«¸è²»ç”¨', Number(pCost).toLocaleString()+'ä¸‡å††'],
            ['3,000ä¸‡æ§é™¤', use30m ? 'é©ç”¨ã‚ã‚Š' : 'é©ç”¨ãªã—'],
            ['10å¹´è¶…è»½æ¸›ç¨ç‡', use10y ? 'é©ç”¨ã‚ã‚Š' : 'é©ç”¨ãªã—'],
          ].map(([l,v]) => `<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:10px;border-bottom:1px solid #2a2825;">
            <span style="color:#9a9488;">${l}</span><span style="font-family:'DM Mono',monospace;color:#d0cbbf;">${v}</span>
          </div>`).join('')}
        </div>
      </div>

      <!-- è¨ˆç®—éç¨‹ã‚µãƒãƒªãƒ¼ -->
      ${calcRows ? `<div class="sc-box" style="padding:10px 14px;margin-bottom:8px;">
        <div style="font-size:10px;color:#d4b478;font-weight:700;margin-bottom:8px;letter-spacing:0.06em;">ğŸ“Š è¨ˆç®—ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœï¼‰</div>
        ${calcRows}
      </div>` : ''}

      <!-- æ‰‹å–ã‚Šé¡ï¼ˆãƒ¡ã‚¤ãƒ³çµæœï¼‰ -->
      <div class="sc-box green" style="padding:14px 16px;text-align:center;margin-bottom:8px;">
        <div class="sc-label">æœ€çµ‚æ‰‹å–ã‚Šé¡ï¼ˆå«ã¿ç›Šï¼‰</div>
        <div class="sc-value green" style="font-size:24px;">${net}</div>
        ${badge ? `<div style="margin-top:5px;font-size:10px;color:#9a9488;">${badge}</div>` : ''}
        ${be && be !== 'â€”' ? `<div style="margin-top:6px;font-size:10px;color:#6a9ed8;">ğŸ“ ãƒ—ãƒ©ã‚¹è»¢æ›: ${be}</div>` : ''}
      </div>

      <!-- æç›Šåˆ†å²ç‚¹ã‚°ãƒ©ãƒ• -->
      ${chartImgSrc ? `<div class="sc-box" style="padding:10px 12px;margin-bottom:8px;">
        <div style="font-size:10px;color:#d4b478;font-weight:700;margin-bottom:8px;letter-spacing:0.06em;">ğŸ“ˆ å¹´åˆ¥ å£²å´æ‰‹å–ã‚Šé¡ã®æ¨ç§»</div>
        <img src="${chartImgSrc}" style="width:100%;display:block;border-radius:4px;">
      </div>` : ''}

      <div class="sc-note" style="margin-top:4px;">â€»å»ºç‰©ã®æ¸›ä¾¡å„Ÿå´è²»ã¯è€ƒæ…®ã›ãšã€è³¼å…¥ä¾¡æ ¼ã‚’å–å¾—è²»ã¨ã—ãŸç°¡æ˜“è¨ˆç®—ã§ã™</div>
      <div class="sc-footer" style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div style="font-size:10px;color:#9a9488;text-align:left;line-height:1.6;">
          ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒª<br>
          <span style="font-size:9px;">ç¹°ã‚Šä¸Šã’è¿”æ¸ˆãƒ»å€Ÿã‚Šæ›ãˆãƒ»å£²å´ã‚’ç„¡æ–™ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
        </div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=56x56&color=9a9488&bgcolor=1a1816&data=" style="width:56px;height:56px;border-radius:4px;flex-shrink:0;" crossorigin="anonymous">
      </div>`;
  }
}

async function openShareModal(type) {
  _shareBlob = null;
  buildShareCard(type);
  document.getElementById('shareModalTitle').textContent =
    { summary:'ğŸ“¤ è¿”æ¸ˆçŠ¶æ³ã‚’å…±æœ‰', prepay:'ğŸ“¤ ç¹°ã‚Šä¸Šã’è¿”æ¸ˆçµæœã‚’å…±æœ‰', refi:'ğŸ“¤ å€Ÿã‚Šæ›ãˆçµæœã‚’å…±æœ‰', sale:'ğŸ“¤ å£²å´çµæœã‚’å…±æœ‰' }[type];

  const overlay = document.getElementById('shareModalOverlay');
  const preview = document.getElementById('sharePreview');
  const loading = document.getElementById('sharePreviewLoading');
  preview.innerHTML = '';
  const loadDiv = document.createElement('div');
  loadDiv.className = 'share-preview-loading';
  loadDiv.textContent = 'ç”»åƒã‚’ç”Ÿæˆä¸­...';
  preview.appendChild(loadDiv);
  overlay.classList.add('open');

  // show Web Share button only if supported
  const webBtn = document.getElementById('webShareBtn');
  webBtn.style.display = navigator.share ? 'flex' : 'none';

  try {
    await document.fonts.ready;
    const card = document.getElementById('shareCard');
    // QRã‚³ãƒ¼ãƒ‰ã®URLã‚’ã‚»ãƒƒãƒˆ
    card.querySelectorAll('img[src*="qrserver.com"]').forEach(img => {
      const pageUrl = encodeURIComponent(location.href.split('?')[0]);
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=56x56&color=9a9488&bgcolor=1a1816&data=${pageUrl}`;
    });
    // ç”»åƒãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚­ãƒ£ãƒ—ãƒãƒ£
    await Promise.all([...card.querySelectorAll('img')].map(img =>
      img.complete ? Promise.resolve() : new Promise(r => { img.onload = r; img.onerror = r; })
    ));
    const canvas = await html2canvas(card, {
      backgroundColor: '#0d0c0a', scale: 2,
      useCORS: true, logging: false
    });
    canvas.toBlob(blob => {
      _shareBlob = blob;
      const img = document.createElement('img');
      img.src = URL.createObjectURL(blob);
      img.style.width = '100%';
      preview.innerHTML = '';
      preview.appendChild(img);
    }, 'image/png');
  } catch(e) {
    preview.innerHTML = '<div class="share-preview-loading" style="color:var(--danger)">ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

function closeShareModal() {
  document.getElementById('shareModalOverlay').classList.remove('open');
}

const PROMO = `\n\nğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒªã§ç„¡æ–™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼\nç¹°ã‚Šä¸Šã’è¿”æ¸ˆãƒ»å€Ÿã‚Šæ›ãˆãƒ»å£²å´ã®æå¾—ã‚’ã‹ã‚“ãŸã‚“è©¦ç®— ğŸ“Š`;

async function doWebShare() {
  if (!_shareBlob || !navigator.share) return;
  const file = new File([_shareBlob], 'mortgage_result.png', { type: 'image/png' });
  try {
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file], title: _shareTitle, text: _shareText + PROMO });
    } else {
      await navigator.share({ title: _shareTitle, text: _shareText + PROMO });
    }
  } catch(e) { /* cancelled */ }
}

function doDownload() {
  if (!_shareBlob) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(_shareBlob);
  const today = new Date();
  const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
  a.download = `ä½å®…ãƒ­ãƒ¼ãƒ³${_shareTitle}_${dateStr}.png`;
  a.click();
}

function doXShare() {
  // Xå°‚ç”¨ã®æŠ•ç¨¿ç”»é¢ã¸ç›´æ¥é·ç§»ï¼ˆç”»åƒã¯ä¿å­˜â†’æ‰‹å‹•æ·»ä»˜ï¼‰
  const msg = _shareText + PROMO + '\n#ä½å®…ãƒ­ãƒ¼ãƒ³ #ãƒã‚¤ãƒ›ãƒ¼ãƒ  #ä¸å‹•ç”£';
  const url = `https://x.com/intent/post?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

function doLineShare() {
  // LINEå°‚ç”¨ã®å…±æœ‰ç”»é¢ã¸ç›´æ¥é·ç§»
  const msg = _shareText + PROMO;
  const url = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}



// â•â•â• A: å¹´å˜ä½/æœˆå˜ä½è¡¨ç¤ºåˆ‡æ›¿ â•â•â•
function setScheduleMode(mode) {
  document.getElementById('modeYearly').classList.toggle('active', mode==='yearly');
  document.getElementById('modeMonthly').classList.toggle('active', mode==='monthly');
  document.getElementById('scheduleYearly').style.display = mode==='yearly' ? '' : 'none';
  document.getElementById('scheduleMonthly').style.display = mode==='monthly' ? '' : 'none';
}

function renderYearlySchedule() {
  const wrap = document.getElementById('scheduleYearly');
  if (!scheduleData.length) { wrap.innerHTML=''; return; }
  let html = '<div class="yearly-header"><div>å¹´</div><div>è¿”æ¸ˆé¡</div><div>å…ƒé‡‘</div><div>åˆ©æ¯</div><div>å¹´æœ«æ®‹é«˜</div></div>';
  const years = {};
  scheduleData.forEach((d,i) => {
    const y = d.label.split('å¹´')[0];
    if (!years[y]) years[y] = {payment:0, principal:0, interest:0, balance:0, months:[]};
    years[y].payment += d.payment; years[y].principal += d.principal; years[y].interest += d.interest;
    years[y].balance = d.balance; years[y].months.push(d);
  });
  const today = new Date();
  const curYear = today.getFullYear().toString();
  Object.entries(years).forEach(([y, v], idx) => {
    const hl = y === curYear ? ' hl' : '';
    html += `<div class="yearly-row${hl}" onclick="toggleYearlyExpand(${idx})">
      <div>${y}å¹´</div><div>${v.payment.toLocaleString()}</div><div>${v.principal.toLocaleString()}</div>
      <div>${v.interest.toLocaleString()}</div><div>${v.balance.toLocaleString()}</div></div>`;
    html += `<div class="yearly-months" id="yearExpand${idx}">`;
    v.months.forEach(mo => {
      html += `<div class="monthly-sub"><div>${mo.label.split('å¹´')[1]}</div><div>${mo.payment.toLocaleString()}</div>
        <div>${mo.principal.toLocaleString()}</div><div>${mo.interest.toLocaleString()}</div><div>${mo.balance.toLocaleString()}</div></div>`;
    });
    html += '</div>';
  });
  wrap.innerHTML = html;
}
function toggleYearlyExpand(idx) {
  document.getElementById('yearExpand'+idx).classList.toggle('open');
}

// â•â•â• B: ä»Šæœˆã‚µãƒãƒªãƒ¼æ›´æ–° â•â•â•
function updateTodayCard() {
  if (!scheduleData.length) return;
  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let elapsed = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());
  if (elapsed < 0 || elapsed >= scheduleData.length) { document.getElementById('todayCard').style.display='none'; return; }
  const row = scheduleData[elapsed];
  const ratio = row.payment > 0 ? (row.principal / row.payment * 100) : 0;
  document.getElementById('todayCard').style.display = '';
  document.getElementById('todayCardDate').textContent = row.label;
  document.getElementById('todayPrincipal').textContent = fmtShort(row.principal);
  document.getElementById('todayInterest').textContent = fmtShort(row.interest);
  document.getElementById('todayRatio').textContent = ratio.toFixed(1) + '%';
  document.getElementById('todayBarFill').style.width = ratio + '%';
}



// â•â•â• E: å€Ÿã‚Šæ›ãˆè‡ªå‹•åˆ¤å®š â•â•â•
function updateRefiAdvice() {
  const el = document.getElementById('refiAdvice');
  if (!scheduleData.length) { el.style.display='none'; return; }
  const currentRate = parseFloat(document.getElementById('rate').value);
  const refiRate = parseFloat(document.getElementById('refiRate').value);
  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let elapsed = (today.getFullYear()-startMoment.getFullYear())*12 + (today.getMonth()-startMoment.getMonth());
  if (elapsed < 0) elapsed = 0;
  const remainBal = elapsed < scheduleData.length && elapsed > 0 ? scheduleData[elapsed-1].balance : parseFloat(document.getElementById('principal').value)*10000;
  const remainYrs = Math.max(0, scheduleData.length - elapsed) / 12;
  const rateDiff = currentRate - refiRate;
  const effectText = document.getElementById('refiEffectVal')?.textContent || '';
  const isPositive = effectText.includes('-') === false && !effectText.includes('0å††');

  let cls = 'neutral', icon = 'â„¹ï¸', msg = '';
  if (rateDiff >= 0.3 && remainBal >= 10000000 && remainYrs >= 10) {
    cls = 'positive'; icon = 'âœ…';
    msg = `é‡‘åˆ©å·®${rateDiff.toFixed(2)}%ãƒ»æ®‹é«˜${fmtMan(remainBal)}ãƒ»æ®‹${Math.round(remainYrs)}å¹´ â€” å€Ÿã‚Šæ›ãˆãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãã„æ¡ä»¶ã§ã™ã€‚`;
  } else if (rateDiff < 0.1 || remainBal < 5000000 || remainYrs < 5) {
    cls = 'negative'; icon = 'âš ï¸';
    msg = `é‡‘åˆ©å·®ãŒå°ã•ã„ã€æ®‹é«˜ãŒå°‘ãªã„ã€ã¾ãŸã¯æ®‹æœŸé–“ãŒçŸ­ã„ãŸã‚ã€è«¸è²»ç”¨ã‚’è€ƒæ…®ã™ã‚‹ã¨å€Ÿã‚Šæ›ãˆã®åŠ¹æœã¯é™å®šçš„ã§ã™ã€‚`;
  } else {
    msg = `æ¡ä»¶ã¯ä¸­é–“çš„ã§ã™ã€‚è«¸è²»ç”¨è¾¼ã¿ã®ç·æ”¯æ‰•é¡ã‚’æ¯”è¼ƒã—ã¦åˆ¤æ–­ã—ã¾ã—ã‚‡ã†ã€‚`;
  }
  el.innerHTML = `<div class="refi-advice ${cls}"><span class="refi-advice-icon">${icon}</span><span>${msg}</span></div>`;
  el.style.display = '';
}

// â•â•â• F: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åŒæœŸ â•â•â•
function syncSliders() {
  const ps = document.getElementById('principalSlider');
  const rs = document.getElementById('rateSlider');
  const ys = document.getElementById('yearsSlider');
  if (ps) ps.value = document.getElementById('principal').value || 4700;
  if (rs) rs.value = document.getElementById('rate').value || 0.25;
  if (ys) ys.value = document.getElementById('years').value || 35;
}

// â•â•â• G: æ®‹å‚µvsç‰©ä»¶ä¾¡å€¤ãƒ‰ãƒ¼ãƒŠãƒ„ â•â•â•
function drawEquityDonut(debt, value, sCost) {
  const wrap = document.getElementById('equityWrap');
  const canvas = document.getElementById('equityDonut');
  if (!canvas || !wrap) return;
  sCost = sCost || 0;
  wrap.style.display = 'flex';
  const ctx = canvas.getContext('2d');
  const W = 100, H = 100;
  ctx.clearRect(0, 0, W, H);
  const cx = W/2, cy = H/2, radius = 38, lw = 12;
  const total = Math.max(debt + sCost + value, 1);
  const debtAngle = (debt / total) * 2 * Math.PI;
  const costAngle = (sCost / total) * 2 * Math.PI;
  // Background
  ctx.beginPath(); ctx.arc(cx,cy,radius,0,2*Math.PI); ctx.strokeStyle='#2c2a28'; ctx.lineWidth=lw; ctx.stroke();
  // Debt (red)
  let a = -Math.PI/2;
  if (debt > 0) { ctx.beginPath(); ctx.arc(cx,cy,radius,a,a+debtAngle); ctx.strokeStyle='#e07868'; ctx.lineWidth=lw; ctx.stroke(); a += debtAngle; }
  // Sale cost (orange)
  if (sCost > 0) { ctx.beginPath(); ctx.arc(cx,cy,radius,a,a+costAngle); ctx.strokeStyle='#e0a868'; ctx.lineWidth=lw; ctx.stroke(); a += costAngle; }
  // Value (green) - remaining
  ctx.beginPath(); ctx.arc(cx,cy,radius,a,-Math.PI/2+2*Math.PI); ctx.strokeStyle='#6ec496'; ctx.lineWidth=lw; ctx.stroke();

  document.getElementById('eqDebt').textContent = fmtMan(debt);
  document.getElementById('eqCost').textContent = fmtMan(sCost);
  document.getElementById('eqValue').textContent = fmtMan(value);
  const diff = value - debt - sCost; // å«ã¿æã«å£²å´è²»ç”¨ã‚‚å«ã‚€
  const resultEl = document.getElementById('eqResult');
  const labelEl = document.getElementById('eqResultLabel');
  if (diff >= 0) {
    labelEl.textContent = 'å«ã¿ç›Š'; labelEl.style.color = 'var(--safe)';
    resultEl.textContent = '+' + fmtMan(diff); resultEl.style.color = 'var(--safe)';
  } else {
    labelEl.textContent = 'å«ã¿æ'; labelEl.style.color = 'var(--danger)';
    resultEl.textContent = fmtMan(diff); resultEl.style.color = 'var(--danger)';
  }
}

loadSettings();
calculate();

/* â”€â”€ PWA â”€â”€ */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwaInstallBanner').style.display = 'block';
});
document.getElementById('pwaInstallBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('pwaInstallBanner').style.display = 'none';
});

if ('serviceWorker' in navigator) {
  // legacy inline SW removed â€” see sw.js
}
</script>
</body>
</html>