<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0f0e0c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†">
<title>ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0e0c;
    --surface: #1a1815;
    --surface2: #242220;
    --border: #2e2c28;
    --accent: #c8a96e;
    --accent2: #e8c98a;
    --text: #e8e4dc;
    --muted: #7a7568;
    --danger: #c4715a;
    --safe: #6aaa8e;
    --interest: #c4715a;
    --principal: #c8a96e;
    --info: #5a8bc4;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Serif JP', serif;
    min-height: 100vh;
    padding: 24px 16px;
  }
  .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
  .header h1 { font-size: 1.6rem; font-weight: 300; color: var(--accent2); letter-spacing: 0.1em; }
  .header p { color: var(--muted); font-size: 0.8rem; margin-top: 6px; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
  .card-title { 
    font-size: 0.75rem; color: var(--accent); letter-spacing: 0.15em; text-transform: uppercase; 
    margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border); 
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;
  }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }

  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-size: 0.75rem; color: var(--muted); }
  .form-group input, .form-group select {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
    color: var(--text); padding: 10px 12px; font-family: 'DM Mono', monospace;
    font-size: 0.9rem; outline: none; transition: border-color 0.2s;
  }
  .form-group input:focus, .form-group select:focus { border-color: var(--accent); }

  .checkbox-group {
    display: flex; align-items: center; gap: 10px; margin-top: 8px;
    padding: 10px; background: rgba(200,169,110,0.05); border-radius: 8px; border: 1px solid var(--border);
  }
  .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }
  .checkbox-group label { font-size: 0.8rem; color: var(--text); cursor: pointer; }
  .rule-desc { font-size: 0.7rem; color: var(--muted); margin-left: 24px; margin-top: 4px; line-height: 1.4; }

  .btn { background: var(--accent); color: #0f0e0c; border: none; border-radius: 8px; padding: 12px 28px; font-family: 'Noto Serif JP', serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s; width: 100%; margin-top: 12px; }
  .btn:hover { background: var(--accent2); }
  .btn:active { transform: scale(0.98); }
  .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; padding: 4px 12px; font-family: 'Noto Serif JP', serif; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
  .btn-outline:hover { background: var(--accent); color: #0f0e0c; }

  .total-cost-banner {
    background: rgba(200, 169, 110, 0.1);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    text-align: center;
  }
  .total-cost-label { font-size: 0.8rem; color: var(--accent); margin-bottom: 4px; letter-spacing: 0.05em; }
  .total-cost-value { font-family: 'DM Mono', monospace; font-size: 1.8rem; color: var(--accent2); font-weight: 500; }
  .total-cost-detail { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
  .total-cost-detail span { color: var(--text); font-weight: 500; margin: 0 4px; }

  .stats-section-label { font-size: 0.7rem; color: var(--muted); margin: 16px 0 8px 4px; border-left: 2px solid var(--accent); padding-left: 8px; }
  
  .stats-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; align-items: stretch; }
  @media (max-width: 600px) { .stats-grid-4 { grid-template-columns: repeat(2, 1fr); gap: 8px; } }
  
  .stats-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; align-items: stretch; }
  @media (max-width: 600px) { .stats-grid-3 { gap: 4px; } }

  .stat-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 4px; text-align: center; display: flex; flex-direction: column; height: 100%; }
  .stat-label { font-size: 0.65rem; color: var(--muted); margin-bottom: 8px; line-height: 1.3; height: 2.6em; display: flex; align-items: center; justify-content: center; }
  .stat-value { font-family: 'DM Mono', monospace; font-size: 0.95rem; color: var(--text); font-weight: 500; margin-bottom: 4px; height: 1.2em; display: flex; align-items: center; justify-content: center; }
  .stat-value.accent { color: var(--accent2); }
  .stat-value.danger { color: var(--danger); }
  .stat-sub { font-size: 0.58rem; color: var(--muted); margin-top: auto; line-height: 1.2; padding-top: 6px; min-height: 2.4em; }

  .progress-bar { background: var(--surface2); border-radius: 4px; height: 6px; overflow: hidden; margin: 12px 0 6px; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 4px; transition: width 0.5s ease; }
  .progress-labels { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--muted); }

  .tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
  .tab { flex: 1; min-width: 60px; padding: 8px 4px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); cursor: pointer; font-size: 0.72rem; text-align: center; transition: all 0.2s; font-family: 'Noto Serif JP', serif; }
  .tab.active { background: var(--accent); color: #0f0e0c; border-color: var(--accent); font-weight: 600; }

  .tools-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
  .tools-tab { flex: 1; padding: 10px; text-align: center; font-size: 0.75rem; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tools-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

  .table-wrap { overflow-y: auto; max-height: 450px; }
  table { width: 100%; table-layout: fixed; border-collapse: collapse; }
  th { background: var(--surface2); padding: 8px 2px; text-align: right; color: var(--muted); font-weight: 400; font-size: 0.6rem; position: sticky; top: 0; z-index: 1; white-space: nowrap; }
  th:first-child { text-align: left; padding-left: 4px; }
  td { padding: 8px 2px; text-align: right; border-bottom: 1px solid var(--border); font-family: 'DM Mono', monospace; font-size: 0.65rem; white-space: nowrap; letter-spacing: -0.5px; }
  td:first-child { text-align: left; color: var(--muted); font-family: 'Noto Serif JP', serif; font-size: 0.6rem; padding-left: 4px; }
  th:nth-child(1) { width: 17%; } th:nth-child(2) { width: 20%; } th:nth-child(3) { width: 18%; } th:nth-child(4) { width: 18%; } th:nth-child(5) { width: 27%; } 
  tr:hover td { background: var(--surface2); }
  tr.highlight td { background: rgba(200,169,110,0.08); }
  tr.highlight td:first-child { color: var(--accent); }
  tr.rate-change td:first-child { color: var(--safe); }

  .rate-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
  .rate-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .rate-section-title { font-size: 0.78rem; color: var(--accent); }
  .rate-change-item { display: flex; align-items: center; gap: 8px; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; }
  .rate-item-main { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .rate-item-date { font-family: 'DM Mono', monospace; font-size: 0.85rem; color: var(--text); }
  .rate-item-val { font-size: 0.7rem; color: var(--safe); }
  .rate-add-form { display: none; background: var(--surface2); border: 1px solid var(--accent); border-radius: 8px; padding: 16px; margin: 10px 0; }
  .rate-actions { display: flex; gap: 6px; }

  .btn-sm { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); padding: 6px 10px; font-size: 0.72rem; cursor: pointer; transition: all 0.2s; font-family: 'Noto Serif JP', serif; }
  .btn-sm.edit:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm.danger:hover { border-color: var(--danger); color: var(--danger); }

  .chart-wrapper { position: relative; height: 260px; width: 100%; }
  canvas { display: block; width: 100%; }
  .empty-state { text-align: center; color: var(--muted); padding: 20px; font-size: 0.85rem; }
  .save-notice { font-size: 0.7rem; color: var(--safe); margin-top: 8px; text-align: center; display: none; }
  #results { display: none; }
  #results.visible { display: block; }
  .badge-warn { display: inline-block; background: rgba(196,113,90,0.15); color: var(--danger); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; border: 1px solid var(--danger); margin-left: 6px; transform: scale(0.9); transform-origin: left center;}
  .badge-rule { display: inline-block; background: rgba(106,170,142,0.15); color: var(--safe); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; border: 1px solid var(--safe); margin-left: 4px; transform: scale(0.9); transform-origin: left center; }
  .deferred-interest { color: var(--danger); font-size: 0.75rem; margin-top: 8px; padding: 8px; border: 1px solid var(--danger); border-radius: 6px; background: rgba(196,113,90,0.05); display: none; }
  
  .tool-content { display: none; animation: fadeIn 0.3s ease; }
  .tool-content.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  .tool-summary { background: rgba(106,170,142,0.1); border: 1px solid var(--safe); border-radius: 8px; padding: 12px; margin-top: 16px; text-align: center; }
  .tool-summary-label { font-size: 0.7rem; color: var(--safe); margin-bottom: 4px; }
  .tool-summary-val { font-size: 1.2rem; font-family: 'DM Mono', monospace; color: var(--text); }
  
  .refi-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 8px 0; font-size: 0.8rem; }
  .refi-row span:last-child { font-family: 'DM Mono', monospace; }
  .refi-row.has-sub { border-bottom: none; padding-bottom: 4px; }
  .refi-row.sub { border-bottom: none; padding: 2px 0 2px 14px; font-size: 0.72rem; color: var(--muted); }
  .refi-row.sub span:last-child { font-size: 0.75rem; }
  .refi-row.sub-last { border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  .refi-diff { font-weight: bold; }
  .refi-diff.plus { color: var(--danger); }
  .refi-diff.minus { color: var(--safe); }

  .tax-badge {
    display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: bold;
    letter-spacing: 0; text-transform: none;
  }
  .tax-short { background: rgba(196,113,90,0.15); color: var(--danger); border: 1px solid var(--danger); }
  .tax-long { background: rgba(106,170,142,0.15); color: var(--safe); border: 1px solid var(--safe); }
  .tax-reduced { background: rgba(90,139,196,0.15); color: var(--info); border: 1px solid var(--info); }

  .calc-breakdown { margin-top: 16px; }
  .step-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 12px;
  }
  .step-title {
    font-size: 0.75rem; color: var(--accent); font-weight: 600;
    margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
  }
  .step-num {
    background: var(--accent); color: var(--bg); border-radius: 50%; width: 18px; height: 18px;
    display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: bold;
  }
  .step-row {
    display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.75rem; color: var(--text);
  }
  .step-row.sub {
    padding-left: 12px; color: var(--muted); font-size: 0.7rem;
  }
  .step-row.result {
    border-top: 1px dashed var(--border); margin-top: 6px; padding-top: 6px; font-weight: bold; color: var(--accent2);
  }
  .step-row span:last-child {
    font-family: 'DM Mono', monospace; text-align: right; min-width: 80px;
  }

  /* å¤–éƒ¨ãƒªãƒ³ã‚¯ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer-links {
    margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);
    text-align: center; padding-bottom: 40px;
  }
  .external-link {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 0.75rem; color: var(--muted); text-decoration: none;
    transition: color 0.2s;
  }
  .external-link:hover { color: var(--accent); text-decoration: underline; }
  .external-link::before { content: 'ğŸ”—'; font-size: 0.8rem; }

  /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .field-error { font-size: 0.7rem; color: var(--danger); margin-top: 2px; display: none; }
  .field-error.show { display: block; }
  .input-error { border-color: var(--danger) !important; }

  /* ç¹°ã‚Šä¸Šã’è¿”æ¸ˆ */
  .prepay-type-row { display: flex; gap: 8px; margin-bottom: 16px; }
  .prepay-type-btn { flex: 1; padding: 10px 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); cursor: pointer; font-size: 0.78rem; text-align: center; transition: all 0.2s; font-family: 'Noto Serif JP', serif; }
  .prepay-type-btn.active { background: rgba(200,169,110,0.15); border-color: var(--accent); color: var(--accent2); font-weight: 600; }
  .prepay-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
  .prepay-result-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; text-align: center; }
  .prepay-result-box.highlight { border-color: var(--safe); background: rgba(106,170,142,0.07); }
  .prepay-result-label { font-size: 0.68rem; color: var(--muted); margin-bottom: 6px; }
  .prepay-result-val { font-family: 'DM Mono', monospace; font-size: 1.05rem; color: var(--text); }
  .prepay-result-val.green { color: var(--safe); }
  .prepay-result-val.gold { color: var(--accent2); }

  /* é‡‘åˆ©ã‚·ãƒŠãƒªã‚ª */
  .scenario-toggles { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
  .scenario-btn { padding: 5px 10px; border-radius: 6px; border: 1px solid; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; font-family: 'Noto Serif JP', serif; background: transparent; }
  .scenario-btn.s0 { border-color: #5a8bc4; color: #5a8bc4; }
  .scenario-btn.s0.active { background: #5a8bc4; color: #fff; }
  .scenario-btn.s1 { border-color: #c8a96e; color: #c8a96e; }
  .scenario-btn.s1.active { background: #c8a96e; color: #0f0e0c; }
  .scenario-btn.s2 { border-color: #c4715a; color: #c4715a; }
  .scenario-btn.s2.active { background: #c4715a; color: #fff; }

  /* å£²å´æç›Šåˆ†å²ç‚¹ */
  .breakeven-box { background: rgba(90,139,196,0.08); border: 1px solid var(--info); border-radius: 8px; padding: 12px 16px; margin-top: 12px; display: none; }
  .breakeven-label { font-size: 0.7rem; color: var(--info); margin-bottom: 4px; }
  .breakeven-val { font-family: 'DM Mono', monospace; font-size: 1.1rem; color: var(--text); }

  /* æŠ˜ã‚ŠãŸãŸã¿ã‚«ãƒ¼ãƒ‰ */
  .collapsible-header {
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; user-select: none; -webkit-user-select: none;
  }
  .collapsible-header:hover .collapse-icon { color: var(--accent2); }
  .collapse-icon {
    font-size: 0.85rem; color: var(--muted); transition: transform 0.25s ease;
    flex-shrink: 0; margin-left: 8px;
  }
  .collapse-icon.open { transform: rotate(180deg); }
  .collapsible-body {
    overflow: hidden;
    transition: max-height 0.35s ease, opacity 0.25s ease;
    max-height: 0; opacity: 0; pointer-events: none;
  }
  .collapsible-body.open { max-height: 9999px; opacity: 1; pointer-events: auto; }

  /* å…±æœ‰ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ */
  .share-notice { font-size: 0.72rem; color: var(--safe); margin-top: 6px; text-align: center; display: none; }

  /* PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ */
  #pwaInstallBanner { display: none; position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: var(--surface); border: 1px solid var(--accent); border-radius: 12px; padding: 12px 16px; z-index: 999; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; width: calc(100% - 32px); max-width: 420px; }
  #pwaInstallBanner p { font-size: 0.78rem; color: var(--text); margin-bottom: 10px; }
  #pwaInstallBanner .pwa-btns { display: flex; gap: 8px; }
</style>
</head>
<body>

<div id="pwaInstallBanner">
  <p>ğŸ“± ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã€ã„ã¤ã§ã‚‚ã™ãã«ä½¿ãˆã¾ã™</p>
  <div class="pwa-btns">
    <button class="btn" style="margin-top:0; flex:1;" id="pwaInstallBtn">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
    <button class="btn" style="margin-top:0; flex:0.4; background:var(--surface2); color:var(--muted); border:1px solid var(--border);" onclick="document.getElementById('pwaInstallBanner').style.display='none'">å¾Œã§</button>
  </div>
</div>

<div class="header">
  <h1>ä½å®…ãƒ­ãƒ¼ãƒ³ç®¡ç†</h1>
  <p>è¿”æ¸ˆçŠ¶æ³ãƒ»å¤‰å‹•é‡‘åˆ©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</p>
</div>

<div class="card">
  <div class="card-title collapsible-header" onclick="toggleCard('bodyLoan')">
    <span>ãƒ­ãƒ¼ãƒ³æƒ…å ±ã®å…¥åŠ›</span>
    <span class="collapse-icon open" id="iconLoan">â–¼</span>
  </div>
  <div class="collapsible-body open" id="bodyLoan">
  <div class="form-grid">
    <div class="form-group">
      <label>å€Ÿå…¥é‡‘é¡ï¼ˆä¸‡å††ï¼‰</label>
      <input type="number" id="principal" value="4700" min="1">
    </div>
    <div class="form-group">
      <label>å½“åˆå¹´åˆ©ï¼ˆ%ï¼‰</label>
      <input type="number" id="rate" value="0.25" step="0.001" min="0.01">
    </div>
    <div class="form-group">
      <label>è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</label>
      <input type="number" id="years" value="35" min="1" max="50">
    </div>
    <div class="form-group">
      <label>è¿”æ¸ˆæ–¹å¼</label>
      <select id="method" onchange="toggleRulesVisibility()">
        <option value="equal_payment">å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</option>
        <option value="equal_principal">å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</option>
      </select>
    </div>
    <div class="form-group">
      <label>å€Ÿå…¥é–‹å§‹å¹´æœˆ (ç‰©ä»¶è³¼å…¥æœˆ)</label>
      <input type="month" id="startDate" value="2024-03">
    </div>
    <div class="form-group">
      <label>ç«¯æ•°å‡¦ç†</label>
      <select id="roundingMode">
        <option value="floor" selected>åˆ‡ã‚Šæ¨ã¦ (æ¨å¥¨)</option>
        <option value="round">å››æ¨äº”å…¥</option>
        <option value="ceil">åˆ‡ã‚Šä¸Šã’</option>
      </select>
    </div>
  </div>

  <div id="ruleOptionContainer" style="margin-top: 16px;">
    <div class="checkbox-group">
      <input type="checkbox" id="useJibunRules" checked>
      <label for="useJibunRules">5å¹´ãƒ«ãƒ¼ãƒ«ãƒ»125%ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹</label>
    </div>
    <div class="rule-desc">
      â€»é‡‘åˆ©ä¸Šæ˜‡æ™‚ã‚‚5å¹´é–“ã¯è¿”æ¸ˆé¡ã‚’æ®ãˆç½®ãã€ä¸Šæ˜‡å¹…ã‚‚25%ä»¥å†…ã«æŠ‘ãˆã¾ã™ã€‚
    </div>
  </div>

  <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border);">
    <div class="card-title">ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆ (æœˆé¡)</div>
    <div class="form-grid">
      <div class="form-group">
        <label>ç®¡ç†è²» (å††)</label>
        <input type="number" id="costAdmin" placeholder="0">
      </div>
      <div class="form-group">
        <label>ä¿®ç¹•ç©ç«‹é‡‘ (å††)</label>
        <input type="number" id="costRepair" placeholder="0">
      </div>
      <div class="form-group">
        <label>é§è»Šå ´ãƒ»ãã®ä»– (å††)</label>
        <input type="number" id="costOther" placeholder="0">
      </div>
    </div>
  </div>

  <div class="rate-section">
    <div class="rate-section-header">
      <span class="rate-section-title">ğŸ“ˆ é‡‘åˆ©å¤‰å‹•ã®è¿½åŠ </span>
      <button class="btn-outline" onclick="showRateForm()">ï¼‹ äºˆå®šã‚’è¿½åŠ </button>
    </div>
    <div id="rateChangeList">
      <div class="empty-state" style="padding:10px; font-size:0.78rem;">é‡‘åˆ©å¤‰æ›´ãªã—</div>
    </div>
    <div class="rate-add-form" id="rateAddForm">
      <div class="form-grid" style="margin-bottom:12px;">
        <div class="form-group">
          <label>é©ç”¨é–‹å§‹å¹´æœˆ</label>
          <input type="month" id="rcMonthDate">
        </div>
        <div class="form-group">
          <label>å¤‰æ›´å¾Œã®å¹´åˆ© (%)</label>
          <input type="number" id="rcRate" step="0.01" placeholder="0.5" min="0.01">
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" style="margin-top:0;" onclick="confirmRateChange()">ä¿å­˜ã—ã¦é©ç”¨</button>
        <button class="btn" style="margin-top:0; background:var(--surface); color:var(--muted); border:1px solid var(--border);" onclick="hideRateForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <button class="btn" onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
  <div class="save-notice" id="saveNotice">âœ“ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>
  </div><!-- /collapsible-body -->
</div>

<div id="results">
  
  <div class="total-cost-banner">
    <div class="total-cost-label">æ¯æœˆã®ä½å±…è²» åˆè¨ˆ</div>
    <div class="total-cost-value" id="totalMonthlyCost">0å††</div>
    <div class="total-cost-detail">
      ( ãƒ­ãƒ¼ãƒ³: <span id="detailLoan">0</span> + ç®¡ç†è²»ç­‰: <span id="detailRun">0</span> )
    </div>
  </div>

  <div class="stats-section-label">è¿”æ¸ˆé¡ã®æ¯”è¼ƒ (ãƒ­ãƒ¼ãƒ³ã®ã¿)</div>
  <div class="stats-grid-4">
    <div class="stat-box">
      <div class="stat-label">å½“åˆ æœˆè¿”æ¸ˆé¡</div>
      <div class="stat-value" id="statInitial">â€”</div>
      <div class="stat-sub">å€Ÿå…¥é–‹å§‹æ™‚ã®ãŠæ”¯æ‰•é¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">ç¾åœ¨ æœˆè¿”æ¸ˆé¡</div>
      <div class="stat-value accent" id="statCurrent">â€”</div>
      <div class="stat-sub">ç¾åœ¨ã®é‡‘åˆ©ã§ã®ãŠæ”¯æ‰•é¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">5å¹´ãƒ»125%ãƒ«ãƒ¼ãƒ«ãŒ<br>ãªã‹ã£ãŸå ´åˆ</div>
      <div class="stat-value" id="statTheoretical" style="color:var(--muted)">â€”</div>
      <div class="stat-sub" id="statTheoreticalDiff"></div>
    </div>
    <div class="stat-box" style="border-color:var(--safe); background:rgba(106,170,142,0.05);">
      <div class="stat-label" style="color:var(--safe)">æ¬¡å› è¦‹ç›´ã—äºˆå®š</div>
      <div class="stat-value" style="color:var(--safe)" id="statNextChange">â€”</div>
      <div class="stat-sub" id="statNextChangeDate">5å¹´ãƒ«ãƒ¼ãƒ«ã®æ¬¡å›é©ç”¨æ™‚</div>
    </div>
  </div>

  <div class="stats-section-label">ç·æ”¯æ‰•ãƒ»é€²æ—çŠ¶æ³</div>
  <div class="stats-grid-3">
    <div class="stat-box">
      <div class="stat-label">ç·åˆ©æ¯</div>
      <div class="stat-value danger" id="statTotalInterest">â€”</div>
      <div class="stat-sub">å…¨æœŸé–“ã§æ‰•ã†åˆ©æ¯ã®åˆè¨ˆ</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">ç·æ”¯æ‰•é¡</div>
      <div class="stat-value" id="statTotal">â€”</div>
      <div class="stat-sub">å…ƒé‡‘ï¼‹åˆ©æ¯ã®æœ€çµ‚åˆè¨ˆé¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">è¿”æ¸ˆé€²æ—</div>
      <div class="stat-value" id="progressPct">â€”</div>
      <div class="stat-sub">å½“åˆå…ƒé‡‘ã«å¯¾ã™ã‚‹è¿”æ¸ˆæ¸ˆã¿å‰²åˆ</div>
    </div>
  </div>

  <div id="deferredWarning" class="deferred-interest">
    âš ï¸ <strong>æ³¨æ„:</strong> æœªæ‰•åˆ©æ¯ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
  </div>

  <div class="card">
    <div class="card-title">æ®‹é«˜æ¨ç§»</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-labels">
      <span id="paidAmount">â€”</span>
      <span>æ®‹é«˜: <span id="remainBalance">â€”</span></span>
    </div>
    <div style="margin-top:12px; font-size:0.78rem; color:var(--muted); text-align:right;">
      æ®‹ã‚ŠæœŸé–“: <span style="color:var(--text); font-family:'DM Mono',monospace;" id="remainMonths">â€”</span>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('graph')">å†…è¨³ã‚°ãƒ©ãƒ•</div>
      <div class="tab" onclick="switchTab('balance')">æ®‹é«˜æ¨ç§»</div>
      <div class="tab" onclick="switchTab('scenario')">é‡‘åˆ©ã‚·ãƒŠãƒªã‚ª</div>
      <div class="tab" onclick="switchTab('cumulative')">ç´¯è¨ˆã‚³ã‚¹ãƒˆ</div>
      <div class="tab" onclick="switchTab('schedule')">è¿”æ¸ˆä¸€è¦§</div>
    </div>

    <div id="tab-graph">
      <p style="text-align:center; font-size:0.75rem; color:var(--muted); margin-bottom:10px;">
        <span style="display:inline-block; width:10px; height:10px; background:var(--principal); margin-right:4px;"></span>å…ƒé‡‘
        <span style="display:inline-block; width:10px; height:10px; background:var(--interest); margin-right:4px; margin-left:10px;"></span>åˆ©æ¯
      </p>
      <div class="chart-wrapper">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div id="tab-balance" style="display:none">
      <p style="font-size:0.72rem; color:var(--muted); margin-bottom:10px; text-align:center;">
        <span style="display:inline-block; width:8px; height:8px; background:var(--info); border-radius:50%; margin-right:3px;"></span>ãƒ­ãƒ¼ãƒ³æ®‹é«˜
        <span style="display:inline-block; width:8px; height:8px; background:var(--accent); border-radius:50%; margin-right:3px; margin-left:8px;"></span>è¿”æ¸ˆæ¸ˆã¿å…ƒé‡‘
      </p>
      <div class="chart-wrapper">
        <canvas id="balanceChart"></canvas>
      </div>
    </div>

    <div id="tab-scenario" style="display:none">
      <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
        <p style="font-size:0.72rem; color:var(--muted); margin:0;">
          <span style="display:inline-block; width:8px; height:8px; background:var(--info); border-radius:50%; margin-right:3px;"></span>ç¾çŠ¶ç¶­æŒ
          <span style="display:inline-block; width:8px; height:8px; background:#c8a96e; border-radius:50%; margin-right:3px; margin-left:8px;"></span>+0.5%
          <span style="display:inline-block; width:8px; height:8px; background:#c4715a; border-radius:50%; margin-right:3px; margin-left:8px;"></span>+1.0%
        </p>
        <div class="scenario-toggles" style="margin:0;">
          <button class="scenario-btn s0 active" onclick="toggleScenario(0,this)">ç¾çŠ¶</button>
          <button class="scenario-btn s1 active" onclick="toggleScenario(1,this)">+0.5%</button>
          <button class="scenario-btn s2 active" onclick="toggleScenario(2,this)">+1.0%</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="scenarioChart"></canvas>
      </div>
      <p style="font-size:0.65rem; color:var(--muted); margin-top:8px; text-align:right;">â€»ä»Šæœˆä»¥é™ã®é‡‘åˆ©ãŒä¸€å¾‹ã§ä¸Šæ˜‡ã—ãŸå ´åˆã®æœˆè¿”æ¸ˆé¡æ¨ç§»</p>
    </div>

    <div id="tab-cumulative" style="display:none">
      <p style="font-size:0.72rem; color:var(--muted); margin-bottom:10px; text-align:center;">
        <span style="display:inline-block; width:8px; height:8px; background:#c4715a; border-radius:50%; margin-right:3px;"></span>ãƒ­ãƒ¼ãƒ³ç´¯è¨ˆ
        <span style="display:inline-block; width:8px; height:8px; background:#5a8bc4; border-radius:50%; margin-right:3px; margin-left:8px;"></span>ä½å±…è²»ç´¯è¨ˆï¼ˆç®¡ç†è²»ç­‰å«ã‚€ï¼‰
      </p>
      <div class="chart-wrapper">
        <canvas id="cumulativeChart"></canvas>
      </div>
      <p style="font-size:0.65rem; color:var(--muted); margin-top:8px; text-align:right;">â€»ç®¡ç†è²»ç­‰ã¯ç¾åœ¨ã®å…¥åŠ›å€¤ãŒå…¨æœŸé–“ç¶šãã¨ä»®å®š</p>
    </div>

    <div id="tab-schedule" style="display:none">
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>å¹´æœˆ</th><th>è¿”æ¸ˆé¡(å††)</th><th>å…ƒé‡‘(å††)</th><th>åˆ©æ¯(å††)</th><th>æ®‹é«˜(å††)</th></tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card" style="border-top:3px solid var(--accent2)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodyPrepay')">
      <span>ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
      <span class="collapse-icon" id="iconPrepay">â–¼</span>
    </div>
    <div class="collapsible-body" id="bodyPrepay">
    <p style="font-size:0.75rem; color:var(--muted); margin-bottom:14px; margin-top:4px;">ä»Šã™ãç¹°ã‚Šä¸Šã’è¿”æ¸ˆã—ãŸå ´åˆã®åŠ¹æœï¼ˆåˆ©æ¯å‰Šæ¸›é¡ãƒ»æœŸé–“çŸ­ç¸®ï¼‰ã‚’è©¦ç®—ã—ã¾ã™ã€‚</p>

    <div class="prepay-type-row">
      <button class="prepay-type-btn active" id="prepayTypeShorten" onclick="setPrepayType('shorten')">ğŸ“… æœŸé–“çŸ­ç¸®å‹<br><span style="font-size:0.65rem; font-weight:400;">è¿”æ¸ˆæœŸé–“ã‚’ç¸®ã‚ã‚‹</span></button>
      <button class="prepay-type-btn" id="prepayTypeReduce" onclick="setPrepayType('reduce')">ğŸ’´ è¿”æ¸ˆé¡è»½æ¸›å‹<br><span style="font-size:0.65rem; font-weight:400;">æœˆè¿”æ¸ˆé¡ã‚’ä¸‹ã’ã‚‹</span></button>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label>ç¹°ã‚Šä¸Šã’è¿”æ¸ˆé¡ (ä¸‡å††)</label>
        <input type="number" id="prepayAmount" inputmode="decimal" placeholder="ä¾‹ï¼š100" min="1">
        <span class="field-error" id="prepayAmountErr">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
      </div>
      <div class="form-group">
        <label>å®Ÿè¡Œæ™‚æœŸ</label>
        <select id="prepayTiming">
          <option value="now">ä»Šã™ãï¼ˆä»Šæœˆï¼‰</option>
          <option value="6">6ãƒ¶æœˆå¾Œ</option>
          <option value="12">1å¹´å¾Œ</option>
          <option value="24">2å¹´å¾Œ</option>
          <option value="36">3å¹´å¾Œ</option>
          <option value="60">5å¹´å¾Œ</option>
        </select>
      </div>
    </div>

    <button class="btn" style="background:var(--accent2); color:#0f0e0c; margin-top:12px;" onclick="calcPrepayment()">åŠ¹æœã‚’è¨ˆç®—</button>

    <div id="prepayResult" style="display:none; margin-top:4px;">
      <div class="prepay-result-grid">
        <div class="prepay-result-box highlight">
          <div class="prepay-result-label">ğŸ’° åˆ©æ¯å‰Šæ¸›é¡</div>
          <div class="prepay-result-val green" id="prepayInterestSaved">â€”</div>
        </div>
        <div class="prepay-result-box highlight" id="prepayMainBox">
          <div class="prepay-result-label" id="prepayMainLabel">â± æœŸé–“çŸ­ç¸®</div>
          <div class="prepay-result-val gold" id="prepayMainVal">â€”</div>
        </div>
        <div class="prepay-result-box">
          <div class="prepay-result-label">ç¹°ã‚Šä¸Šã’å‰ ç·åˆ©æ¯</div>
          <div class="prepay-result-val" id="prepayOldInterest">â€”</div>
        </div>
        <div class="prepay-result-box">
          <div class="prepay-result-label">ç¹°ã‚Šä¸Šã’å¾Œ ç·åˆ©æ¯</div>
          <div class="prepay-result-val" id="prepayNewInterest">â€”</div>
        </div>
      </div>
      <p style="font-size:0.65rem; color:var(--muted); margin-top:10px; text-align:right;">â€»5å¹´ãƒ«ãƒ¼ãƒ«ãƒ»125%ãƒ«ãƒ¼ãƒ«ã¯è€ƒæ…®ã›ãšè¨ˆç®—ã—ã¦ã„ã¾ã™</p>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <div class="card" style="border-top:3px solid var(--accent)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodyTools')">
      <span>ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ãƒ»è¨­å®š</span>
      <span class="collapse-icon" id="iconTools">â–¼</span>
    </div>
    <div class="collapsible-body" id="bodyTools">
    <div class="tools-tabs" style="margin-top:4px;">
      <div class="tools-tab active" onclick="switchTool('tax')">ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤</div>
      <div class="tools-tab" onclick="switchTool('refi')">å€Ÿã‚Šæ›ãˆè©¦ç®—</div>
      <div class="tools-tab" onclick="switchTool('data')">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    </div>

    <div id="tool-tax" class="tool-content active">
      <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px;">å¹´æœ«æ®‹é«˜ã‚’ã‚‚ã¨ã«æ§é™¤é¡ã‚’è©¦ç®—ã—ã¾ã™ã€‚</p>
      <div class="form-grid">
        <div class="form-group">
          <label>æ§é™¤æœŸé–“</label>
          <select id="taxPeriod">
            <option value="13">13å¹´é–“</option>
            <option value="10">10å¹´é–“</option>
          </select>
        </div>
        <div class="form-group">
          <label>æ§é™¤ç‡ (%)</label>
          <input type="number" id="taxRate" value="0.7" step="0.1">
        </div>
        <div class="form-group">
          <label>å€Ÿå…¥é™åº¦é¡ (ä¸‡å††)</label>
          <select id="taxLimit">
            <option value="2000">2000ä¸‡å††</option>
            <option value="3000" selected>3000ä¸‡å††</option>
            <option value="4000">4000ä¸‡å††</option>
            <option value="4500">4500ä¸‡å††</option>
            <option value="5000">5000ä¸‡å††</option>
          </select>
        </div>
      </div>
      <button class="btn" style="margin-top:12px" onclick="calcTaxDeduction()">æ§é™¤é¡ã‚’è¨ˆç®—</button>
      <div id="taxResult" style="display:none;">
        <div class="tool-summary">
          <div class="tool-summary-label">ç·æ§é™¤é¡ï¼ˆç›®å®‰ï¼‰</div>
          <div class="tool-summary-val" id="taxTotalVal">0å††</div>
          <div style="font-size:0.65rem; color:var(--muted); margin-top:4px;">â€»æ‰€å¾—ç¨ãƒ»ä½æ°‘ç¨ã®ä¸Šé™ç­‰ã¯è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>
    </div>

    <div id="tool-refi" class="tool-content">
      <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px;">ç¾åœ¨ã®æ®‹é«˜ã§å€Ÿã‚Šæ›ãˆãŸå ´åˆã®æå¾—ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
      <div class="form-grid">
        <div class="form-group">
          <label>å€Ÿã‚Šæ›ãˆé‡‘åˆ© (%)</label>
          <input type="number" id="refiRate" value="0.4" step="0.001">
        </div>
        <div class="form-group">
          <label>äº‹å‹™æ‰‹æ•°æ–™ (%)</label>
          <input type="number" id="refiFeeRate" value="2.2" step="0.1">
        </div>
        <div class="form-group">
          <label>ãã®ä»–è«¸è²»ç”¨ (ä¸‡å††)</label>
          <input type="number" id="refiFixCost" value="20" placeholder="ç™»è¨˜è²»ç”¨ãªã©">
        </div>
      </div>
      <button class="btn" style="margin-top:12px" onclick="calcRefinance()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
      
      <div id="refiResult" style="display:none; margin-top:16px;">
        <div class="refi-row has-sub">
          <span>ç¾åœ¨ã®æ®‹ã‚Šç·æ”¯æ‰•</span>
          <span id="refiOldTotal">â€”</span>
        </div>
        <div class="refi-row sub">
          <span>â”— æ®‹ã‚Šå…ƒé‡‘ (ç¾åœ¨æ®‹é«˜)</span>
          <span id="refiOldPrincipal">â€”</span>
        </div>
        <div class="refi-row sub sub-last">
          <span>â”— æ®‹ã‚Šåˆ©æ¯</span>
          <span id="refiOldInterest">â€”</span>
        </div>

        <div class="refi-row has-sub" style="margin-top:8px;">
          <span>å€Ÿã‚Šæ›ãˆå¾Œç·æ”¯æ‰•(è«¸è²»ç”¨è¾¼)</span>
          <span id="refiNewTotal">â€”</span>
        </div>
        <div class="refi-row sub">
          <span>â”— ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆåˆ†</span>
          <span id="refiNewLoan">â€”</span>
        </div>
        <div class="refi-row sub sub-last">
          <span>â”— è«¸è²»ç”¨ (æ‰‹æ•°æ–™ç­‰)</span>
          <span id="refiCost">â€”</span>
        </div>
        
        <div class="tool-summary">
          <div class="tool-summary-label">å€Ÿã‚Šæ›ãˆåŠ¹æœ</div>
          <div class="tool-summary-val refi-diff" id="refiDiffVal">0å††</div>
          <div style="font-size:0.65rem; color:var(--muted); margin-top:4px;">â€»ãƒ—ãƒ©ã‚¹ãªã‚‰å€Ÿã‚Šæ›ãˆãŸæ–¹ãŒãŠå¾—ã§ã™</div>
        </div>
      </div>
    </div>

    <div id="tool-data" class="tool-content">
      <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px;">è¨­å®šã®ä¿å­˜ã‚„ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®æ›¸ãå‡ºã—ã‚’è¡Œãˆã¾ã™ã€‚</p>
      <div style="display:flex; gap:10px; flex-direction:column;">
        <button class="btn-outline" onclick="copyShareLink()">ğŸ”— ã“ã®è¨­å®šã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
        <div class="share-notice" id="shareNotice">âœ“ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
        <button class="btn-outline" onclick="exportData()">ğŸ’¾ è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</button>
        <button class="btn-outline" onclick="exportCSV()">ğŸ“Š è¿”æ¸ˆäºˆå®šã‚’CSVã§ä¿å­˜</button>
        <div style="position:relative; margin-top:8px;">
           <label class="btn" style="display:block; text-align:center; margin:0;">
             ğŸ“‚ è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
             <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
           </label>
        </div>
      </div>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <div class="card" style="border-top:3px solid var(--safe)">
    <div class="card-title collapsible-header" onclick="toggleCard('bodySale')">
      <span>å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (æ‰‹å–ã‚Šé¡è¨ˆç®—)</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <span id="taxBadge" class="tax-badge" style="display:none;"></span>
        <span class="collapse-icon" id="iconSale">â–¼</span>
      </div>
    </div>
    <div class="collapsible-body" id="bodySale">
    <p style="font-size:0.75rem; color:var(--muted); margin-bottom:12px; margin-top:4px;">æŒ‡å®šã—ãŸæ™‚æœŸã®ãƒ­ãƒ¼ãƒ³æ®‹é«˜ã‚„ç¨é‡‘ã‚’å·®ã—å¼•ãã€æœ€çµ‚çš„ãªæ‰‹å–ã‚Šé¡ã‚’è©¦ç®—ã—ã¾ã™ã€‚</p>
    <div class="form-grid">
      <div class="form-group">
        <label>å£²å´äºˆå®šæ™‚æœŸ</label>
        <input type="month" id="saleDate" value="2034-03">
      </div>
      <div class="form-group">
        <label>å£²å´äºˆå®šé¡ (ä¸‡å††)</label>
        <input type="number" id="salePrice" value="5500" step="10">
      </div>
      <div class="form-group">
        <label>è³¼å…¥ä¾¡æ ¼ (ä¸‡å††)</label>
        <input type="number" id="purchasePrice" value="4700">
      </div>
      <div class="form-group">
        <label>è³¼å…¥æ™‚ã®è«¸è²»ç”¨ (ä¸‡å††)</label>
        <input type="number" id="purchaseCost" value="300" placeholder="ä»²ä»‹æ‰‹æ•°æ–™ç­‰">
      </div>
    </div>
    
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:16px;">
      <div class="checkbox-group" style="margin-top:0;">
        <input type="checkbox" id="use30mDeduction" checked>
        <label for="use30mDeduction">å±…ä½ç”¨è²¡ç”£ã®3,000ä¸‡å††ç‰¹åˆ¥æ§é™¤ã‚’é©ç”¨ã™ã‚‹</label>
      </div>
      <div class="checkbox-group" style="margin-top:0;">
        <input type="checkbox" id="use10yRate" checked>
        <label for="use10yRate">10å¹´è¶…ã®è»½æ¸›ç¨ç‡ (14.21%) ã‚’é©ç”¨ã™ã‚‹</label>
      </div>
      <div style="font-size:0.65rem; color:var(--danger); margin-top:-4px;">â€»ä¸Šè¨˜2ã¤ã®ç‰¹ä¾‹ã¯ã€æ–°å±…ã§ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ä½µç”¨ã§ãã¾ã›ã‚“ã€‚</div>
    </div>
    
    <button class="btn" style="background:var(--safe); color:#fff; margin-top:16px" onclick="calcSale()">å£²å´æ‰‹å–ã‚Šé¡ã‚’è¨ˆç®—</button>

    <div id="saleResult" style="display:none; margin-top:20px;">
      <div class="tool-summary" style="background:rgba(106,170,142,0.1); border-color:var(--safe); margin-bottom:16px;">
        <div class="tool-summary-label">æœ€çµ‚æ‰‹å–ã‚Šé¡ (è¦‹è¾¼ã¿)</div>
        <div class="tool-summary-val" id="saleResNet" style="color:var(--text); font-size:1.6rem;">0å††</div>
      </div>

      <div class="breakeven-box" id="breakevenBox">
        <div class="breakeven-label">ğŸ“ å£²å´æ‰‹å–ã‚ŠãŒãƒ—ãƒ©ã‚¹ã«ãªã‚‹æœ€çŸ­æ™‚æœŸ</div>
        <div class="breakeven-val" id="breakevenVal">â€”</div>
      </div>

      <div class="calc-breakdown" id="calcBreakdown"></div>
    </div>
    </div><!-- /collapsible-body -->
  </div>

  <footer class="footer-links">
    <a href="https://www.jibunbank.co.jp/interest_and_commission/interest/#flg-interestHistory" target="_blank" class="external-link">
      auã˜ã¶ã‚“éŠ€è¡Œ å¤‰å‹•é‡‘åˆ©ã®åŸºæº–é‡‘åˆ© æ”¹å®šå±¥æ­´
    </a>
  </footer>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
<script>
let scheduleData = [];
let noRuleData = [];
let chartInstance = null;
let rateChanges = [];

/* --- Core Functions --- */

function toggleCard(bodyId) {
  const body = document.getElementById(bodyId);
  const iconId = 'icon' + bodyId.replace('body', '');
  const icon = document.getElementById(iconId);
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (icon) icon.classList.toggle('open', !isOpen);
}

function saveSettings() {
  const data = {
    principal: document.getElementById('principal').value,
    rate: document.getElementById('rate').value,
    years: document.getElementById('years').value,
    method: document.getElementById('method').value,
    startDate: document.getElementById('startDate').value,
    useJibunRules: document.getElementById('useJibunRules').checked,
    roundingMode: document.getElementById('roundingMode').value,
    rateChanges,
    costAdmin: document.getElementById('costAdmin').value,
    costRepair: document.getElementById('costRepair').value,
    costOther: document.getElementById('costOther').value,
    saleDate: document.getElementById('saleDate').value,
    salePrice: document.getElementById('salePrice').value,
    purchasePrice: document.getElementById('purchasePrice').value,
    purchaseCost: document.getElementById('purchaseCost').value,
    use30mDeduction: document.getElementById('use30mDeduction').checked,
    use10yRate: document.getElementById('use10yRate').checked
  };
  localStorage.setItem('mortgage_settings_v13', JSON.stringify(data));
  const n = document.getElementById('saveNotice');
  n.style.display = 'block';
  setTimeout(() => n.style.display = 'none', 2000);
  return data;
}

function loadSettings() {
  const s = localStorage.getItem('mortgage_settings_v13');
  if (!s) return;
  try {
    const d = JSON.parse(s);
    if (d.principal) document.getElementById('principal').value = d.principal;
    if (d.rate) document.getElementById('rate').value = d.rate;
    if (d.years) document.getElementById('years').value = d.years;
    if (d.method) document.getElementById('method').value = d.method;
    if (d.startDate) document.getElementById('startDate').value = d.startDate;
    if (d.useJibunRules !== undefined) document.getElementById('useJibunRules').checked = d.useJibunRules;
    if (d.roundingMode) document.getElementById('roundingMode').value = d.roundingMode;
    if (d.costAdmin) document.getElementById('costAdmin').value = d.costAdmin;
    if (d.costRepair) document.getElementById('costRepair').value = d.costRepair;
    if (d.costOther) document.getElementById('costOther').value = d.costOther;
    
    if (d.saleDate) document.getElementById('saleDate').value = d.saleDate;
    if (d.salePrice) document.getElementById('salePrice').value = d.salePrice;
    if (d.purchasePrice) document.getElementById('purchasePrice').value = d.purchasePrice;
    if (d.purchaseCost) document.getElementById('purchaseCost').value = d.purchaseCost;
    if (d.use30mDeduction !== undefined) document.getElementById('use30mDeduction').checked = d.use30mDeduction;
    if (d.use10yRate !== undefined) document.getElementById('use10yRate').checked = d.use10yRate;

    if (d.rateChanges) { rateChanges = d.rateChanges; renderRateChanges(); }
    toggleRulesVisibility();
  } catch(e) {}
}

function toggleRulesVisibility() {
  const method = document.getElementById('method').value;
  const container = document.getElementById('ruleOptionContainer');
  if (method === 'equal_payment') {
    container.style.opacity = '1';
    container.style.pointerEvents = 'auto';
  } else {
    container.style.opacity = '0.5';
    container.style.pointerEvents = 'none';
  }
}

/* --- Rate Change UI --- */
function showRateForm() { 
  document.getElementById('rateAddForm').style.display = 'block';
  if (!document.getElementById('rcMonthDate').value) {
    document.getElementById('rcMonthDate').value = document.getElementById('startDate').value;
  }
}
function hideRateForm() { document.getElementById('rateAddForm').style.display = 'none'; }

function confirmRateChange() {
  const startDateStr = document.getElementById('startDate').value;
  const targetDateStr = document.getElementById('rcMonthDate').value;
  const rate = parseFloat(document.getElementById('rcRate').value);

  if (!startDateStr || !targetDateStr || isNaN(rate)) { alert('å¹´æœˆã¨é‡‘åˆ©ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const start = new Date(startDateStr + "-01");
  const target = new Date(targetDateStr + "-01");
  const monthDiff = (target.getFullYear() - start.getFullYear()) * 12 + (target.getMonth() - start.getMonth()) + 1;

  if (monthDiff < 1) { alert('å€Ÿå…¥é–‹å§‹æœˆã‚ˆã‚Šå‰ã®å¹´æœˆã¯æŒ‡å®šã§ãã¾ã›ã‚“'); return; }

  rateChanges = rateChanges.filter(r => r.month !== monthDiff);
  rateChanges.push({ month: monthDiff, rate: rate });
  rateChanges.sort((a, b) => a.month - b.month);
  renderRateChanges();
  hideRateForm();
  document.getElementById('rcRate').value = '';
}

function editRateChange(month) {
  const target = rateChanges.find(r => r.month === month);
  if (!target) return;
  const startDateStr = document.getElementById('startDate').value;
  const start = new Date(startDateStr + "-01");
  start.setMonth(start.getMonth() + target.month - 1);
  const y = start.getFullYear();
  const m = ("0" + (start.getMonth() + 1)).slice(-2);
  document.getElementById('rcMonthDate').value = `${y}-${m}`;
  document.getElementById('rcRate').value = target.rate;
  rateChanges = rateChanges.filter(r => r.month !== month);
  renderRateChanges();
  showRateForm();
}

function deleteRateChange(month) {
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  rateChanges = rateChanges.filter(r => r.month !== month);
  renderRateChanges();
}

function renderRateChanges() {
  const list = document.getElementById('rateChangeList');
  const startDateStr = document.getElementById('startDate').value;
  if (rateChanges.length === 0) { list.innerHTML = '<div class="empty-state" style="padding:10px; font-size:0.78rem;">é‡‘åˆ©å¤‰æ›´ãªã—</div>'; return; }
  
  list.innerHTML = rateChanges.map(rc => {
    const d = new Date(startDateStr + "-01");
    d.setMonth(d.getMonth() + rc.month - 1);
    const dateLabel = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
    return `<div class="rate-change-item">
      <div class="rate-item-main">
        <div class="rate-item-date">${dateLabel}ã€œ</div>
        <div class="rate-item-val">å¹´åˆ© <b>${rc.rate}%</b> ã«å¤‰æ›´</div>
      </div>
      <div class="rate-actions">
        <button class="btn-sm edit" onclick="editRateChange(${rc.month})">ä¿®æ­£</button>
        <button class="btn-sm danger" onclick="deleteRateChange(${rc.month})">å‰Šé™¤</button>
      </div>
    </div>`;
  }).join('');
}

/* --- Calculation Logic --- */
function getRateForMonth(month) {
  let rate = parseFloat(document.getElementById('rate').value);
  for (const rc of rateChanges) { if (month >= rc.month) rate = rc.rate; }
  return rate / 100 / 12;
}
function applyRounding(val) {
  const mode = document.getElementById('roundingMode').value;
  if (mode === 'floor') return Math.floor(val);
  if (mode === 'ceil') return Math.ceil(val);
  return Math.round(val);
}
function fmtShort(val) { return Math.round(val).toLocaleString('ja-JP'); }
function fmtMan(val) { return (val / 10000).toFixed(1) + 'ä¸‡å††'; }
function calculatePMT(principal, monthlyRate, numPayments) {
  if (monthlyRate === 0) return principal / numPayments;
  return principal * monthlyRate * Math.pow(1 + monthlyRate, numPayments) / (Math.pow(1 + monthlyRate, numPayments) - 1);
}

function runSimulation(P, initialYearlyRate, n, method, startDate, applyRules) {
  const resultData = [];
  let balance = P;
  const startMoment = new Date(startDate + '-01');
  let currentPayment = 0;
  const r0 = initialYearlyRate / 100 / 12;
  if (method === 'equal_payment') currentPayment = applyRounding(calculatePMT(P, r0, n));
  else currentPayment = (P / n) + (P * r0);
  let hasDeferredInterestWarning = false;

  for (let i = 1; i <= n; i++) {
    const r = getRateForMonth(i);
    let principalPart, interestPart, totalPayment;
    if (method === 'equal_principal') {
      principalPart = P / n; interestPart = balance * r;
      totalPayment = applyRounding(principalPart + interestPart);
      interestPart = totalPayment - Math.floor(principalPart); 
      principalPart = Math.floor(principalPart);
    } else {
      if (applyRules) {
        if (i > 1 && (i - 1) % 60 === 0) {
          const remainingMonths = n - i + 1;
          let theoreticalPayment = calculatePMT(balance, r, remainingMonths);
          const cap = Math.floor(currentPayment * 1.25);
          if (theoreticalPayment > cap) theoreticalPayment = cap;
          currentPayment = applyRounding(theoreticalPayment);
        }
        totalPayment = currentPayment;
      } else {
        const isRateChanged = rateChanges.some(rc => rc.month === i);
        if (i === 1 || isRateChanged) {
           const remainingMonths = n - i + 1;
           currentPayment = applyRounding(calculatePMT(balance, r, remainingMonths));
        }
        totalPayment = currentPayment;
      }
      interestPart = Math.floor(balance * r);
      principalPart = totalPayment - interestPart;
      if (principalPart < 0) { principalPart = 0; interestPart = totalPayment; hasDeferredInterestWarning = true; }
      if (i === n) { totalPayment = balance + interestPart; principalPart = balance; }
    }
    balance = balance - principalPart;
    if (balance < 0) balance = 0;
    const d = new Date(startMoment); d.setMonth(d.getMonth() + i - 1);
    resultData.push({
      month: i, label: `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`,
      payment: totalPayment, principal: principalPart, interest: interestPart, balance: balance,
      isRateChange: rateChanges.some(rc => rc.month === i),
      isPaymentChange: applyRules && i > 1 && (i - 1) % 60 === 0
    });
  }
  return { data: resultData, hasWarning: hasDeferredInterestWarning };
}

function calculate() {
  saveSettings();
  const P = parseFloat(document.getElementById('principal').value) * 10000;
  const initialYearlyRate = parseFloat(document.getElementById('rate').value);
  const n = parseInt(document.getElementById('years').value) * 12;
  const method = document.getElementById('method').value;
  const startDate = document.getElementById('startDate').value;
  const useJibunRules = document.getElementById('useJibunRules').checked && method === 'equal_payment';
  if (!P || !n || !startDate) return;

  const simResult = runSimulation(P, initialYearlyRate, n, method, startDate, useJibunRules);
  scheduleData = simResult.data;
  noRuleData = useJibunRules ? runSimulation(P, initialYearlyRate, n, method, startDate, false).data : scheduleData;

  updateStats(P, method, simResult.hasWarning);
  drawChart();
  document.getElementById('results').classList.add('visible');
  document.getElementById('deferredWarning').style.display = simResult.hasWarning ? 'block' : 'none';
  renderSchedule(startDate);
}

function updateStats(initialP, method, warning) {
  const totalInterest = scheduleData.reduce((s, d) => s + d.interest, 0);
  const totalPayment = scheduleData.reduce((s, d) => s + d.payment, 0);
  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let elapsedMonths = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()) + 1; 
  if (elapsedMonths < 1) elapsedMonths = 1;
  if (elapsedMonths > scheduleData.length) elapsedMonths = scheduleData.length;

  const initialRow = scheduleData[0];
  const currentRow = scheduleData[elapsedMonths - 1]; 
  const noRuleRow = noRuleData[elapsedMonths - 1];

  document.getElementById('statInitial').textContent = fmtShort(initialRow.payment);
  document.getElementById('statCurrent').textContent = fmtShort(currentRow.payment);
  document.getElementById('statTheoretical').textContent = fmtShort(noRuleRow.payment);
  
  const diff = noRuleRow.payment - currentRow.payment;
  const diffEl = document.getElementById('statTheoreticalDiff');
  if (diff > 0) diffEl.innerHTML = `ç¾åœ¨ã®æœˆè¿”æ¸ˆé¡ã‚ˆã‚Š<br><span style="color:var(--safe)">${diff.toLocaleString()}å††</span> ä½æ¸›`;
  else if (diff < 0) diffEl.innerHTML = `ç¾åœ¨ã®æœˆè¿”æ¸ˆé¡ã‚ˆã‚Š<br><span style="color:var(--danger)">${Math.abs(diff).toLocaleString()}å††</span> å¢—é¡`;
  else diffEl.textContent = 'ç¾åœ¨ã®æœˆè¿”æ¸ˆé¡ã¨åŒé¡ã§ã™';

  const useJibunRules = document.getElementById('useJibunRules').checked && method === 'equal_payment';
  const nextChangeEl = document.getElementById('statNextChange');
  const nextChangeDateEl = document.getElementById('statNextChangeDate');
  
  if (useJibunRules) {
    let nextChangePayment = null;
    let nextChangeLabel = '';
    for (let i = elapsedMonths; i < scheduleData.length; i++) {
      if (scheduleData[i].isPaymentChange) {
        nextChangePayment = scheduleData[i].payment;
        nextChangeLabel = scheduleData[i].label;
        break;
      }
    }
    if (nextChangePayment !== null) {
      nextChangeEl.textContent = fmtShort(nextChangePayment);
      nextChangeDateEl.innerHTML = `${nextChangeLabel}ã€œ<br>é©ç”¨äºˆå®š`;
    } else {
      nextChangeEl.textContent = 'â€”';
      nextChangeDateEl.innerHTML = `ä»Šå¾Œã®è¦‹ç›´ã—<br>äºˆå®šãªã—`;
    }
  } else {
    nextChangeEl.textContent = 'â€”';
    nextChangeDateEl.innerHTML = `5å¹´ãƒ«ãƒ¼ãƒ«<br>éé©ç”¨`;
  }

  document.getElementById('statTotalInterest').textContent = fmtShort(totalInterest);
  document.getElementById('statTotal').textContent = fmtShort(totalPayment);
  const curBal = currentRow.balance;
  const paid = initialP - curBal;
  const pct = Math.min(100, (paid / initialP) * 100);
  document.getElementById('progressPct').textContent = pct.toFixed(1) + '%';
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('paidAmount').textContent = 'å…ƒé‡‘è¿”æ¸ˆæ¸ˆ: ' + fmtMan(paid);
  document.getElementById('remainBalance').textContent = fmtMan(curBal);
  const remainMo = Math.max(0, scheduleData.length - elapsedMonths);
  document.getElementById('remainMonths').textContent = `${Math.floor(remainMo/12)}å¹´${remainMo%12}ãƒ¶æœˆ`;

  const cAdmin = parseInt(document.getElementById('costAdmin').value) || 0;
  const cRepair = parseInt(document.getElementById('costRepair').value) || 0;
  const cOther = parseInt(document.getElementById('costOther').value) || 0;
  const runCost = cAdmin + cRepair + cOther;
  const loanCost = currentRow.payment;
  const totalCost = loanCost + runCost;
  
  document.getElementById('totalMonthlyCost').textContent = fmtShort(totalCost) + 'å††';
  document.getElementById('detailLoan').textContent = fmtShort(loanCost);
  document.getElementById('detailRun').textContent = fmtShort(runCost);
}

function renderSchedule(startDateStr) {
  const tbody = document.getElementById('scheduleBody');
  tbody.innerHTML = '';
  const today = new Date();
  const startMoment = new Date(startDateStr + '-01');
  const currentMonthIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());
  scheduleData.forEach((row, idx) => {
    const tr = document.createElement('tr');
    if (idx === currentMonthIdx) tr.classList.add('highlight');
    if (row.isRateChange) tr.classList.add('rate-change');
    let labelExtra = idx === currentMonthIdx ? ' â—€' : '';
    if (row.isRateChange) labelExtra += ' <span class="badge-warn">é‡‘åˆ©å¤‰æ›´</span>';
    if (row.isPaymentChange) labelExtra += ' <span class="badge-rule">5å¹´ãƒ«ãƒ¼ãƒ«</span>';
    tr.innerHTML = `<td>${row.label}${labelExtra}</td><td>${fmtShort(row.payment)}</td><td>${fmtShort(row.principal)}</td><td>${fmtShort(row.interest)}</td><td>${fmtShort(row.balance)}</td>`;
    tbody.appendChild(tr);
  });
}

function drawChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  const yearlyData = [];
  let tempP = 0, tempI = 0, currentYear = '';
  scheduleData.forEach((row) => {
    const year = row.label.split('å¹´')[0];
    if (currentYear !== year && currentYear !== '') { yearlyData.push({ year: currentYear, principal: tempP, interest: tempI }); tempP = 0; tempI = 0; }
    currentYear = year; tempP += row.principal; tempI += row.interest;
  });
  yearlyData.push({ year: currentYear, principal: tempP, interest: tempI });
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: yearlyData.map(d => d.year),
      datasets: [ { label: 'å…ƒé‡‘', data: yearlyData.map(d => d.principal / 10000), backgroundColor: '#c8a96e', stack: 'S'}, { label: 'åˆ©æ¯', data: yearlyData.map(d => d.interest / 10000), backgroundColor: '#c4715a', stack: 'S'} ]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: function(value) { return value + 'ä¸‡å††'; } } } } }
  });
}

let balanceChartInstance = null;
let scenarioChartInstance = null;
let cumulativeChartInstance = null;
let scenarioVisible = [true, true, true];

/* â”€â”€ ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºãƒˆã‚°ãƒ« â”€â”€ */
function toggleScenario(idx, btn) {
  scenarioVisible[idx] = !scenarioVisible[idx];
  btn.classList.toggle('active', scenarioVisible[idx]);
  if (scheduleData.length > 0) drawScenarioChart();
}

/* â”€â”€ æ®‹é«˜æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ â”€â”€ */
function drawBalanceChart() {
  const ctx = document.getElementById('balanceChart').getContext('2d');
  if (balanceChartInstance) balanceChartInstance.destroy();

  const initialP = scheduleData[0].balance + scheduleData[0].principal;
  const startYear = parseInt(scheduleData[0].label.split('å¹´')[0]);
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  const today = new Date();
  const currentMonthIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());

  const labels = [startYear + 'å¹´'];
  const balData = [Math.round(initialP / 10000)];
  const paidData = [0];
  let lastYear = startYear;

  scheduleData.forEach((row, idx) => {
    const year = parseInt(row.label.split('å¹´')[0]);
    const isLast = idx === scheduleData.length - 1;
    if ((row.label.includes('12æœˆ') && year !== startYear) || isLast) {
      if (year !== lastYear || isLast) {
        labels.push(isLast && !row.label.includes('12æœˆ') ? year + 'å¹´(å®Œæ¸ˆ)' : year + 'å¹´');
        balData.push(Math.round(row.balance / 10000));
        paidData.push(Math.round((initialP - row.balance) / 10000));
        lastYear = year;
      }
    }
  });

  const currentYearStr = currentMonthIdx >= 0 && currentMonthIdx < scheduleData.length
    ? parseInt(scheduleData[currentMonthIdx].label.split('å¹´')[0]) + 'å¹´' : null;
  const nowIdx = labels.indexOf(currentYearStr);

  balanceChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'ãƒ­ãƒ¼ãƒ³æ®‹é«˜',
          data: balData,
          borderColor: '#5a8bc4',
          backgroundColor: 'rgba(90,139,196,0.12)',
          fill: true, tension: 0.3,
          pointRadius: balData.map((_, i) => i === nowIdx ? 7 : 2),
          pointBackgroundColor: balData.map((_, i) => i === nowIdx ? '#e8c98a' : '#5a8bc4'),
          order: 1
        },
        {
          label: 'è¿”æ¸ˆæ¸ˆã¿å…ƒé‡‘',
          data: paidData,
          borderColor: '#c8a96e',
          backgroundColor: 'rgba(200,169,110,0.08)',
          fill: true, tension: 0.3,
          pointRadius: 2, borderDash: [4, 3],
          order: 2
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toLocaleString('ja-JP') + 'ä¸‡å††' } },
        annotation: nowIdx >= 0 ? { annotations: { nowLine: {
          type: 'line', xMin: nowIdx, xMax: nowIdx,
          borderColor: 'rgba(232,201,138,0.6)', borderWidth: 1.5, borderDash: [4, 3],
          label: { content: 'ç¾åœ¨', display: true, position: 'start', color: '#e8c98a', font: { size: 10 }, backgroundColor: 'rgba(200,169,110,0.15)' }
        }}} : {}
      },
      scales: {
        x: { ticks: { color: '#7a7568', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#2e2c28' } },
        y: { ticks: { color: '#7a7568', font: { size: 10 }, callback: v => v + 'ä¸‡å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}

/* â”€â”€ é‡‘åˆ©ã‚·ãƒŠãƒªã‚ªï¼šæœˆè¿”æ¸ˆé¡ã®æ¨ç§»æ¯”è¼ƒ â”€â”€ */
function drawScenarioChart() {
  const ctx = document.getElementById('scenarioChart').getContext('2d');
  if (scenarioChartInstance) scenarioChartInstance.destroy();

  const startDate = document.getElementById('startDate').value;
  const startMoment = new Date(startDate + '-01');
  const today = new Date();
  const currentMonthIdx = Math.max(0, Math.min(
    (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()),
    scheduleData.length - 1
  ));

  const baseRate = getRateForMonth(currentMonthIdx + 1) * 12 * 100;
  const remainBal = scheduleData[currentMonthIdx].balance;
  const remainMonths = scheduleData.length - currentMonthIdx;

  // å¹´æ¬¡ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆï¼ˆä»Šæœˆä»¥é™ã®ã¿ï¼‰
  const labels = [];
  const basePayments = [], s1Payments = [], s2Payments = [];

  function buildPaymentSeries(extraRate) {
    const r = (baseRate + extraRate) / 100 / 12;
    const pmt = r > 0
      ? remainBal * r * Math.pow(1+r, remainMonths) / (Math.pow(1+r, remainMonths) - 1)
      : remainBal / remainMonths;
    // 5å¹´ãƒ«ãƒ¼ãƒ«ãªã—ãƒ»é‡‘åˆ©å›ºå®šã§å¹´æ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    const pts = {};
    let bal = remainBal;
    for (let i = 1; i <= remainMonths; i++) {
      const interest = Math.floor(bal * r);
      const principal = Math.min(Math.floor(pmt) - interest, bal);
      bal = Math.max(0, bal - principal);
      const d = new Date(startMoment); d.setMonth(d.getMonth() + currentMonthIdx + i);
      if (d.getMonth() === 11 || i === remainMonths) {
        pts[d.getFullYear()] = Math.round(pmt);
      }
    }
    return pts;
  }

  const s0 = buildPaymentSeries(0);
  const s1 = buildPaymentSeries(0.5);
  const s2 = buildPaymentSeries(1.0);

  const years = Object.keys(s0).map(Number).sort((a,b) => a-b);
  years.forEach(y => {
    labels.push(y + 'å¹´');
    basePayments.push(s0[y] ?? null);
    s1Payments.push(s1[y] ?? null);
    s2Payments.push(s2[y] ?? null);
  });

  const nowIdx = 0; // å¸¸ã«å…ˆé ­ãŒç¾åœ¨

  const datasets = [];
  if (scenarioVisible[0]) datasets.push({
    label: 'ç¾çŠ¶ç¶­æŒ', data: basePayments,
    borderColor: '#5a8bc4', backgroundColor: 'rgba(90,139,196,0.08)',
    fill: false, tension: 0.2, pointRadius: 3, order: 1
  });
  if (scenarioVisible[1]) datasets.push({
    label: '+0.5%ä¸Šæ˜‡', data: s1Payments,
    borderColor: '#c8a96e', backgroundColor: 'rgba(200,169,110,0.05)',
    fill: false, tension: 0.2, pointRadius: 3, borderDash: [5,3], order: 2
  });
  if (scenarioVisible[2]) datasets.push({
    label: '+1.0%ä¸Šæ˜‡', data: s2Payments,
    borderColor: '#c4715a', backgroundColor: 'rgba(196,113,90,0.05)',
    fill: false, tension: 0.2, pointRadius: 3, borderDash: [3,3], order: 3
  });

  scenarioChartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toLocaleString('ja-JP') + 'å††/æœˆ' } },
        annotation: { annotations: { nowLine: {
          type: 'line', xMin: 0, xMax: 0,
          borderColor: 'rgba(232,201,138,0.6)', borderWidth: 1.5, borderDash: [4,3],
          label: { content: 'ç¾åœ¨', display: true, position: 'start', color: '#e8c98a', font: { size: 10 }, backgroundColor: 'rgba(200,169,110,0.15)' }
        }}}
      },
      scales: {
        x: { ticks: { color: '#7a7568', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#2e2c28' } },
        y: { ticks: { color: '#7a7568', font: { size: 10 }, callback: v => v.toLocaleString() + 'å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}

/* â”€â”€ ç´¯è¨ˆã‚³ã‚¹ãƒˆã‚°ãƒ©ãƒ• â”€â”€ */
function drawCumulativeChart() {
  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  if (cumulativeChartInstance) cumulativeChartInstance.destroy();
  const cAdmin = parseInt(document.getElementById('costAdmin').value) || 0;
  const cRepair = parseInt(document.getElementById('costRepair').value) || 0;
  const cOther = parseInt(document.getElementById('costOther').value) || 0;
  const runMonthly = cAdmin + cRepair + cOther;
  const startDate = document.getElementById('startDate').value;
  const startMoment = new Date(startDate + '-01');
  const today = new Date();
  const currentMonthIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth());

  const labels = [], loanCum = [], totalCum = [];
  let loanSum = 0, totalSum = 0;
  const startYear = parseInt(scheduleData[0].label.split('å¹´')[0]);
  labels.push(startYear + 'å¹´'); loanCum.push(0); totalCum.push(0);
  let lastYear = startYear, tempLoan = 0, tempTotal = 0;
  scheduleData.forEach((row, idx) => {
    const year = parseInt(row.label.split('å¹´')[0]);
    const isLast = idx === scheduleData.length - 1;
    tempLoan += row.payment; tempTotal += row.payment + runMonthly;
    if ((row.label.includes('12æœˆ') && year !== startYear) || isLast) {
      if (year !== lastYear || isLast) {
        loanSum += tempLoan; totalSum += tempTotal;
        labels.push(isLast && !row.label.includes('12æœˆ') ? year + 'å¹´(å®Œæ¸ˆ)' : year + 'å¹´');
        loanCum.push(Math.round(loanSum / 10000));
        totalCum.push(Math.round(totalSum / 10000));
        tempLoan = 0; tempTotal = 0; lastYear = year;
      }
    }
  });

  const nowYearLabel = currentMonthIdx >= 0 && currentMonthIdx < scheduleData.length
    ? parseInt(scheduleData[currentMonthIdx].label.split('å¹´')[0]) + 'å¹´' : null;
  const nowIdx = labels.indexOf(nowYearLabel);

  cumulativeChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'ä½å±…è²»ç´¯è¨ˆ', data: totalCum, borderColor: '#5a8bc4', backgroundColor: 'rgba(90,139,196,0.1)', fill: true, tension: 0.3, pointRadius: 2 },
        { label: 'ãƒ­ãƒ¼ãƒ³ç´¯è¨ˆ', data: loanCum, borderColor: '#c4715a', backgroundColor: 'rgba(196,113,90,0.08)', fill: true, tension: 0.3, pointRadius: 2, borderDash: [4,3] }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toLocaleString() + 'ä¸‡å††' } },
        annotation: nowIdx >= 0 ? {
          annotations: { nowLine: { type: 'line', xMin: nowIdx, xMax: nowIdx, borderColor: 'rgba(232,201,138,0.6)', borderWidth: 1.5, borderDash: [4,3], label: { content: 'ç¾åœ¨', display: true, position: 'start', color: '#e8c98a', font: { size: 10 }, backgroundColor: 'rgba(200,169,110,0.15)' } } }
        } : {}
      },
      scales: {
        x: { ticks: { color: '#7a7568', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#2e2c28' } },
        y: { ticks: { color: '#7a7568', font: { size: 10 }, callback: v => v + 'ä¸‡å††' }, grid: { color: '#2e2c28' } }
      }
    }
  });
}

function switchTab(name) {
  ['graph','balance','scenario','cumulative','schedule'].forEach(t => document.getElementById('tab-'+t).style.display = t === name ? '' : 'none');
  document.querySelectorAll('.tab').forEach((el, i) => el.classList.toggle('active', ['graph','balance','scenario','cumulative','schedule'][i] === name));
  if (name === 'balance' && scheduleData.length > 0) drawBalanceChart();
  if (name === 'scenario' && scheduleData.length > 0) drawScenarioChart();
  if (name === 'cumulative' && scheduleData.length > 0) drawCumulativeChart();
}
function switchTool(name) {
  ['tax','refi','data'].forEach(t => document.getElementById('tool-'+t).classList.remove('active'));
  document.getElementById('tool-'+name).classList.add('active');
  document.querySelectorAll('.tools-tab').forEach((el, i) => el.classList.toggle('active', ['tax','refi','data'][i] === name));
}

/* â”€â”€ ç¹°ã‚Šä¸Šã’è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â”€â”€ */
let prepayType = 'shorten';
function setPrepayType(type) {
  prepayType = type;
  document.getElementById('prepayTypeShorten').classList.toggle('active', type === 'shorten');
  document.getElementById('prepayTypeReduce').classList.toggle('active', type === 'reduce');
}

function calcPrepayment() {
  const amountEl = document.getElementById('prepayAmount');
  const errEl = document.getElementById('prepayAmountErr');
  const amount = parseFloat(amountEl.value) * 10000;
  if (!amount || amount <= 0) {
    amountEl.classList.add('input-error'); errEl.classList.add('show'); return;
  }
  amountEl.classList.remove('input-error'); errEl.classList.remove('show');
  if (scheduleData.length === 0) return;

  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  const timing = parseInt(document.getElementById('prepayTiming').value) || 0;
  let applyIdx = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()) + timing;
  applyIdx = Math.max(0, Math.min(applyIdx, scheduleData.length - 1));

  const balBefore = applyIdx === 0 ? (parseFloat(document.getElementById('principal').value) * 10000) : scheduleData[applyIdx - 1].balance;
  const balAfter = Math.max(0, balBefore - amount);
  const remainMonths = scheduleData.length - applyIdx;
  const monthlyRate = parseFloat(document.getElementById('rate').value) / 100 / 12;

  // å…ƒã®æ®‹ã‚Šåˆ©æ¯
  let oldInterest = 0;
  for (let i = applyIdx; i < scheduleData.length; i++) oldInterest += scheduleData[i].interest;

  if (prepayType === 'shorten') {
    // æœŸé–“çŸ­ç¸®å‹: æœˆè¿”æ¸ˆé¡ãã®ã¾ã¾ã§æ®‹é«˜ã‚’æ¸›ã‚‰ã™
    const origPayment = scheduleData[applyIdx].payment;
    let bal = balAfter, newMonths = 0;
    let newInterest = 0;
    while (bal > 0 && newMonths < 9999) {
      const interest = Math.floor(bal * monthlyRate);
      const principal = Math.min(origPayment - interest, bal);
      if (principal <= 0) break;
      newInterest += interest; bal -= principal; newMonths++;
    }
    const shortened = remainMonths - newMonths;
    const savedInterest = oldInterest - newInterest;
    document.getElementById('prepayMainLabel').textContent = 'â± æœŸé–“çŸ­ç¸®';
    document.getElementById('prepayMainVal').textContent = shortened > 0
      ? `${Math.floor(shortened/12)}å¹´${shortened%12}ãƒ¶æœˆçŸ­ç¸®` : 'å¤‰åŒ–ãªã—';
    document.getElementById('prepayInterestSaved').textContent = fmtShort(savedInterest) + 'å††';
    document.getElementById('prepayOldInterest').textContent = fmtShort(oldInterest) + 'å††';
    document.getElementById('prepayNewInterest').textContent = fmtShort(newInterest) + 'å††';
  } else {
    // è¿”æ¸ˆé¡è»½æ¸›å‹: æœŸé–“ãã®ã¾ã¾ãƒ»æœˆè¿”æ¸ˆé¡ã‚’ä¸‹ã’ã‚‹
    const newPayment = monthlyRate > 0
      ? Math.floor(balAfter * monthlyRate * Math.pow(1+monthlyRate, remainMonths) / (Math.pow(1+monthlyRate, remainMonths) - 1))
      : Math.floor(balAfter / remainMonths);
    const newInterest = newPayment * remainMonths - balAfter;
    const savedInterest = oldInterest - newInterest;
    const origPayment = scheduleData[applyIdx].payment;
    document.getElementById('prepayMainLabel').textContent = 'ğŸ’´ æœˆè¿”æ¸ˆé¡è»½æ¸›';
    document.getElementById('prepayMainVal').textContent = `${fmtShort(origPayment - newPayment)}å††/æœˆ æ¸›å°‘`;
    document.getElementById('prepayInterestSaved').textContent = fmtShort(Math.max(0, savedInterest)) + 'å††';
    document.getElementById('prepayOldInterest').textContent = fmtShort(oldInterest) + 'å††';
    document.getElementById('prepayNewInterest').textContent = fmtShort(Math.max(0, newInterest)) + 'å††';
  }
  document.getElementById('prepayResult').style.display = 'block';
}

/* â”€â”€ å…±æœ‰ãƒªãƒ³ã‚¯ â”€â”€ */
function copyShareLink() {
  const d = {
    principal: document.getElementById('principal').value,
    rate: document.getElementById('rate').value,
    years: document.getElementById('years').value,
    method: document.getElementById('method').value,
    startDate: document.getElementById('startDate').value,
    useJibunRules: document.getElementById('useJibunRules').checked ? '1' : '0',
    roundingMode: document.getElementById('roundingMode').value,
    costAdmin: document.getElementById('costAdmin').value,
    costRepair: document.getElementById('costRepair').value,
    costOther: document.getElementById('costOther').value
  };
  const params = new URLSearchParams(d).toString();
  const url = location.href.split('?')[0] + '?' + params;
  navigator.clipboard.writeText(url).then(() => {
    const n = document.getElementById('shareNotice');
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 2500);
  }).catch(() => {
    prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url);
  });
}

function loadFromURL() {
  const params = new URLSearchParams(location.search);
  if (!params.has('principal')) return;
  const ids = ['principal','rate','years','method','startDate','roundingMode','costAdmin','costRepair','costOther'];
  ids.forEach(id => { if (params.has(id)) document.getElementById(id).value = params.get(id); });
  if (params.has('useJibunRules')) document.getElementById('useJibunRules').checked = params.get('useJibunRules') === '1';
  toggleRulesVisibility();
}

/* --- ä¾¿åˆ©ãƒ„ãƒ¼ãƒ« --- */
function calcTaxDeduction() {
  if (scheduleData.length === 0) { alert('å…ˆã«ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const period = parseInt(document.getElementById('taxPeriod').value);
  const rate = parseFloat(document.getElementById('taxRate').value) / 100;
  const limit = parseInt(document.getElementById('taxLimit').value) * 10000;
  let totalDeduction = 0;
  for (let i = 1; i <= period; i++) {
     const targetRow = scheduleData.find(row => row.label.includes((parseInt(scheduleData[0].label) + i - 1) + 'å¹´12æœˆ'));
     if (targetRow) {
       const balance = targetRow.balance;
       const deduct = Math.min(balance, limit) * rate;
       totalDeduction += Math.floor(deduct);
     }
  }
  document.getElementById('taxTotalVal').textContent = Math.round(totalDeduction).toLocaleString() + 'å††';
  document.getElementById('taxResult').style.display = 'block';
}

function calcRefinance() {
  if (scheduleData.length === 0) { alert('å…ˆã«ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const today = new Date();
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  let elapsedMonths = (today.getFullYear() - startMoment.getFullYear()) * 12 + (today.getMonth() - startMoment.getMonth()) + 1;
  if (elapsedMonths < 1) elapsedMonths = 1;
  if (elapsedMonths > scheduleData.length) elapsedMonths = scheduleData.length;
  const currentRow = scheduleData[elapsedMonths - 1];
  const currentBalance = currentRow.balance;
  const remainMonths = scheduleData.length - elapsedMonths + 1;
  let oldTotalRemaining = 0;
  let oldTotalInterest = 0;
  for (let i = elapsedMonths; i < scheduleData.length; i++) {
    oldTotalRemaining += scheduleData[i].payment;
    oldTotalInterest += scheduleData[i].interest;
  }
  const newRate = parseFloat(document.getElementById('refiRate').value) / 100 / 12;
  const feeRate = parseFloat(document.getElementById('refiFeeRate').value) / 100;
  const fixCost = parseFloat(document.getElementById('refiFixCost').value) * 10000;
  const adminFee = Math.floor(currentBalance * feeRate);
  const initialCost = adminFee + fixCost;
  const newPayment = Math.round(currentBalance * newRate * Math.pow(1 + newRate, remainMonths) / (Math.pow(1 + newRate, remainMonths) - 1));
  const newLoanTotal = newPayment * remainMonths;
  const newTotalPayment = newLoanTotal + initialCost;
  const diff = oldTotalRemaining - newTotalPayment;
  document.getElementById('refiOldTotal').textContent = fmtShort(oldTotalRemaining) + 'å††';
  document.getElementById('refiOldPrincipal').textContent = fmtShort(currentBalance) + 'å††';
  document.getElementById('refiOldInterest').textContent = fmtShort(oldTotalInterest) + 'å††';
  document.getElementById('refiNewTotal').textContent = fmtShort(newTotalPayment) + 'å††';
  document.getElementById('refiNewLoan').textContent = fmtShort(newLoanTotal) + 'å††';
  document.getElementById('refiCost').textContent = fmtShort(initialCost) + 'å††';
  const diffEl = document.getElementById('refiDiffVal');
  if (diff > 0) {
    diffEl.textContent = '+' + fmtShort(diff) + 'å†† (ãŠå¾—)';
    diffEl.className = 'tool-summary-val refi-diff plus';
  } else {
    diffEl.textContent = fmtShort(diff) + 'å†† (æ)';
    diffEl.className = 'tool-summary-val refi-diff minus';
  }
  document.getElementById('refiResult').style.display = 'block';
}

function exportData() {
  const settings = saveSettings();
  const data = { settings };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mortgage_data_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
}

function exportCSV() {
  if (!scheduleData || scheduleData.length === 0) { alert('å…ˆã«è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
  let csvContent = "å®Ÿè¡Œå¹´æœˆ,ãŠæ”¯æ‰•é¡,å…ƒé‡‘åˆ†,åˆ©æ¯åˆ†,å€Ÿå…¥æ®‹é«˜\n";
  scheduleData.forEach(row => {
    csvContent += `${row.label},${row.payment},${row.principal},${row.interest},${row.balance}\n`;
  });
  const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", "mortgage_schedule.csv");
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.settings) localStorage.setItem('mortgage_settings_v13', JSON.stringify(data.settings));
      alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚ç”»é¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚');
      location.reload();
    } catch(err) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
  };
  reader.readAsText(file);
}

/* --- å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ --- */
function calcSale() {
  if (scheduleData.length === 0) { alert('å…ˆã«ä¸Šéƒ¨ã®ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  saveSettings();
  const saleDateStr = document.getElementById('saleDate').value;
  const sPrice = (parseFloat(document.getElementById('salePrice').value) || 0) * 10000;
  const pPrice = (parseFloat(document.getElementById('purchasePrice').value) || 0) * 10000;
  const pCost = (parseFloat(document.getElementById('purchaseCost').value) || 0) * 10000;
  const use30m = document.getElementById('use30mDeduction').checked;
  const use10y = document.getElementById('use10yRate').checked;
  const startMoment = new Date(document.getElementById('startDate').value + '-01');
  const saleMoment = new Date(saleDateStr + '-01');
  let elapsedMonths = (saleMoment.getFullYear() - startMoment.getFullYear()) * 12 + (saleMoment.getMonth() - startMoment.getMonth());
  let remainBalance = 0;
  if (elapsedMonths < 0) { alert('å£²å´æ™‚æœŸã¯å€Ÿå…¥é–‹å§‹(è³¼å…¥æœˆ)ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„'); return; }
  else if (elapsedMonths >= scheduleData.length) { remainBalance = 0; }
  else { remainBalance = elapsedMonths === 0 ? parseFloat(document.getElementById('principal').value) * 10000 : scheduleData[elapsedMonths - 1].balance; }
  let brokerFee = 0;
  if (sPrice > 4000000) brokerFee = (sPrice * 0.03 + 60000) * 1.1;
  else if (sPrice > 2000000) brokerFee = (sPrice * 0.04 + 20000) * 1.1;
  else brokerFee = (sPrice * 0.05) * 1.1;
  const sCost = Math.floor(brokerFee + 10000);
  let capitalGain = sPrice - (pPrice + pCost) - sCost;
  let tax = 0; let taxLabel = "éèª²ç¨"; let appliedRateText = ""; let taxBadgeClass = "tax-long";
  const holdingYears = saleMoment.getFullYear() - startMoment.getFullYear();
  let taxableGain = capitalGain;
  if (capitalGain > 0) {
    if (use30m) { taxableGain = Math.max(0, taxableGain - 30000000); }
    if (taxableGain > 0) {
      if (holdingYears > 10 && use10y) {
        if (taxableGain <= 60000000) { appliedRateText = "14.21%"; tax = taxableGain * 0.1421; taxLabel = "è»½æ¸›ç¨ç‡é©ç”¨"; taxBadgeClass = "tax-reduced"; }
        else { tax = (60000000 * 0.1421) + ((taxableGain - 60000000) * 0.20315); appliedRateText = "ä¸€éƒ¨è¶…é"; taxLabel = "è»½æ¸›ç¨ç‡(ä¸€éƒ¨é•·æœŸ)"; taxBadgeClass = "tax-reduced"; }
      } else if (holdingYears > 5) { appliedRateText = "20.315%"; tax = taxableGain * 0.20315; taxLabel = "é•·æœŸè­²æ¸¡æ‰€å¾—"; taxBadgeClass = "tax-long"; }
      else { appliedRateText = "39.63%"; tax = taxableGain * 0.3963; taxLabel = "çŸ­æœŸè­²æ¸¡æ‰€å¾—"; taxBadgeClass = "tax-short"; }
    } else { taxLabel = "ç¨é¡0å†† (3,000ä¸‡æ§é™¤æ å†…)"; appliedRateText = "0%"; taxBadgeClass = "tax-long"; }
  } else { taxLabel = "ç¨é¡0å†† (è­²æ¸¡ç›Šãªã—)"; appliedRateText = "0%"; taxBadgeClass = "tax-long"; }
  tax = Math.floor(tax);
  const netProceeds = sPrice - remainBalance - sCost - tax;
  const badge = document.getElementById('taxBadge');
  badge.textContent = taxLabel; badge.className = `tax-badge ${taxBadgeClass}`; badge.style.display = 'inline-block';
  document.getElementById('saleResNet').textContent = fmtShort(netProceeds) + 'å††';

  // æç›Šåˆ†å²ç‚¹ï¼šæ‰‹å–ã‚ŠãŒãƒ—ãƒ©ã‚¹ã«ãªã‚‹æœ€çŸ­æœˆã‚’æ¤œç´¢
  const beBox = document.getElementById('breakevenBox');
  const beVal = document.getElementById('breakevenVal');
  let breakevenLabel = null;
  for (let m = 0; m < scheduleData.length; m++) {
    const bal = m === 0 ? parseFloat(document.getElementById('principal').value)*10000 : scheduleData[m-1].balance;
    const netChk = sPrice - bal - sCost - tax;
    if (netChk >= 0) { breakevenLabel = scheduleData[m].label; break; }
  }
  if (breakevenLabel) {
    beVal.textContent = breakevenLabel + 'ä»¥é™ï¼ˆå£²å´ä¾¡æ ¼ãƒ»ç¨ç‡ã¯ç¾åœ¨ã®å…¥åŠ›å€¤ã§è©¦ç®—ï¼‰';
    beBox.style.display = 'block';
  } else {
    beBox.style.display = 'none';
  }
  const breakdownHtml = `
    <div class="step-box">
      <div class="step-title"><span class="step-num">1</span>è­²æ¸¡ç›Šï¼ˆå„²ã‘ï¼‰ã®è¨ˆç®—</div>
      <div class="step-row"><span>å£²å´äºˆå®šé¡</span><span>${fmtShort(sPrice)}å††</span></div>
      <div class="step-row sub"><span>- è³¼å…¥ä¾¡æ ¼</span><span>${fmtShort(pPrice)}å††</span></div>
      <div class="step-row sub"><span>- è³¼å…¥æ™‚è«¸è²»ç”¨</span><span>${fmtShort(pCost)}å††</span></div>
      <div class="step-row sub"><span>- å£²å´è«¸è²»ç”¨(æ¦‚ç®—)</span><span>${fmtShort(sCost)}å††</span></div>
      <div class="step-row result"><span>= è­²æ¸¡ç›Š</span><span>${fmtShort(capitalGain)}å††</span></div>
      ${capitalGain > 0 && use30m ? `<div class="step-row sub" style="margin-top:8px; color:var(--safe)"><span>- ç‰¹åˆ¥æ§é™¤ (ãƒã‚¤ãƒ›ãƒ¼ãƒ ç‰¹ä¾‹)</span><span>é©ç”¨ã‚ã‚Š</span></div><div class="step-row result" style="color:var(--safe)"><span>= èª²ç¨è­²æ¸¡æ‰€å¾—</span><span>${fmtShort(taxableGain)}å††</span></div>` : ''}
    </div>
    <div class="step-box">
      <div class="step-title"><span class="step-num">2</span>é©ç”¨ç¨ç‡ã®åˆ¤å®š</div>
      <div class="step-row"><span>æ‰€æœ‰æœŸé–“ (è­²æ¸¡å¹´ã®1æœˆ1æ—¥æ™‚ç‚¹)</span><span>${holdingYears}å¹´</span></div>
      <div class="step-row result"><span>= åˆ¤å®šçµæœ</span><span style="color:var(--safe)">${taxLabel}</span></div>
    </div>
    <div class="step-box">
      <div class="step-title"><span class="step-num">3</span>è­²æ¸¡ç¨ã®è¨ˆç®—</div>
      <div class="step-row"><span>èª²ç¨è­²æ¸¡æ‰€å¾—</span><span>${fmtShort(taxableGain)}å††</span></div>
      <div class="step-row sub"><span>Ã— ç¨ç‡</span><span>${appliedRateText}</span></div>
      <div class="step-row result"><span>= è­²æ¸¡ç¨</span><span style="color:var(--danger)">${fmtShort(tax)}å††</span></div>
    </div>
    <div class="step-box" style="border-color:var(--safe); background:rgba(106,170,142,0.05);">
      <div class="step-title"><span class="step-num" style="background:var(--safe)">4</span>æœ€çµ‚æ‰‹å–ã‚Šé¡ã®è¨ˆç®—</div>
      <div class="step-row"><span>å£²å´äºˆå®šé¡</span><span>${fmtShort(sPrice)}å††</span></div>
      <div class="step-row sub"><span>- ãƒ­ãƒ¼ãƒ³æ®‹å‚µ (ä¸€æ‹¬è¿”æ¸ˆ)</span><span>${fmtShort(remainBalance)}å††</span></div>
      <div class="step-row sub"><span>- å£²å´è«¸è²»ç”¨(æ¦‚ç®—)</span><span>${fmtShort(sCost)}å††</span></div>
      <div class="step-row sub"><span>- è­²æ¸¡ç¨</span><span>${fmtShort(tax)}å††</span></div>
      <div class="step-row result" style="font-size:0.95rem;"><span>= æœ€çµ‚æ‰‹å–ã‚Šé¡</span><span>${fmtShort(netProceeds)}å††</span></div>
    </div>
    <div style="font-size:0.65rem; color:var(--muted); text-align:right;">â€»å»ºç‰©ã®æ¸›ä¾¡å„Ÿå´è²»ã¯è€ƒæ…®ã›ãšã€è³¼å…¥ä¾¡æ ¼ã‚’å–å¾—è²»ã¨ã—ãŸç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚</div>
  `;
  document.getElementById('calcBreakdown').innerHTML = breakdownHtml;
  document.getElementById('saleResult').style.display = 'block';
}

loadFromURL();
loadSettings();
calculate();

/* â”€â”€ PWA â”€â”€ */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwaInstallBanner').style.display = 'block';
});
document.getElementById('pwaInstallBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('pwaInstallBanner').style.display = 'none';
});

if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'mortgage-v1';
    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(['./', './index.html']))));
    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
  `;
  const blob = new Blob([swCode], { type: 'application/javascript' });
  navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
}
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(() => console.log("SW registered"));
}
</script>
</body>
</html>
